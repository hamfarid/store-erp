#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ—„ï¸ ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø·Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
Update Database Schema Script

ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:
- Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
"""

import sqlite3
import os
from pathlib import Path

def print_step(message):
    print(f"ğŸ“‹ {message}")

def print_success(message):
    print(f"âœ… {message}")

def print_warning(message):
    print(f"âš ï¸  {message}")

def print_error(message):
    print(f"âŒ {message}")

def update_users_table(cursor):
    """ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
    print_step("ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...")
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    cursor.execute("PRAGMA table_info(users)")
    columns = [column[1] for column in cursor.fetchall()]
    
    # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
    new_columns = {
        'role': "ALTER TABLE users ADD COLUMN role TEXT DEFAULT 'user'",
        'permissions': "ALTER TABLE users ADD COLUMN permissions TEXT",
        'last_login': "ALTER TABLE users ADD COLUMN last_login DATETIME",
        'full_name': "ALTER TABLE users ADD COLUMN full_name TEXT",
        'is_active': "ALTER TABLE users ADD COLUMN is_active BOOLEAN DEFAULT 1"
    }
    
    for column_name, sql in new_columns.items():
        if column_name not in columns:
            try:
                cursor.execute(sql)
                print_success(f"ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙˆØ¯: {column_name}")
            except Exception as e:
                print_warning(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙˆØ¯ {column_name}: {e}")
    
    print_success("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†")

def create_categories_table(cursor):
    """Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¦Ø§Øª"""
    print_step("Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¦Ø§Øª...")
    
    create_table_sql = '''
    CREATE TABLE IF NOT EXISTS categories (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL UNIQUE,
        description TEXT,
        parent_id INTEGER,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (parent_id) REFERENCES categories (id)
    )
    '''
    
    try:
        cursor.execute(create_table_sql)
        print_success("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¦Ø§Øª")
    except Exception as e:
        print_warning(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¦Ø§Øª: {e}")

def create_warehouses_table(cursor):
    """Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª"""
    print_step("Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª...")
    
    create_table_sql = '''
    CREATE TABLE IF NOT EXISTS warehouses (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL UNIQUE,
        location TEXT,
        description TEXT,
        is_active BOOLEAN DEFAULT 1,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
    '''
    
    try:
        cursor.execute(create_table_sql)
        print_success("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª")
    except Exception as e:
        print_warning(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª: {e}")

def update_products_table(cursor):
    """ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ø¥Ø¶Ø§ÙØ© category_id"""
    print_step("ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...")
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù…ÙˆØ¯ category_id
    cursor.execute("PRAGMA table_info(products)")
    columns = [column[1] for column in cursor.fetchall()]
    
    if 'category_id' not in columns:
        try:
            cursor.execute("ALTER TABLE products ADD COLUMN category_id INTEGER")
            cursor.execute("CREATE INDEX IF NOT EXISTS idx_products_category ON products(category_id)")
            print_success("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ category_id Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª")
        except Exception as e:
            print_warning(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: {e}")

def create_inventory_table(cursor):
    """Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹"""
    print_step("Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†...")
    
    create_table_sql = '''
    CREATE TABLE IF NOT EXISTS inventory (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        product_id INTEGER NOT NULL,
        warehouse_id INTEGER NOT NULL,
        quantity INTEGER DEFAULT 0,
        reserved_quantity INTEGER DEFAULT 0,
        min_stock_level INTEGER DEFAULT 0,
        max_stock_level INTEGER DEFAULT 0,
        last_updated DATETIME DEFAULT CURRENT_TIMESTAMP,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (product_id) REFERENCES products (id),
        FOREIGN KEY (warehouse_id) REFERENCES warehouses (id),
        UNIQUE(product_id, warehouse_id)
    )
    '''
    
    try:
        cursor.execute(create_table_sql)
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_inventory_product ON inventory(product_id)")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_inventory_warehouse ON inventory(warehouse_id)")
        print_success("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†")
    except Exception as e:
        print_warning(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: {e}")

def insert_default_data(cursor):
    """Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©"""
    print_step("Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©...")
    
    # Ø¥Ø¯Ø±Ø§Ø¬ ÙØ¦Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    default_categories = [
        ('Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª', 'Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© ÙˆÙ…Ø¹Ø¯Ø§Øª ØªÙ‚Ù†ÙŠØ©'),
        ('Ù…Ù„Ø§Ø¨Ø³', 'Ù…Ù„Ø§Ø¨Ø³ ÙˆØ£Ø²ÙŠØ§Ø¡'),
        ('Ø·Ø¹Ø§Ù… ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª', 'Ù…Ù†ØªØ¬Ø§Øª ØºØ°Ø§Ø¦ÙŠØ© ÙˆÙ…Ø´Ø±ÙˆØ¨Ø§Øª'),
        ('ÙƒØªØ¨ ÙˆÙ‚Ø±Ø·Ø§Ø³ÙŠØ©', 'ÙƒØªØ¨ ÙˆÙ…ÙˆØ§Ø¯ Ù‚Ø±Ø·Ø§Ø³ÙŠØ©'),
        ('Ù…Ù†Ø²Ù„ ÙˆØ­Ø¯ÙŠÙ‚Ø©', 'Ø£Ø¯ÙˆØ§Øª Ù…Ù†Ø²Ù„ÙŠØ© ÙˆÙ…Ø¹Ø¯Ø§Øª Ø­Ø¯ÙŠÙ‚Ø©')
    ]
    
    for name, description in default_categories:
        try:
            cursor.execute(
                "INSERT OR IGNORE INTO categories (name, description) VALUES (?, ?)",
                (name, description)
            )
        except Exception as e:
            print_warning(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„ÙØ¦Ø© {name}: {e}")
    
    # Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ø³ØªÙˆØ¯Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠ
    try:
        cursor.execute(
            "INSERT OR IGNORE INTO warehouses (name, location, description) VALUES (?, ?, ?)",
            ('Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ', 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ', 'Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù…')
        )
    except Exception as e:
        print_warning(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: {e}")
    
    print_success("ØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©")

def create_admin_user(cursor):
    """Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¯Ø§Ø±ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠ"""
    print_step("Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¯Ø§Ø±ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠ...")
    
    from werkzeug.security import generate_password_hash
    import json
    from datetime import datetime
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¯Ø§Ø±ÙŠ
    cursor.execute("SELECT COUNT(*) FROM users WHERE role = 'admin'")
    admin_count = cursor.fetchone()[0]
    
    if admin_count == 0:
        password_hash = generate_password_hash('admin123')
        permissions = json.dumps([
            'read_all', 'write_all', 'delete_all', 'admin_panel',
            'user_management', 'system_settings', 'reports_access'
        ])
        
        try:
            cursor.execute('''
                INSERT INTO users (username, email, full_name, password_hash, role, is_active, permissions, created_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''', (
                'admin',
                'admin@store.com',
                'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…',
                password_hash,
                'admin',
                1,
                permissions,
                datetime.utcnow().isoformat()
            ))
            print_success("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ")
            print("   Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: admin")
            print("   ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: admin123")
        except Exception as e:
            print_warning(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ: {e}")
    else:
        print_success("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„")

def main():
    print("ğŸ—„ï¸ Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø·Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...")
    print("=" * 50)
    
    # Ù…Ø³Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    db_path = Path("backend/instance/inventory.db")
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ instance Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
    db_path.parent.mkdir(exist_ok=True)
    
    try:
        # Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        conn = sqlite3.connect(str(db_path))
        cursor = conn.cursor()
        
        # ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        update_users_table(cursor)
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        create_categories_table(cursor)
        create_warehouses_table(cursor)
        create_inventory_table(cursor)
        
        # ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        update_products_table(cursor)
        
        # Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        insert_default_data(cursor)
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¯Ø§Ø±ÙŠ
        create_admin_user(cursor)
        
        # Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        conn.commit()
        
        print("=" * 50)
        print_success("ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø·Ø· Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!")
        print("ğŸ“‹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø·Ø¨Ù‚Ø©:")
        print("   - ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†")
        print("   - Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¦Ø§Øª")
        print("   - Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª")
        print("   - Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†")
        print("   - ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª")
        print("   - Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©")
        print("   - Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¯Ø§Ø±ÙŠ")
        
    except Exception as e:
        print_error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
        return False
    
    finally:
        if 'conn' in locals():
            conn.close()
    
    return True

if __name__ == "__main__":
    main()
