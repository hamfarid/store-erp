<!-- ملف: /home/ubuntu/complete_inventory_system/backend/src/static/sales.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>المبيعات - نظام إدارة المخزون</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="shared.css">
  <link rel="stylesheet" href="css/sales.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fas fa-shopping-cart"></i> إدارة المبيعات</h1>
      <p>إدارة شاملة للمبيعات والعملاء والفواتير</p>
    </div>

    <div class="nav-bar">
      <a href="/dashboard.html"><i class="fas fa-home"></i> العودة للرئيسية</a>
      <div class="nav-user-info">
        <span class="nav-user-badge">مرحباً، مدير النظام</span>
        <a class="nav-logout" href="/"><i class="fas fa-sign-out-alt"></i> خروج</a>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <i class="fas fa-file-invoice-dollar"></i>
        <h3 id="total-invoices">0</h3>
        <p>إجمالي الفواتير</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-money-bill-wave"></i>
        <h3 id="total-sales">0.00</h3>
        <p>إجمالي المبيعات</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-users"></i>
        <h3 id="total-customers">0</h3>
        <p>عدد العملاء</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-calendar-day"></i>
        <h3 id="today-sales">0.00</h3>
        <p>مبيعات اليوم</p>
      </div>
    </div>

    <div class="tabs">
      <div class="tab-buttons">
        <button type="button" class="tab-button active" onclick="showTab(event, 'invoices')"><i class="fas fa-file-invoice"></i> فواتير المبيعات</button>
        <button type="button" class="tab-button" onclick="showTab(event, 'customers')"><i class="fas fa-users"></i> العملاء</button>
        <button type="button" class="tab-button" onclick="showTab(event, 'quotations')"><i class="fas fa-file-alt"></i> عروض الأسعار</button>
        <button type="button" class="tab-button" onclick="showTab(event, 'reports')"><i class="fas fa-chart-line"></i> تقارير المبيعات</button>
      </div>

      <div id="invoices-tab" class="tab-content active">
        <div class="action-bar">
          <div class="search-box">
            <input type="text" id="invoices-search" placeholder="ابحث في الفواتير..." aria-label="حقل نص">
            <i class="fas fa-search"></i>
          </div>
          <div>
            <button type="button" class="btn btn-success" onclick="createNewInvoice()"><i class="fas fa-plus"></i> فاتورة جديدة</button>
            <button type="button" class="btn btn-primary" onclick="loadInvoices()"><i class="fas fa-sync"></i> تحديث</button>
          </div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>رقم الفاتورة</th>
                <th>التاريخ</th>
                <th>العميل</th>
                <th>المبلغ الإجمالي</th>
                <th>الحالة</th>
                <th>طريقة الدفع</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="invoices-table">
              <tr>
                <td colspan="7" class="loading"><i class="fas fa-spinner fa-spin"></i> جاري تحميل البيانات...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="customers-tab" class="tab-content">
        <div class="action-bar">
          <div class="search-box">
            <input type="text" id="customers-search" placeholder="ابحث في العملاء..." aria-label="حقل نص">
            <i class="fas fa-search"></i>
          </div>
          <div>
            <button type="button" class="btn btn-success" onclick="addNewCustomer()"><i class="fas fa-plus"></i> عميل جديد</button>
            <button type="button" class="btn btn-primary" onclick="loadCustomers()"><i class="fas fa-sync"></i> تحديث</button>
          </div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>الكود</th>
                <th>اسم العميل</th>
                <th>الهاتف</th>
                <th>البريد الإلكتروني</th>
                <th>إجمالي المشتريات</th>
                <th>آخر عملية شراء</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="customers-table">
              <tr>
                <td colspan="7" class="loading"><i class="fas fa-spinner fa-spin"></i> جاري تحميل البيانات...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="quotations-tab" class="tab-content">
        <div class="action-bar">
          <div class="search-box">
            <input type="text" id="quotations-search" placeholder="ابحث في عروض الأسعار..." aria-label="حقل نص">
            <i class="fas fa-search"></i>
          </div>
          <div>
            <button type="button" class="btn btn-success" onclick="createNewQuotation()"><i class="fas fa-plus"></i> عرض سعر جديد</button>
            <button type="button" class="btn btn-primary" onclick="loadQuotations()"><i class="fas fa-sync"></i> تحديث</button>
          </div>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>رقم العرض</th>
                <th>التاريخ</th>
                <th>العميل</th>
                <th>المبلغ الإجمالي</th>
                <th>تاريخ الانتهاء</th>
                <th>الحالة</th>
                <th>الإجراءات</th>
              </tr>
            </thead>
            <tbody id="quotations-table">
              <tr>
                <td colspan="7" class="loading"><i class="fas fa-spinner fa-spin"></i> جاري تحميل البيانات...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="reports-tab" class="tab-content">
        <div class="action-bar">
          <h3 class="reports-heading">تقارير المبيعات</h3>
          <div>
            <button type="button" class="btn btn-primary" onclick="generateSalesReport()"><i class="fas fa-file-pdf"></i> تقرير المبيعات</button>
            <button type="button" class="btn btn-success" onclick="generateCustomersReport()"><i class="fas fa-users"></i> تقرير العملاء</button>
          </div>
        </div>

        <div class="reports-grid">
          <div class="stat-card">
            <i class="fas fa-chart-bar"></i>
            <h3>تقرير المبيعات الشهرية</h3>
            <p>عرض تفصيلي للمبيعات خلال الشهر الحالي</p>
            <button class="btn btn-primary report-action"><i class="fas fa-eye"></i> عرض التقرير</button>
          </div>
          <div class="stat-card">
            <i class="fas fa-chart-pie"></i>
            <h3>تحليل العملاء</h3>
            <p>تحليل سلوك العملاء وأنماط الشراء</p>
            <button class="btn btn-primary report-action"><i class="fas fa-eye"></i> عرض التحليل</button>
          </div>
          <div class="stat-card">
            <i class="fas fa-chart-line"></i>
            <h3>اتجاهات المبيعات</h3>
            <p>تحليل اتجاهات المبيعات والنمو</p>
            <button class="btn btn-primary report-action"><i class="fas fa-eye"></i> عرض الاتجاهات</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentTab = 'invoices';

    document.addEventListener('DOMContentLoaded', () => {
      loadSalesStats();
      loadInvoices();
      loadCustomers();
      loadQuotations();
    });

    function showTab(evt, tabName) {
      document.querySelectorAll('.tab-content').forEach((tab) => {
        tab.classList.remove('active');
      });

      document.querySelectorAll('.tab-button').forEach((button) => {
        button.classList.remove('active');
      });

      document.getElementById(`${tabName}-tab`).classList.add('active');

      if (evt?.currentTarget) {
        evt.currentTarget.classList.add('active');
      }

      currentTab = tabName;
    }

    async function loadSalesStats() {
      try {
        const response = await fetch('/api/sales/stats');

        if (response.ok) {
          const result = await response.json();

          if (result.success) {
            const data = result.data;
            document.getElementById('total-invoices').textContent = data.total_invoices || 0;
            document.getElementById('total-sales').textContent = (data.total_sales || 0).toFixed(2);
            document.getElementById('total-customers').textContent = data.total_customers || 0;
            document.getElementById('today-sales').textContent = (data.today_sales || 0).toFixed(2);
          }
        }
      } catch (error) {
        console.error('خطأ في تحميل إحصائيات المبيعات:', error);
        document.getElementById('total-invoices').textContent = '0';
        document.getElementById('total-sales').textContent = '0.00';
        document.getElementById('total-customers').textContent = '0';
        document.getElementById('today-sales').textContent = '0.00';
      }
    }

    async function loadInvoices() {
      try {
        const response = await fetch('/api/sales/invoices');

        if (response.ok) {
          const result = await response.json();

          if (result.success) {
            displayInvoices(result.data);
          } else {
            showError('فشل في تحميل الفواتير: ' + result.message);
          }
        } else {
          showError('خطأ في الاتصال بالخادم');
        }
      } catch (error) {
        console.error('خطأ في تحميل الفواتير:', error);
        displayEmptyInvoices();
      }
    }

    function displayInvoices(invoices) {
      const tbody = document.getElementById('invoices-table');

      if (invoices.length === 0) {
        displayEmptyInvoices();
        return;
      }

      tbody.innerHTML = invoices
        .map((invoice) => `
          <tr>
            <td>${invoice.number || invoice.id}</td>
            <td>${new Date(invoice.date).toLocaleDateString('ar-SA')}</td>
            <td>${invoice.customer_name || 'عميل نقدي'}</td>
            <td>${(invoice.total || 0).toFixed(2)}</td>
            <td><span class="status-badge status-${invoice.status || 'draft'}">${getStatusText(invoice.status)}</span></td>
            <td>${invoice.payment_method || 'نقدي'}</td>
            <td>
              <button type="button" class="btn btn-primary" onclick="viewInvoice(${invoice.id})"><i class="fas fa-eye"></i></button>
              <button type="button" class="btn btn-warning" onclick="editInvoice(${invoice.id})"><i class="fas fa-edit"></i></button>
              <button type="button" class="btn btn-danger" onclick="deleteInvoice(${invoice.id})"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `)
        .join('');
    }

    function displayEmptyInvoices() {
      const tbody = document.getElementById('invoices-table');
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="empty-state"><i class="fas fa-file-invoice"></i><p>لا توجد فواتير مبيعات</p></td>
        </tr>
      `;
    }

    async function loadCustomers() {
      try {
        const response = await fetch('/api/customers');

        if (response.ok) {
          const result = await response.json();

          if (result.success) {
            displayCustomers(result.data);
          }
        }
      } catch (error) {
        console.error('خطأ في تحميل العملاء:', error);
        displayEmptyCustomers();
      }
    }

    function displayCustomers(customers) {
      const tbody = document.getElementById('customers-table');

      if (customers.length === 0) {
        displayEmptyCustomers();
        return;
      }

      tbody.innerHTML = customers
        .map((customer) => `
          <tr>
            <td>${customer.code || customer.id}</td>
            <td>${customer.name}</td>
            <td>${customer.phone || '-'}</td>
            <td>${customer.email || '-'}</td>
            <td>${(customer.total_purchases || 0).toFixed(2)}</td>
            <td>${customer.last_purchase ? new Date(customer.last_purchase).toLocaleDateString('ar-SA') : '-'}</td>
            <td>
              <button type="button" class="btn btn-primary" onclick="viewCustomer(${customer.id})"><i class="fas fa-eye"></i></button>
              <button type="button" class="btn btn-warning" onclick="editCustomer(${customer.id})"><i class="fas fa-edit"></i></button>
              <button type="button" class="btn btn-danger" onclick="deleteCustomer(${customer.id})"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `)
        .join('');
    }

    function displayEmptyCustomers() {
      const tbody = document.getElementById('customers-table');
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="empty-state"><i class="fas fa-users"></i><p>لا توجد عملاء مسجلين</p></td>
        </tr>
      `;
    }

    async function loadQuotations() {
      try {
        const response = await fetch('/api/sales/quotations');

        if (response.ok) {
          const result = await response.json();

          if (result.success) {
            displayQuotations(result.data);
          }
        }
      } catch (error) {
        console.error('خطأ في تحميل عروض الأسعار:', error);
        displayEmptyQuotations();
      }
    }

    function displayQuotations(quotations) {
      const tbody = document.getElementById('quotations-table');

      if (quotations.length === 0) {
        displayEmptyQuotations();
        return;
      }

      tbody.innerHTML = quotations
        .map((quotation) => `
          <tr>
            <td>${quotation.number || quotation.id}</td>
            <td>${new Date(quotation.date).toLocaleDateString('ar-SA')}</td>
            <td>${quotation.customer_name}</td>
            <td>${(quotation.total || 0).toFixed(2)}</td>
            <td>${quotation.expiry_date ? new Date(quotation.expiry_date).toLocaleDateString('ar-SA') : '-'}</td>
            <td><span class="status-badge status-${quotation.status || 'draft'}">${getStatusText(quotation.status)}</span></td>
            <td>
              <button type="button" class="btn btn-primary" onclick="viewQuotation(${quotation.id})"><i class="fas fa-eye"></i></button>
              <button type="button" class="btn btn-warning" onclick="editQuotation(${quotation.id})"><i class="fas fa-edit"></i></button>
              <button type="button" class="btn btn-success" onclick="convertToInvoice(${quotation.id})"><i class="fas fa-file-invoice"></i></button>
            </td>
          </tr>
        `)
        .join('');
    }

    function displayEmptyQuotations() {
      const tbody = document.getElementById('quotations-table');
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="empty-state"><i class="fas fa-file-alt"></i><p>لا توجد عروض أسعار</p></td>
        </tr>
      `;
    }

    function getStatusText(status) {
      const statusMap = {
        draft: 'مسودة',
        confirmed: 'مؤكدة',
        delivered: 'مسلمة',
        cancelled: 'ملغية'
      };

      return statusMap[status] || 'غير محدد';
    }

    function showError(message) {
      alert('خطأ: ' + message);
    }

    function showSuccess(message) {
      alert('نجح: ' + message);
    }

    function createNewInvoice() {
      alert('سيتم تطوير وظيفة إنشاء فاتورة جديدة قريباً');
    }

    function viewInvoice(id) {
      alert('سيتم تطوير وظيفة عرض الفاتورة قريباً');
    }

    function editInvoice(id) {
      alert('سيتم تطوير وظيفة تعديل الفاتورة قريباً');
    }

    function deleteInvoice(id) {
      if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟')) {
        alert('سيتم تطوير وظيفة الحذف قريباً');
      }
    }

    function addNewCustomer() {
      alert('سيتم تطوير وظيفة إضافة عميل جديد قريباً');
    }

    function viewCustomer(id) {
      alert('سيتم تطوير وظيفة عرض العميل قريباً');
    }

    function editCustomer(id) {
      alert('سيتم تطوير وظيفة تعديل العميل قريباً');
    }

    function deleteCustomer(id) {
      if (confirm('هل أنت متأكد من حذف هذا العميل؟')) {
        alert('سيتم تطوير وظيفة الحذف قريباً');
      }
    }

    function createNewQuotation() {
      alert('سيتم تطوير وظيفة إنشاء عرض سعر جديد قريباً');
    }

    function viewQuotation(id) {
      alert('سيتم تطوير وظيفة عرض عرض السعر قريباً');
    }

    function editQuotation(id) {
      alert('سيتم تطوير وظيفة تعديل عرض السعر قريباً');
    }

    function convertToInvoice(id) {
      if (confirm('هل تريد تحويل عرض السعر إلى فاتورة؟')) {
        alert('سيتم تطوير وظيفة التحويل قريباً');
      }
    }

    function generateSalesReport() {
      alert('سيتم تطوير وظيفة تقرير المبيعات قريباً');
    }

    function generateCustomersReport() {
      alert('سيتم تطوير وظيفة تقرير العملاء قريباً');
    }
  </script>
</body>
</html>