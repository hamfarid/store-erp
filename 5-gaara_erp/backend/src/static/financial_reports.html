<!-- ملف: /home/ubuntu/complete_inventory_system/backend/src/static/financial_reports.html --><!-- واجهة التقارير المالية المتقدمة --><!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>التقارير المالية المتقدمة</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet"><link href="css/navigation.css" rel="stylesheet"><style> body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; direction: rtl; } .main-container { background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); margin: 20px; padding: 30px; -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); } .page-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; position: relative; overflow: hidden; } .page-header::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: repeating-linear-gradient( 45deg, transparent, transparent 10px, rgba(255, 255, 255, 0.1) 10px, rgba(255, 255, 255, 0.1) 20px ); animation: slide 20s linear infinite; } @keyframes slide { 0% { transform: translateX(-50px); } 100% { transform: translateX(50px); } } .page-header h1 { position: relative; z-index: 1; margin: 0; font-size: 2.5rem; font-weight: 700; } .page-header p { position: relative; z-index: 1; margin: 10px 0 0 0; font-size: 1.2rem; opacity: 0.9; } .report-filters { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); margin-bottom: 30px; } .filter-section { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 10px; padding: 20px; margin-bottom: 20px; } .filter-title { font-weight: 700; color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; } .form-control, .form-select { border: 2px solid #e9ecef; border-radius: 10px; padding: 12px 15px; transition: all 0.3s ease; } .form-control:focus, .form-select:focus { border-color: #667eea; box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25); } .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; transition: all 0.3s ease; } .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3); } .report-tabs { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); overflow: hidden; margin-bottom: 30px; } .nav-tabs { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: none; padding: 0; } .nav-tabs .nav-link { border: none; padding: 20px 30px; font-weight: 600; color: #495057; transition: all 0.3s ease; position: relative; background: transparent; } .nav-tabs .nav-link:hover { background: rgba(102, 126, 234, 0.1); color: #667eea; transform: translateY(-2px); } .nav-tabs .nav-link.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px 10px 0 0; } .tab-content { padding: 30px; } .chart-container { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); margin-bottom: 30px; position: relative; height: 400px; } .chart-title { font-weight: 700; color: #2c3e50; margin-bottom: 20px; text-align: center; font-size: 1.3rem; } .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; } .stat-card { background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; border: 1px solid rgba(102, 126, 234, 0.1); } .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15); } .stat-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 24px; color: white; } .stat-icon.sales { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); } .stat-icon.profit { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); } .stat-icon.cost { background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%); } .stat-icon.margin { background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); } .stat-value { font-size: 2rem; font-weight: 700; color: #2c3e50; margin-bottom: 5px; } .stat-label { color: #6c757d; font-weight: 500; } .stat-change { font-size: 0.9rem; font-weight: 600; margin-top: 5px; } .stat-change.positive { color: #28a745; } .stat-change.negative { color: #dc3545; } .data-table { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); margin-bottom: 30px; } .table { margin: 0; } .table thead th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 20px 15px; font-weight: 600; } .table tbody td { padding: 15px; border-color: #e9ecef; vertical-align: middle; } .table tbody tr:hover { background: rgba(102, 126, 234, 0.05); } .export-buttons { display: flex; gap: 10px; justify-content: center; margin-bottom: 30px; flex-wrap: wrap; } .btn-export { padding: 12px 25px; border-radius: 10px; font-weight: 600; transition: all 0.3s ease; border: none; color: white; } .btn-excel { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); } .btn-pdf { background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); } .btn-print { background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%); } .btn-export:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2); color: white; } .loading { display: none; text-align: center; padding: 50px; } .loading i { font-size: 3rem; color: #667eea; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .empty-state { text-align: center; padding: 50px; color: #6c757d; } .empty-state i { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; } .comparison-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 25px; margin-bottom: 30px; } .comparison-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 20px; text-align: center; } .comparison-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; } .comparison-item { background: rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 20px; text-align: center; } .comparison-period { font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px; } .comparison-value { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; } .comparison-change { font-size: 0.9rem; font-weight: 600; } .trend-indicator { display: inline-flex; align-items: center; gap: 5px; padding: 4px 8px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; } .trend-up { background: rgba(40, 167, 69, 0.2); color: #28a745; } .trend-down { background: rgba(220, 53, 69, 0.2); color: #dc3545; } .trend-stable { background: rgba(108, 117, 125, 0.2); color: #6c757d; } @media (max-width: 768px) { .main-container { margin: 10px; padding: 20px; } .page-header h1 { font-size: 2rem; } .stats-grid { grid-template-columns: 1fr; } .export-buttons { flex-direction: column; } .nav-tabs .nav-link { padding: 15px 20px; font-size: 0.9rem; } .chart-container { height: 300px; } } @media print { body { background: white; } .main-container { box-shadow: none; margin: 0; } .export-buttons, .report-filters { display: none; } } </style></head><body><!-- شريط التنقل العلوي --><nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);"><div class="container-fluid"><a class="navbar-brand" href="dashboard.html"><i class="fas fa-chart-line me-2"></i> التقارير المالية </a><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="تبديل القائمة" title="تبديل القائمة" ><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNav"><ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="fas fa-home me-1"></i> الرئيسية </a></li><li class="nav-item"><a class="nav-link" href="accounting.html"><i class="fas fa-calculator me-1"></i> المحاسبة </a></li><li class="nav-item"><a class="nav-link active" href="financial_reports.html"><i class="fas fa-chart-line me-1"></i> التقارير المالية </a></li></ul><ul class="navbar-nav"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" tabindex="0" tabindex="0" data-bs-toggle="dropdown"><i class="fas fa-user me-1"></i> المستخدم </a><ul class="dropdown-menu"><li><a class="dropdown-item" href="#" onclick="logout()">تسجيل الخروج</a></li></ul></li></ul></div></div></nav><div class="main-container"><!-- رأس الصفحة --><div class="page-header"><h1><i class="fas fa-chart-line me-3"></i>التقارير المالية المتقدمة</h1><p>تحليل شامل للأرباح والخسائر والأداء المالي مع مقارنات زمنية</p></div><!-- فلاتر التقرير --><div class="report-filters"><div class="filter-section"><div class="filter-title"><i class="fas fa-filter"></i> فلاتر التقرير </div><div class="row"><div class="col-md-3"><label class="form-label">نوع التقرير</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="reportType"><option value="profit_loss_summary">ملخص الأرباح والخسائر</option><option value="profit_loss_by_item">الأرباح حسب الصنف</option><option value="profit_loss_by_customer">الأرباح حسب العميل</option><option value="currency_analysis">تحليل العملات</option><option value="performance_dashboard">لوحة الأداء</option></select></div><div class="col-md-3"><label class="form-label">من تاريخ</label><input type="date" class="form-control" id="startDate"></div><div class="col-md-3"><label class="form-label">إلى تاريخ</label><input type="date" class="form-control" id="endDate"></div><div class="col-md-3"><label class="form-label">العملة</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="currencyFilter"><option value="">جميع العملات</option></select></div></div><div class="row mt-3"><div class="col-md-3"><label class="form-label">الفئة</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="categoryFilter"><option value="">جميع الفئات</option></select></div><div class="col-md-3"><label class="form-label">المخزن</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="warehouseFilter"><option value="">جميع المخازن</option></select></div><div class="col-md-3"><label class="form-label">مهندس المبيعات</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="engineerFilter"><option value="">جميع المهندسين</option></select></div><div class="col-md-3 d-flex align-items-end"><button type="button" class="btn btn-primary w-100" onclick="generateReport()"><i class="fas fa-chart-bar me-2"></i>توليد التقرير </button></div></div></div></div><!-- أزرار التصدير --><div class="export-buttons"><button type="button" class="btn btn-export btn-excel" onclick="exportToExcel()"><i class="fas fa-file-excel me-2"></i>تصدير إلى Excel </button><button type="button" class="btn btn-export btn-pdf" onclick="exportToPDF()"><i class="fas fa-file-pdf me-2"></i>تصدير إلى PDF </button><button type="button" class="btn btn-export btn-print" onclick="printReport()"><i class="fas fa-print me-2"></i>طباعة التقرير </button></div><!-- مقارنة الفترات --><div class="comparison-card" id="comparisonCard" style="display: none;"><div class="comparison-title">مقارنة الأداء بين الفترات</div><div class="comparison-grid" id="comparisonGrid"><!-- سيتم ملؤها ديناميكياً --></div></div><!-- إحصائيات سريعة --><div class="stats-grid" id="statsGrid"><!-- سيتم ملؤها ديناميكياً --></div><!-- التبويبات الرئيسية --><div class="report-tabs"><ul class="nav nav-tabs" id="reportTabs" role="tablist"><li class="nav-item" role="presentation"><button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab"><i class="fas fa-chart-pie me-2"></i>الملخص التنفيذي </button></li><li class="nav-item" role="presentation"><button class="nav-link" id="charts-tab" data-bs-toggle="tab" data-bs-target="#charts" type="button" role="tab"><i class="fas fa-chart-bar me-2"></i>الرسوم البيانية </button></li><li class="nav-item" role="presentation"><button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab"><i class="fas fa-table me-2"></i>البيانات التفصيلية </button></li><li class="nav-item" role="presentation"><button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab"><i class="fas fa-analytics me-2"></i>التحليل المتقدم </button></li></ul><div class="tab-content" id="reportTabContent"><!-- تبويب الملخص التنفيذي --><div class="tab-pane fade show active" id="summary" role="tabpanel"><div id="summaryContent" class="empty-state"><i class="fas fa-chart-pie"></i><h5>اختر نوع التقرير والفترة الزمنية</h5><p>سيتم عرض الملخص التنفيذي هنا</p></div></div><!-- تبويب الرسوم البيانية --><div class="tab-pane fade" id="charts" role="tabpanel"><div class="row"><div class="col-md-6"><div class="chart-container"><div class="chart-title">توزيع الأرباح حسب الفترة</div><canvas id="profitTrendChart"></canvas></div></div><div class="col-md-6"><div class="chart-container"><div class="chart-title">توزيع المبيعات حسب الفئة</div><canvas id="salesByCategoryChart"></canvas></div></div></div><div class="row"><div class="col-md-6"><div class="chart-container"><div class="chart-title">أداء العملاء الرئيسيين</div><canvas id="topCustomersChart"></canvas></div></div><div class="col-md-6"><div class="chart-container"><div class="chart-title">تحليل هوامش الربح</div><canvas id="profitMarginsChart"></canvas></div></div></div></div><!-- تبويب البيانات التفصيلية --><div class="tab-pane fade" id="details" role="tabpanel"><div class="data-table"><table class="table" id="detailsTable"><thead><tr id="detailsTableHeader"><!-- سيتم ملؤها ديناميكياً --></tr></thead><tbody id="detailsTableBody"><tr><td colspan="100%" class="text-center"><div class="empty-state"><i class="fas fa-table"></i><p>لا توجد بيانات لعرضها</p></div></td></tr></tbody></table></div></div><!-- تبويب التحليل المتقدم --><div class="tab-pane fade" id="analysis" role="tabpanel"><div id="analysisContent" class="empty-state"><i class="fas fa-analytics"></i><h5>التحليل المتقدم</h5><p>سيتم عرض التحليل المتقدم والتوصيات هنا</p></div></div></div></div><!-- حالة التحميل --><div class="loading" id="loadingIndicator"><i class="fas fa-spinner"></i><p>جاري توليد التقرير...</p></div></div><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script><script src="js/navigation.js"></script><script> // متغيرات عامة let currentUser = null; let authToken = localStorage.getItem('authToken'); let currentReportData = null; let charts = {}; // التحقق من تسجيل الدخول if (!authToken) { window.location.href = 'index.html'; } // تحميل البيانات عند تحميل الصفحة document.addEventListener('DOMContentLoaded', function() { setDefaultDates(); loadFilterOptions(); initializeCharts(); }); // تعيين التواريخ الافتراضية function setDefaultDates() { const today = new Date(); const firstDay = new Date(today.getFullYear(), today.getMonth(), 1); document.getElementById('startDate').value = firstDay.toISOString().split('T')[0]; document.getElementById('endDate').value = today.toISOString().split('T')[0]; } // تحميل خيارات الفلاتر async function loadFilterOptions() { try { // تحميل العملات const currenciesResponse = await fetch('/api/accounting/currencies', { headers: { 'Authorization': `Bearer ${authToken}` } }); if (currenciesResponse.ok) { const currenciesData = await currenciesResponse.json(); populateSelect('currencyFilter', currenciesData.currencies, 'id', 'name'); } // تحميل الفئات const categoriesResponse = await fetch('/api/inventory/categories', { headers: { 'Authorization': `Bearer ${authToken}` } }); if (categoriesResponse.ok) { const categoriesData = await categoriesResponse.json(); populateSelect('categoryFilter', categoriesData.categories, 'id', 'name'); } // تحميل المخازن const warehousesResponse = await fetch('/api/inventory/warehouses', { headers: { 'Authorization': `Bearer ${authToken}` } }); if (warehousesResponse.ok) { const warehousesData = await warehousesResponse.json(); populateSelect('warehouseFilter', warehousesData.warehouses, 'id', 'name'); } // تحميل مهندسي المبيعات const engineersResponse = await fetch('/api/sales/engineers', { headers: { 'Authorization': `Bearer ${authToken}` } }); if (engineersResponse.ok) { const engineersData = await engineersResponse.json(); populateSelect('engineerFilter', engineersData.engineers, 'id', 'name'); } } catch (error) { console.error('خطأ في تحميل خيارات الفلاتر:', error); } } // ملء قائمة منسدلة function populateSelect(selectId, items, valueField, textField) { const select = document.getElementById(selectId); const currentValue = select.value; // الاحتفاظ بالخيار الأول const firstOption = select.querySelector('option'); select.innerHTML = ''; select.appendChild(firstOption); items.forEach(item => { const option = document.createElement('option'); option.value = item[valueField]; option.textContent = item[textField]; select.appendChild(option); }); // استعادة القيمة المحددة select.value = currentValue; } // توليد التقرير async function generateReport() { const reportType = document.getElementById('reportType').value; const startDate = document.getElementById('startDate').value; const endDate = document.getElementById('endDate').value; if (!startDate || !endDate) { showError('يرجى تحديد الفترة الزمنية'); return; } showLoading(true); try { let endpoint = ''; const params = new URLSearchParams({ period_start: startDate, period_end: endDate }); // إضافة الفلاتر الاختيارية const filters = ['currencyFilter', 'categoryFilter', 'warehouseFilter', 'engineerFilter']; filters.forEach(filterId => { const value = document.getElementById(filterId).value; if (value) { const paramName = filterId.replace('Filter', '_id'); params.append(paramName, value); } }); // تحديد نقطة النهاية حسب نوع التقرير switch (reportType) { case 'profit_loss_summary': endpoint = '/api/reports/profit-loss/summary'; break; case 'profit_loss_by_item': endpoint = '/api/reports/profit-loss/by-item'; break; case 'profit_loss_by_customer': endpoint = '/api/reports/profit-loss/by-customer'; break; case 'currency_analysis': endpoint = '/api/reports/currencies/profit-loss'; break; case 'performance_dashboard': endpoint = '/api/reports/performance/dashboard'; break; default: throw new Error('نوع تقرير غير مدعوم'); } const response = await fetch(`${endpoint}?${params}`, { headers: { 'Authorization': `Bearer ${authToken}` } }); if (response.ok) { currentReportData = await response.json(); displayReport(currentReportData, reportType); generateComparison(startDate, endDate); } else { throw new Error('خطأ في توليد التقرير'); } } catch (error) { console.error('خطأ في توليد التقرير:', error); showError(error.message); } finally { showLoading(false); } } // عرض التقرير function displayReport(data, reportType) { displaySummary(data, reportType); displayStats(data, reportType); updateCharts(data, reportType); displayDetails(data, reportType); displayAnalysis(data, reportType); } // عرض الملخص التنفيذي function displaySummary(data, reportType) { const summaryContent = document.getElementById('summaryContent'); let summaryHTML = ''; switch (reportType) { case 'profit_loss_summary': summaryHTML = generateProfitLossSummary(data); break; case 'profit_loss_by_item': summaryHTML = generateItemAnalysisSummary(data); break; case 'profit_loss_by_customer': summaryHTML = generateCustomerAnalysisSummary(data); break; case 'currency_analysis': summaryHTML = generateCurrencyAnalysisSummary(data); break; case 'performance_dashboard': summaryHTML = generatePerformanceSummary(data); break; } summaryContent.innerHTML = summaryHTML; } // توليد ملخص الأرباح والخسائر function generateProfitLossSummary(data) { const summary = data.summary || data.totals; return ` <div class="row"><div class="col-md-12"><h4 class="mb-4">ملخص الأرباح والخسائر للفترة</h4></div></div><div class="row"><div class="col-md-3"><div class="stat-card"><div class="stat-value">${formatCurrency(summary.total_sales || 0)}</div><div class="stat-label">إجمالي المبيعات</div></div></div><div class="col-md-3"><div class="stat-card"><div class="stat-value">${formatCurrency(summary.total_cost || 0)}</div><div class="stat-label">إجمالي التكلفة</div></div></div><div class="col-md-3"><div class="stat-card"><div class="stat-value">${formatCurrency(summary.total_profit || summary.total_gross_profit || 0)}</div><div class="stat-label">الربح الإجمالي</div></div></div><div class="col-md-3"><div class="stat-card"><div class="stat-value">${(summary.overall_profit_margin || summary.overall_gross_margin || 0).toFixed(1)}%</div><div class="stat-label">هامش الربح</div></div></div></div><div class="mt-4"><h5>التحليل:</h5><p>خلال الفترة المحددة، حققت الشركة مبيعات بقيمة ${formatCurrency(summary.total_sales || 0)} بتكلفة إجمالية ${formatCurrency(summary.total_cost || 0)}، مما نتج عنه ربح إجمالي قدره ${formatCurrency(summary.total_profit || summary.total_gross_profit || 0)} بهامش ربح ${(summary.overall_profit_margin || summary.overall_gross_margin || 0).toFixed(1)}%.</p></div> `; } // عرض الإحصائيات function displayStats(data, reportType) { const statsGrid = document.getElementById('statsGrid'); const summary = data.summary || data.totals || {}; statsGrid.innerHTML = ` <div class="stat-card"><div class="stat-icon sales"><i class="fas fa-shopping-cart"></i></div><div class="stat-value">${formatCurrency(summary.total_sales || 0)}</div><div class="stat-label">إجمالي المبيعات</div></div><div class="stat-card"><div class="stat-icon cost"><i class="fas fa-coins"></i></div><div class="stat-value">${formatCurrency(summary.total_cost || 0)}</div><div class="stat-label">إجمالي التكلفة</div></div><div class="stat-card"><div class="stat-icon profit"><i class="fas fa-chart-line"></i></div><div class="stat-value">${formatCurrency(summary.total_profit || summary.total_gross_profit || 0)}</div><div class="stat-label">الربح الإجمالي</div></div><div class="stat-card"><div class="stat-icon margin"><i class="fas fa-percentage"></i></div><div class="stat-value">${(summary.overall_profit_margin || summary.overall_gross_margin || 0).toFixed(1)}%</div><div class="stat-label">هامش الربح</div></div> `; } // تحديث الرسوم البيانية function updateCharts(data, reportType) { // تحديث رسم الاتجاه الزمني للأرباح if (charts.profitTrend) { updateProfitTrendChart(data); } // تحديث رسم توزيع المبيعات حسب الفئة if (charts.salesByCategory) { updateSalesByCategoryChart(data); } // تحديث رسم أداء العملاء if (charts.topCustomers) { updateTopCustomersChart(data); } // تحديث رسم هوامش الربح if (charts.profitMargins) { updateProfitMarginsChart(data); } } // عرض البيانات التفصيلية function displayDetails(data, reportType) { const tableHeader = document.getElementById('detailsTableHeader'); const tableBody = document.getElementById('detailsTableBody'); let headers = []; let rows = []; switch (reportType) { case 'profit_loss_by_item': headers = ['اسم الصنف', 'الفئة', 'الكمية المباعة', 'إجمالي المبيعات', 'إجمالي التكلفة', 'الربح الإجمالي', 'هامش الربح']; rows = (data.items_analysis || []).map(item => [ item.item_name, item.category_name || 'غير محدد', formatNumber(item.total_sold_quantity), formatCurrency(item.total_sales_amount), formatCurrency(item.total_cost_amount), formatCurrency(item.gross_profit), `${item.profit_margin.toFixed(1)}%` ]); break; case 'profit_loss_by_customer': headers = ['اسم العميل', 'نوع العميل', 'عدد الفواتير', 'إجمالي المبيعات', 'الربح الإجمالي', 'هامش الربح', 'معدل التحصيل']; rows = (data.customers_analysis || []).map(customer => [ customer.customer_name, customer.customer_type || 'غير محدد', customer.invoice_count, formatCurrency(customer.total_sales), formatCurrency(customer.gross_profit), `${customer.profit_margin.toFixed(1)}%`, `${customer.collection_rate.toFixed(1)}%` ]); break; default: headers = ['البيان', 'القيمة']; rows = Object.entries(data.summary || {}).map(([key, value]) => [ translateKey(key), typeof value === 'number' ? formatCurrency(value) : value ]); } // إنشاء رؤوس الجدول tableHeader.innerHTML = headers.map(header => `<th>${header}</th>`).join(''); // إنشاء صفوف الجدول if (rows.length > 0) { tableBody.innerHTML = rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>` ).join(''); } else { tableBody.innerHTML = ` <tr><td colspan="${headers.length}" class="text-center"><div class="empty-state"><i class="fas fa-table"></i><p>لا توجد بيانات لعرضها</p></div></td></tr> `; } } // عرض التحليل المتقدم function displayAnalysis(data, reportType) { const analysisContent = document.getElementById('analysisContent'); let analysisHTML = ` <h4>التحليل المتقدم والتوصيات</h4><div class="row mt-4"><div class="col-md-6"><h5><i class="fas fa-lightbulb me-2"></i>نقاط القوة</h5><ul class="list-unstyled"> `; // تحليل نقاط القوة const summary = data.summary || data.totals || {}; if ((summary.overall_profit_margin || 0) > 20) { analysisHTML += '<li><i class="fas fa-check text-success me-2"></i>هامش ربح ممتاز يزيد عن 20%</li>'; } if ((summary.total_sales || 0) > 100000) { analysisHTML += '<li><i class="fas fa-check text-success me-2"></i>حجم مبيعات قوي</li>'; } analysisHTML += ` </ul></div><div class="col-md-6"><h5><i class="fas fa-exclamation-triangle me-2"></i>نقاط التحسين</h5><ul class="list-unstyled"> `; // تحليل نقاط التحسين if ((summary.overall_profit_margin || 0) < 10) { analysisHTML += '<li><i class="fas fa-times text-danger me-2"></i>هامش الربح منخفض - يحتاج تحسين</li>'; } analysisHTML += ` </ul></div></div><div class="mt-4"><h5><i class="fas fa-chart-line me-2"></i>التوصيات</h5><div class="alert alert-info"><ul class="mb-0"><li>مراجعة أسعار البيع للأصناف ذات الهامش المنخفض</li><li>تحسين كفاءة سلسلة التوريد لتقليل التكاليف</li><li>التركيز على العملاء والأصناف الأكثر ربحية</li><li>تطوير استراتيجيات تسويقية للأصناف عالية الهامش</li></ul></div></div> `; analysisContent.innerHTML = analysisHTML; } // توليد مقارنة الفترات async function generateComparison(startDate, endDate) { try { // حساب الفترة السابقة const start = new Date(startDate); const end = new Date(endDate); const duration = end - start; const prevEnd = new Date(start - 1); const prevStart = new Date(prevEnd - duration); const response = await fetch(`/api/reports/profit-loss/summary?period_start=${prevStart.toISOString().split('T')[0]}&period_end=${prevEnd.toISOString().split('T')[0]}`, { headers: { 'Authorization': `Bearer ${authToken}` } }); if (response.ok) { const prevData = await response.json(); displayComparison(currentReportData, prevData); } } catch (error) { console.error('خطأ في توليد المقارنة:', error); } } // عرض المقارنة function displayComparison(currentData, prevData) { const comparisonCard = document.getElementById('comparisonCard'); const comparisonGrid = document.getElementById('comparisonGrid'); const current = currentData.summary || currentData.totals || {}; const previous = prevData.summary || prevData.totals || {}; const salesChange = calculateChange(current.total_sales, previous.total_sales); const profitChange = calculateChange(current.total_profit || current.total_gross_profit, previous.total_profit || previous.total_gross_profit); const marginChange = calculateChange(current.overall_profit_margin || current.overall_gross_margin, previous.overall_profit_margin || previous.overall_gross_margin); comparisonGrid.innerHTML = ` <div class="comparison-item"><div class="comparison-period">المبيعات</div><div class="comparison-value">${formatCurrency(current.total_sales || 0)}</div><div class="comparison-change ${salesChange.class}"><i class="fas fa-${salesChange.icon}"></i> ${salesChange.text} </div></div><div class="comparison-item"><div class="comparison-period">الربح</div><div class="comparison-value">${formatCurrency(current.total_profit || current.total_gross_profit || 0)}</div><div class="comparison-change ${profitChange.class}"><i class="fas fa-${profitChange.icon}"></i> ${profitChange.text} </div></div><div class="comparison-item"><div class="comparison-period">هامش الربح</div><div class="comparison-value">${(current.overall_profit_margin || current.overall_gross_margin || 0).toFixed(1)}%</div><div class="comparison-change ${marginChange.class}"><i class="fas fa-${marginChange.icon}"></i> ${marginChange.text} </div></div> `; comparisonCard.style.display = 'block'; } // حساب التغيير function calculateChange(current, previous) { if (!previous || previous === 0) { return { text: 'جديد', class: 'text-info', icon: 'plus' }; } const change = ((current - previous) / previous) * 100; if (change > 0) { return { text: `+${change.toFixed(1)}%`, class: 'text-success', icon: 'arrow-up' }; } else if (change < 0) { return { text: `${change.toFixed(1)}%`, class: 'text-danger', icon: 'arrow-down' }; } else { return { text: '0%', class: 'text-muted', icon: 'minus' }; } } // تهيئة الرسوم البيانية function initializeCharts() { // رسم الاتجاه الزمني للأرباح const profitTrendCtx = document.getElementById('profitTrendChart').getContext('2d'); charts.profitTrend = new Chart(profitTrendCtx, { type: 'line', data: { labels: [], datasets: [{ label: 'الربح الإجمالي', data: [], borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); // رسم توزيع المبيعات حسب الفئة const salesByCategoryCtx = document.getElementById('salesByCategoryChart').getContext('2d'); charts.salesByCategory = new Chart(salesByCategoryCtx, { type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: [ '#667eea', '#764ba2', '#56ab2f', '#ff6b6b', '#4ecdc4', '#45b7d1', '#f39c12', '#e74c3c' ] }] }, options: { responsive: true, maintainAspectRatio: false } }); // رسم أداء العملاء الرئيسيين const topCustomersCtx = document.getElementById('topCustomersChart').getContext('2d'); charts.topCustomers = new Chart(topCustomersCtx, { type: 'bar', data: { labels: [], datasets: [{ label: 'المبيعات', data: [], backgroundColor: '#667eea' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } }); // رسم هوامش الربح const profitMarginsCtx = document.getElementById('profitMarginsChart').getContext('2d'); charts.profitMargins = new Chart(profitMarginsCtx, { type: 'bar', data: { labels: [], datasets: [{ label: 'هامش الربح %', data: [], backgroundColor: '#56ab2f' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } } }); } // تحديث رسم الاتجاه الزمني للأرباح function updateProfitTrendChart(data) { // هذا مثال - يجب تخصيصه حسب بنية البيانات الفعلية const chart = charts.profitTrend; chart.data.labels = ['الأسبوع 1', 'الأسبوع 2', 'الأسبوع 3', 'الأسبوع 4']; chart.data.datasets[0].data = [10000, 15000, 12000, 18000]; // بيانات تجريبية chart.update(); } // دوال التصدير async function exportToExcel() { if (!currentReportData) { showError('لا توجد بيانات للتصدير'); return; } try { const reportType = document.getElementById('reportType').value; const startDate = document.getElementById('startDate').value; const endDate = document.getElementById('endDate').value; const response = await fetch(`/api/reports/export/profit-loss-comprehensive?period_start=${startDate}&period_end=${endDate}`, { headers: { 'Authorization': `Bearer ${authToken}` } }); if (response.ok) { const blob = await response.blob(); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `تقرير_مالي_${startDate}_${endDate}.xlsx`; a.click(); window.URL.revokeObjectURL(url); } else { throw new Error('خطأ في تصدير التقرير'); } } catch (error) { console.error('خطأ في التصدير:', error); showError('خطأ في تصدير التقرير'); } } function exportToPDF() { showError('ميزة تصدير PDF قيد التطوير'); } function printReport() { window.print(); } // دوال مساعدة function showLoading(show) { document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none'; } function formatCurrency(amount) { return new Intl.NumberFormat('ar-EG', { style: 'currency', currency: 'EGP', minimumFractionDigits: 2 }).format(amount || 0); } function formatNumber(number) { return new Intl.NumberFormat('ar-EG').format(number || 0); } function translateKey(key) { const translations = { 'total_sales': 'إجمالي المبيعات', 'total_cost': 'إجمالي التكلفة', 'total_profit': 'إجمالي الربح', 'overall_profit_margin': 'هامش الربح الإجمالي' }; return translations[key] || key; } function showError(message) { alert('خطأ: ' + message); } function logout() { localStorage.removeItem('authToken'); window.location.href = 'index.html'; } </script></body></html> 