<!-- ملف: /home/ubuntu/complete_inventory_system/backend/src/static/accounting.html --><!-- واجهة نظام المحاسبة المتكامل --><!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>نظام المحاسبة المتكامل</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"><link href="css/navigation.css" rel="stylesheet"><style> body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; direction: rtl; } .main-container { background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); margin: 20px; padding: 30px; -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); } .page-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; position: relative; overflow: hidden; } .page-header::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: repeating-linear-gradient( 45deg, transparent, transparent 10px, rgba(255, 255, 255, 0.1) 10px, rgba(255, 255, 255, 0.1) 20px ); animation: slide 20s linear infinite; } @keyframes slide { 0% { transform: translateX(-50px); } 100% { transform: translateX(50px); } } .page-header h1 { position: relative; z-index: 1; margin: 0; font-size: 2.5rem; font-weight: 700; } .page-header p { position: relative; z-index: 1; margin: 10px 0 0 0; font-size: 1.2rem; opacity: 0.9; } .accounting-tabs { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); overflow: hidden; } .nav-tabs { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: none; padding: 0; } .nav-tabs .nav-link { border: none; padding: 20px 30px; font-weight: 600; color: #495057; transition: all 0.3s ease; position: relative; background: transparent; } .nav-tabs .nav-link:hover { background: rgba(102, 126, 234, 0.1); color: #667eea; transform: translateY(-2px); } .nav-tabs .nav-link.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px 10px 0 0; } .tab-content { padding: 30px; } .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; } .stat-card { background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%); border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); transition: all 0.3s ease; border: 1px solid rgba(102, 126, 234, 0.1); } .stat-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15); } .stat-icon { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; font-size: 24px; color: white; } .stat-icon.currencies { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); } .stat-icon.profit { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); } .stat-icon.payments { background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%); } .stat-icon.reports { background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); } .stat-value { font-size: 2rem; font-weight: 700; color: #2c3e50; margin-bottom: 5px; } .stat-label { color: #6c757d; font-weight: 500; } .action-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; } .action-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 25px; border-radius: 10px; font-weight: 600; transition: all 0.3s ease; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 10px; } .action-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); color: white; } .data-table { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); } .table { margin: 0; } .table thead th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 20px 15px; font-weight: 600; } .table tbody td { padding: 15px; border-color: #e9ecef; vertical-align: middle; } .table tbody tr:hover { background: rgba(102, 126, 234, 0.05); } .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; } .status-draft { background: #ffeaa7; color: #d63031; } .status-calculated { background: #74b9ff; color: #0984e3; } .status-approved { background: #00b894; color: white; } .status-pending { background: #fdcb6e; color: #e17055; } .status-paid { background: #00b894; color: white; } .status-overdue { background: #d63031; color: white; } .form-container { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); margin-bottom: 30px; } .form-group { margin-bottom: 20px; } .form-label { font-weight: 600; color: #2c3e50; margin-bottom: 8px; } .form-control, .form-select { border: 2px solid #e9ecef; border-radius: 10px; padding: 12px 15px; transition: all 0.3s ease; } .form-control:focus, .form-select:focus { border-color: #667eea; box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25); } .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; transition: all 0.3s ease; } .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3); } .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); border: none; padding: 8px 20px; border-radius: 8px; font-weight: 600; } .btn-danger { background: linear-gradient(135deg, #d63031 0%, #ff6b6b 100%); border: none; padding: 8px 20px; border-radius: 8px; font-weight: 600; } .btn-info { background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); border: none; padding: 8px 20px; border-radius: 8px; font-weight: 600; } .currency-converter { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; } .converter-input { background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 10px; padding: 12px 15px; } .converter-input::placeholder { color: rgba(255, 255, 255, 0.7); } .converter-result { background: rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: 600; } .loading { display: none; text-align: center; padding: 50px; } .loading i { font-size: 3rem; color: #667eea; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .empty-state { text-align: center; padding: 50px; color: #6c757d; } .empty-state i { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; } @media (max-width: 768px) { .main-container { margin: 10px; padding: 20px; } .page-header h1 { font-size: 2rem; } .stats-grid { grid-template-columns: 1fr; } .action-buttons { grid-template-columns: 1fr; } .nav-tabs .nav-link { padding: 15px 20px; font-size: 0.9rem; } } </style></head><body><!-- شريط التنقل العلوي --><nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);"><div class="container-fluid"><a class="navbar-brand" href="dashboard.html"><i class="fas fa-calculator me-2"></i> نظام المحاسبة </a><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="تبديل القائمة" title="تبديل القائمة" ><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNav"><ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="fas fa-home me-1"></i> الرئيسية </a></li><li class="nav-item"><a class="nav-link" href="inventory.html"><i class="fas fa-boxes me-1"></i> المخزون </a></li><li class="nav-item"><a class="nav-link" href="sales.html"><i class="fas fa-shopping-cart me-1"></i> المبيعات </a></li><li class="nav-item"><a class="nav-link active" href="accounting.html"><i class="fas fa-calculator me-1"></i> المحاسبة </a></li></ul><ul class="navbar-nav"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" tabindex="0" tabindex="0" data-bs-toggle="dropdown"><i class="fas fa-user me-1"></i> المستخدم </a><ul class="dropdown-menu"><li><a class="dropdown-item" href="#" onclick="logout()">تسجيل الخروج</a></li></ul></li></ul></div></div></nav><div class="main-container"><!-- رأس الصفحة --><div class="page-header"><h1><i class="fas fa-calculator me-3"></i>نظام المحاسبة المتكامل</h1><p>إدارة شاملة للعملات والأرباح والخسائر والتقارير المالية</p></div><!-- إحصائيات سريعة --><div class="stats-grid"><div class="stat-card"><div class="stat-icon currencies"><i class="fas fa-coins"></i></div><div class="stat-value" id="totalCurrencies">3</div><div class="stat-label">العملات المدعومة</div></div><div class="stat-card"><div class="stat-icon profit"><i class="fas fa-chart-line"></i></div><div class="stat-value" id="monthlyProfit">0</div><div class="stat-label">الربح الشهري</div></div><div class="stat-card"><div class="stat-icon payments"><i class="fas fa-credit-card"></i></div><div class="stat-value" id="pendingPayments">0</div><div class="stat-label">المدفوعات المعلقة</div></div><div class="stat-card"><div class="stat-icon reports"><i class="fas fa-file-alt"></i></div><div class="stat-value" id="totalReports">0</div><div class="stat-label">التقارير المولدة</div></div></div><!-- محول العملات --><div class="currency-converter"><h4><i class="fas fa-exchange-alt me-2"></i>محول العملات</h4><div class="row mt-3"><div class="col-md-3"><label for="convertAmount" class="form-label">المبلغ</label><input type="number" placeholder="أدخل رقم" class="form-control converter-input" id="convertAmount" placeholder="المبلغ" aria-label="المبلغ المراد تحويله" ></div><div class="col-md-3"><label for="fromCurrency" class="form-label">من العملة</label><select class="form-select converter-input" id="fromCurrency" aria-label="اختر العملة المصدر" title="اختيار العملة المصدر"><option value="EGP">جنيه مصري (EGP)</option><option value="USD">دولار أمريكي (USD)</option><option value="EUR">يورو (EUR)</option></select></div><div class="col-md-3"><label for="toCurrency" class="form-label">إلى العملة</label><select class="form-select converter-input" id="toCurrency" aria-label="اختر العملة المستهدفة" title="اختيار العملة الهدف"><option value="USD">دولار أمريكي (USD)</option><option value="EGP">جنيه مصري (EGP)</option><option value="EUR">يورو (EUR)</option></select></div><div class="col-md-3"><div class="d-flex align-items-end h-100"><button type="button" class="btn btn-light w-100" onclick="convertCurrency()" title="تحويل العملة" aria-label="تحويل العملة"><i class="fas fa-calculator me-1"></i>تحويل </button></div></div></div><div class="converter-result mt-3" id="conversionResult"> أدخل المبلغ واختر العملات للتحويل </div></div><!-- التبويبات الرئيسية --><div class="accounting-tabs"><ul class="nav nav-tabs" id="accountingTabs" role="tablist"><li class="nav-item" role="presentation"><button class="nav-link active" id="currencies-tab" data-bs-toggle="tab" data-bs-target="#currencies" type="button" role="tab"><i class="fas fa-coins me-2"></i>إدارة العملات </button></li><li class="nav-item" role="presentation"><button class="nav-link" id="profit-loss-tab" data-bs-toggle="tab" data-bs-target="#profit-loss" type="button" role="tab"><i class="fas fa-chart-line me-2"></i>الأرباح والخسائر </button></li><li class="nav-item" role="presentation"><button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab"><i class="fas fa-credit-card me-2"></i>مواعيد الدفع </button></li><li class="nav-item" role="presentation"><button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab"><i class="fas fa-file-alt me-2"></i>التقارير المالية </button></li></ul><div class="tab-content" id="accountingTabContent"><!-- تبويب إدارة العملات --><div class="tab-pane fade show active" id="currencies" role="tabpanel"><div class="action-buttons"><button type="button" class="action-btn" onclick="showAddCurrencyModal()" title="إضافة عملة جديدة"><i class="fas fa-plus"></i>إضافة عملة جديدة </button><button type="button" class="action-btn" onclick="showExchangeRateModal()" title="تحديث أسعار الصرف"><i class="fas fa-exchange-alt"></i>تحديث أسعار الصرف </button><button type="button" class="action-btn" onclick="loadCurrencies()" title="تحديث البيانات"><i class="fas fa-sync"></i>تحديث البيانات </button></div><div class="data-table"><table class="table"><thead><tr><th>رمز العملة</th><th>اسم العملة</th><th>الرمز</th><th>العملة الأساسية</th><th>الحالة</th><th>الإجراءات</th></tr></thead><tbody id="currenciesTableBody"><tr><td colspan="6" class="text-center"><div class="loading"><i class="fas fa-spinner"></i><p>جاري تحميل البيانات...</p></div></td></tr></tbody></table></div></div><!-- تبويب الأرباح والخسائر --><div class="tab-pane fade" id="profit-loss" role="tabpanel"><div class="action-buttons"><button type="button" class="action-btn" onclick="showProfitLossCalculationModal()" title="إنشاء حساب جديد"><i class="fas fa-calculator"></i>حساب جديد </button><button type="button" class="action-btn" onclick="loadProfitLossCalculations()" title="تحديث البيانات"><i class="fas fa-sync"></i>تحديث البيانات </button><button type="button" class="action-btn" onclick="exportProfitLossReport()" title="تصدير تقرير"><i class="fas fa-file-excel"></i>تصدير تقرير </button></div><div class="data-table"><table class="table"><thead><tr><th>رقم الحساب</th><th>المستوى</th><th>المرجع</th><th>الفترة</th><th>إجمالي المبيعات</th><th>الربح الإجمالي</th><th>الربح الصافي</th><th>الحالة</th><th>الإجراءات</th></tr></thead><tbody id="profitLossTableBody"><tr><td colspan="9" class="text-center"><div class="loading"><i class="fas fa-spinner"></i><p>جاري تحميل البيانات...</p></div></td></tr></tbody></table></div></div><!-- تبويب مواعيد الدفع --><div class="tab-pane fade" id="payments" role="tabpanel"><div class="action-buttons"><button type="button" class="action-btn" onclick="showPaymentScheduleModal()" title="إضافة موعد دفع جديد"><i class="fas fa-plus"></i>إضافة موعد دفع </button><button type="button" class="action-btn" onclick="loadPaymentSchedules()" title="تحديث البيانات"><i class="fas fa-sync"></i>تحديث البيانات </button><button type="button" class="action-btn" onclick="showOverduePayments()" title="عرض المدفوعات المتأخرة"><i class="fas fa-exclamation-triangle"></i>المتأخرات </button></div><div class="data-table"><table class="table"><thead><tr><th>رقم الجدولة</th><th>نوع الطرف</th><th>اسم الطرف</th><th>المرجع</th><th>المبلغ الإجمالي</th><th>المبلغ المتبقي</th><th>تاريخ الاستحقاق</th><th>حالة الدفع</th><th>الإجراءات</th></tr></thead><tbody id="paymentSchedulesTableBody"><tr><td colspan="9" class="text-center"><div class="loading"><i class="fas fa-spinner"></i><p>جاري تحميل البيانات...</p></div></td></tr></tbody></table></div></div><!-- تبويب التقارير المالية --><div class="tab-pane fade" id="reports" role="tabpanel"><div class="action-buttons"><button type="button" class="action-btn" onclick="generateFinancialReport()" title="توليد تقرير الأرباح والخسائر"><i class="fas fa-chart-bar"></i>تقرير الأرباح والخسائر </button><button type="button" class="action-btn" onclick="generateSalesReport()" title="توليد تقرير المبيعات"><i class="fas fa-shopping-cart"></i>تقرير المبيعات </button><button type="button" class="action-btn" onclick="generateInventoryReport()" title="توليد تقرير المخزون"><i class="fas fa-boxes"></i>تقرير المخزون </button><button type="button" class="action-btn" onclick="generateCurrencyReport()" title="توليد تقرير العملات"><i class="fas fa-coins"></i>تقرير العملات </button></div><div class="row"><div class="col-md-6"><div class="form-container"><h5><i class="fas fa-filter me-2"></i>فلاتر التقرير</h5><div class="form-group"><label for="reportType" class="form-label">نوع التقرير</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="reportType" ><option value="profit_loss">الأرباح والخسائر</option><option value="sales_monthly">المبيعات الشهرية</option><option value="sales_yearly">المبيعات السنوية</option><option value="inventory_balance">أرصدة المخزون</option><option value="currency_analysis">تحليل العملات</option></select></div><div class="row"><div class="col-md-6"><div class="form-group"><label for="reportStartDate" class="form-label">من تاريخ</label><input type="date" class="form-control" id="reportStartDate" aria-label="تاريخ بداية التقرير"></div></div><div class="col-md-6"><div class="form-group"><label for="reportEndDate" class="form-label">إلى تاريخ</label><input type="date" class="form-control" id="reportEndDate" aria-label="تاريخ نهاية التقرير"></div></div></div><button type="button" class="btn btn-primary w-100" onclick="generateCustomReport()" title="توليد التقرير المخصص"><i class="fas fa-chart-line me-2"></i>توليد التقرير </button></div></div><div class="col-md-6"><div class="form-container"><h5><i class="fas fa-download me-2"></i>تصدير التقارير</h5><div class="d-grid gap-2"><button type="button" class="btn btn-success" onclick="exportToExcel()" title="تصدير التقرير إلى Excel"><i class="fas fa-file-excel me-2"></i>تصدير إلى Excel </button><button type="button" class="btn btn-danger" onclick="exportToPDF()" title="تصدير التقرير إلى PDF"><i class="fas fa-file-pdf me-2"></i>تصدير إلى PDF </button><button type="button" class="btn btn-info" onclick="printReport()" title="طباعة التقرير"><i class="fas fa-print me-2"></i>طباعة التقرير </button></div></div></div></div><div class="data-table"><div id="reportResults" class="empty-state"><i class="fas fa-chart-bar"></i><h5>اختر نوع التقرير والفترة الزمنية لعرض النتائج</h5><p>يمكنك توليد تقارير مفصلة للأرباح والخسائر والمبيعات والمخزون</p></div></div></div></div></div></div><!-- Modal إضافة عملة جديدة --><div class="modal fade" id="addCurrencyModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">إضافة عملة جديدة</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق" title="إغلاق النافذة" ></button></div><div class="modal-body"><form id="addCurrencyForm"><div class="form-group"><label for="currencyCode" class="form-label">رمز العملة</label><input type="text" placeholder="أدخل النص" class="form-control" id="currencyCode" maxlength="3" required aria-label="رمز العملة" ></div><div class="form-group"><label for="currencyName" class="form-label">اسم العملة</label><input type="text" placeholder="أدخل النص" class="form-control" id="currencyName" required aria-label="اسم العملة" ></div><div class="form-group"><label for="currencySymbol" class="form-label">رمز العملة</label><input type="text" placeholder="أدخل النص" class="form-control" id="currencySymbol" maxlength="5" required aria-label="رمز العملة" ></div><div class="form-check"><input class="form-check-input" type="checkbox" id="isBaseCurrency"><label class="form-check-label" for="isBaseCurrency"> العملة الأساسية </label></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" class="btn btn-primary" onclick="addCurrency()">إضافة</button></div></div></div></div><!-- Modal تحديث سعر الصرف --><div class="modal fade" id="exchangeRateModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">تحديث سعر الصرف</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق" title="إغلاق النافذة" ></button></div><div class="modal-body"><form id="exchangeRateForm"><div class="row"><div class="col-md-6"><div class="form-group"><label for="fromCurrencyRate" class="form-label">من العملة</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="fromCurrencyRate" required ><option value="">اختر العملة</option></select></div></div><div class="col-md-6"><div class="form-group"><label for="toCurrencyRate" class="form-label">إلى العملة</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="toCurrencyRate" required ><option value="">اختر العملة</option></select></div></div></div><div class="form-group"><label for="exchangeRate" class="form-label">سعر الصرف</label><input type="number" placeholder="أدخل رقم" class="form-control" id="exchangeRate" step="0.000001" required aria-label="سعر الصرف" ></div><div class="form-group"><label for="effectiveDate" class="form-label">تاريخ السريان</label><input type="date" class="form-control" id="effectiveDate" required aria-label="تاريخ السريان"></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" class="btn btn-primary" onclick="updateExchangeRate()">تحديث</button></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><script src="js/navigation.js"></script><script> // متغيرات عامة let currentUser = null; let authToken = localStorage.getItem('authToken'); // التحقق من تسجيل الدخول if (!authToken) { window.location.href = 'index.html'; } // تحميل البيانات عند تحميل الصفحة document.addEventListener('DOMContentLoaded', function() { loadDashboardStats(); loadCurrencies(); loadProfitLossCalculations(); loadPaymentSchedules(); setDefaultDates(); }); // تحميل إحصائيات لوحة المعلومات async function loadDashboardStats() { try { const response = await fetch('/api/profit-loss/dashboard-stats', { headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } }); if (response.ok) { const data = await response.json(); document.getElementById('monthlyProfit').textContent = formatCurrency(data.profit_loss.monthly_gross_profit); document.getElementById('pendingPayments').textContent = data.payment_schedules.overdue_count; document.getElementById('totalReports').textContent = data.financial_reports.total_reports; } } catch (error) { console.error('خطأ في تحميل الإحصائيات:', error); } } // تحميل العملات async function loadCurrencies() { try { const response = await fetch('/api/accounting/currencies', { headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } }); if (response.ok) { const data = await response.json(); displayCurrencies(data.currencies); populateCurrencySelects(data.currencies); } } catch (error) { console.error('خطأ في تحميل العملات:', error); showError('خطأ في تحميل العملات'); } } // عرض العملات في الجدول function displayCurrencies(currencies) { const tbody = document.getElementById('currenciesTableBody'); if (currencies.length === 0) { tbody.innerHTML = ` <tr><td colspan="6" class="text-center"><div class="empty-state"><i class="fas fa-coins"></i><p>لا توجد عملات مسجلة</p></div></td></tr> `; return; } tbody.innerHTML = currencies.map(currency => ` <tr><td><strong>${currency.code}</strong></td><td>${currency.name}</td><td>${currency.symbol}</td><td> ${currency.is_base_currency ? '<span class="status-badge status-approved">نعم</span>' : '<span class="status-badge status-draft">لا</span>' } </td><td> ${currency.is_active ? '<span class="status-badge status-approved">نشط</span>' : '<span class="status-badge status-draft">غير نشط</span>' } </td><td><button type="button" class="btn btn-info btn-sm" onclick="editCurrency(${currency.id})"><i class="fas fa-edit"></i></button><button type="button" class="btn btn-danger btn-sm" onclick="deleteCurrency(${currency.id})"><i class="fas fa-trash"></i></button></td></tr> `).join(''); } // ملء قوائم العملات function populateCurrencySelects(currencies) { const selects = ['fromCurrencyRate', 'toCurrencyRate']; selects.forEach(selectId => { const select = document.getElementById(selectId); select.innerHTML = '<option value="">اختر العملة</option>'; currencies.forEach(currency => { select.innerHTML += `<option value="${currency.id}">${currency.name} (${currency.code})</option>`; }); }); } // تحميل حسابات الأرباح والخسائر async function loadProfitLossCalculations() { try { const response = await fetch('/api/profit-loss/calculations', { headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } }); if (response.ok) { const data = await response.json(); displayProfitLossCalculations(data.calculations); } } catch (error) { console.error('خطأ في تحميل حسابات الأرباح والخسائر:', error); } } // عرض حسابات الأرباح والخسائر function displayProfitLossCalculations(calculations) { const tbody = document.getElementById('profitLossTableBody'); if (calculations.length === 0) { tbody.innerHTML = ` <tr><td colspan="9" class="text-center"><div class="empty-state"><i class="fas fa-chart-line"></i><p>لا توجد حسابات أرباح وخسائر</p></div></td></tr> `; return; } tbody.innerHTML = calculations.map(calc => ` <tr><td><strong>${calc.calculation_number}</strong></td><td>${getCalculationLevelText(calc.calculation_level)}</td><td>${calc.reference_name}</td><td>${formatDate(calc.period_start)} - ${formatDate(calc.period_end)}</td><td>${formatCurrency(calc.total_sales_amount)}</td><td>${formatCurrency(calc.gross_profit)}</td><td>${formatCurrency(calc.net_profit)}</td><td><span class="status-badge status-${calc.status}"> ${getStatusText(calc.status)} </span></td><td><button type="button" class="btn btn-info btn-sm" onclick="viewCalculation(${calc.id})"><i class="fas fa-eye"></i></button> ${calc.status === 'calculated' ? `<button type="button" class="btn btn-success btn-sm" onclick="approveCalculation(${calc.id})"><i class="fas fa-check"></i></button>` : '' } </td></tr> `).join(''); } // تحميل مواعيد الدفع async function loadPaymentSchedules() { try { const response = await fetch('/api/payment-schedules', { headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } }); if (response.ok) { const data = await response.json(); displayPaymentSchedules(data.schedules); } } catch (error) { console.error('خطأ في تحميل مواعيد الدفع:', error); } } // عرض مواعيد الدفع function displayPaymentSchedules(schedules) { const tbody = document.getElementById('paymentSchedulesTableBody'); if (schedules.length === 0) { tbody.innerHTML = ` <tr><td colspan="9" class="text-center"><div class="empty-state"><i class="fas fa-calendar-alt"></i><p>لا توجد مواعيد دفع مسجلة</p></div></td></tr> `; return; } tbody.innerHTML = schedules.map(schedule => ` <tr><td><strong>${schedule.schedule_number}</strong></td><td>${getPartnerTypeText(schedule.partner_type)}</td><td>${schedule.partner_name}</td><td>${schedule.reference_number}</td><td>${formatCurrency(schedule.total_amount)}</td><td>${formatCurrency(schedule.remaining_amount)}</td><td>${formatDate(schedule.due_date)}</td><td><span class="status-badge status-${schedule.payment_status}"> ${getPaymentStatusText(schedule.payment_status)} </span> ${schedule.days_overdue > 0 ? `<small class="text-danger d-block">${schedule.days_overdue} يوم تأخير</small>` : '' } </td><td><button type="button" class="btn btn-success btn-sm" onclick="addPayment(${schedule.id})"><i class="fas fa-plus"></i></button><button type="button" class="btn btn-info btn-sm" onclick="viewSchedule(${schedule.id})"><i class="fas fa-eye"></i></button></td></tr> `).join(''); } // تحويل العملات async function convertCurrency() { const amount = document.getElementById('convertAmount').value; const fromCurrency = document.getElementById('fromCurrency').value; const toCurrency = document.getElementById('toCurrency').value; const resultDiv = document.getElementById('conversionResult'); if (!amount || !fromCurrency || !toCurrency) { resultDiv.innerHTML = 'يرجى إدخال جميع البيانات المطلوبة'; return; } if (fromCurrency === toCurrency) { resultDiv.innerHTML = `${amount} ${fromCurrency} = ${amount} ${toCurrency}`; return; } try { const response = await fetch(`/api/accounting/convert-currency?from=${fromCurrency}&to=${toCurrency}&amount=${amount}`, { headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } }); if (response.ok) { const data = await response.json(); resultDiv.innerHTML = ` ${formatNumber(amount)} ${fromCurrency} = <strong>${formatNumber(data.converted_amount)} ${toCurrency}</strong><br><small>سعر الصرف: ${data.exchange_rate}</small> `; } else { resultDiv.innerHTML = 'خطأ في التحويل - تحقق من أسعار الصرف'; } } catch (error) { console.error('خطأ في تحويل العملة:', error); resultDiv.innerHTML = 'خطأ في الاتصال بالخادم'; } } // إضافة عملة جديدة function showAddCurrencyModal() { const modal = new bootstrap.Modal(document.getElementById('addCurrencyModal')); modal.show(); } async function addCurrency() { const form = document.getElementById('addCurrencyForm'); const formData = new FormData(form); const currencyData = { code: document.getElementById('currencyCode').value.toUpperCase(), name: document.getElementById('currencyName').value, symbol: document.getElementById('currencySymbol').value, is_base_currency: document.getElementById('isBaseCurrency').checked }; try { const response = await fetch('/api/accounting/currencies', { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(currencyData) }); if (response.ok) { showSuccess('تم إضافة العملة بنجاح'); bootstrap.Modal.getInstance(document.getElementById('addCurrencyModal')).hide(); form.reset(); loadCurrencies(); } else { const error = await response.json(); showError(error.error || 'خطأ في إضافة العملة'); } } catch (error) { console.error('خطأ في إضافة العملة:', error); showError('خطأ في الاتصال بالخادم'); } } // تحديث سعر الصرف function showExchangeRateModal() { const modal = new bootstrap.Modal(document.getElementById('exchangeRateModal')); document.getElementById('effectiveDate').value = new Date().toISOString().split('T')[0]; modal.show(); } async function updateExchangeRate() { const rateData = { from_currency_id: document.getElementById('fromCurrencyRate').value, to_currency_id: document.getElementById('toCurrencyRate').value, rate: document.getElementById('exchangeRate').value, effective_date: document.getElementById('effectiveDate').value }; try { const response = await fetch('/api/accounting/exchange-rates', { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(rateData) }); if (response.ok) { showSuccess('تم تحديث سعر الصرف بنجاح'); bootstrap.Modal.getInstance(document.getElementById('exchangeRateModal')).hide(); document.getElementById('exchangeRateForm').reset(); } else { const error = await response.json(); showError(error.error || 'خطأ في تحديث سعر الصرف'); } } catch (error) { console.error('خطأ في تحديث سعر الصرف:', error); showError('خطأ في الاتصال بالخادم'); } } // توليد التقارير async function generateCustomReport() { const reportType = document.getElementById('reportType').value; const startDate = document.getElementById('reportStartDate').value; const endDate = document.getElementById('reportEndDate').value; if (!startDate || !endDate) { showError('يرجى تحديد الفترة الزمنية'); return; } const resultsDiv = document.getElementById('reportResults'); resultsDiv.innerHTML = ` <div class="loading"><i class="fas fa-spinner"></i><p>جاري توليد التقرير...</p></div> `; try { let endpoint = ''; switch (reportType) { case 'profit_loss': endpoint = `/api/reports/profit-loss/summary?period_start=${startDate}&period_end=${endDate}`; break; case 'sales_monthly': const date = new Date(startDate); endpoint = `/api/reports/sales/monthly?year=${date.getFullYear()}&month=${date.getMonth() + 1}`; break; case 'inventory_balance': endpoint = `/api/reports/inventory/balance`; break; case 'currency_analysis': endpoint = `/api/reports/currencies/profit-loss?period_start=${startDate}&period_end=${endDate}`; break; default: throw new Error('نوع تقرير غير مدعوم'); } const response = await fetch(endpoint, { headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } }); if (response.ok) { const data = await response.json(); displayReportResults(data, reportType); } else { throw new Error('خطأ في توليد التقرير'); } } catch (error) { console.error('خطأ في توليد التقرير:', error); resultsDiv.innerHTML = ` <div class="empty-state"><i class="fas fa-exclamation-triangle text-danger"></i><h5>خطأ في توليد التقرير</h5><p>${error.message}</p></div> `; } } // عرض نتائج التقرير function displayReportResults(data, reportType) { const resultsDiv = document.getElementById('reportResults'); switch (reportType) { case 'profit_loss': resultsDiv.innerHTML = generateProfitLossReportHTML(data); break; case 'sales_monthly': resultsDiv.innerHTML = generateSalesReportHTML(data); break; case 'inventory_balance': resultsDiv.innerHTML = generateInventoryReportHTML(data); break; case 'currency_analysis': resultsDiv.innerHTML = generateCurrencyReportHTML(data); break; default: resultsDiv.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>'; } } // توليد HTML لتقرير الأرباح والخسائر function generateProfitLossReportHTML(data) { return ` <div class="report-summary mb-4"><h5>ملخص الأرباح والخسائر</h5><div class="row"><div class="col-md-3"><div class="stat-card"><div class="stat-value">${formatCurrency(data.totals.total_sales)}</div><div class="stat-label">إجمالي المبيعات</div></div></div><div class="col-md-3"><div class="stat-card"><div class="stat-value">${formatCurrency(data.totals.total_gross_profit)}</div><div class="stat-label">الربح الإجمالي</div></div></div><div class="col-md-3"><div class="stat-card"><div class="stat-value">${formatCurrency(data.totals.total_net_profit)}</div><div class="stat-label">الربح الصافي</div></div></div><div class="col-md-3"><div class="stat-card"><div class="stat-value">${data.totals.overall_gross_margin.toFixed(1)}%</div><div class="stat-label">هامش الربح</div></div></div></div></div><table class="table"><thead><tr><th>المستوى</th><th>المرجع</th><th>المبيعات</th><th>التكلفة</th><th>الربح الإجمالي</th><th>الربح الصافي</th><th>هامش الربح</th></tr></thead><tbody> ${data.data.map(item => ` <tr><td>${getCalculationLevelText(item.calculation_level)}</td><td>${item.reference_name}</td><td>${formatCurrency(item.total_sales)}</td><td>${formatCurrency(item.total_cost)}</td><td>${formatCurrency(item.total_gross_profit)}</td><td>${formatCurrency(item.total_net_profit)}</td><td>${item.avg_gross_margin.toFixed(1)}%</td></tr> `).join('')} </tbody></table> `; } // دوال مساعدة للتنسيق function formatCurrency(amount) { return new Intl.NumberFormat('ar-EG', { style: 'currency', currency: 'EGP', minimumFractionDigits: 2 }).format(amount || 0); } function formatNumber(number) { return new Intl.NumberFormat('ar-EG').format(number || 0); } function formatDate(dateString) { if (!dateString) return ''; return new Date(dateString).toLocaleDateString('ar-EG'); } function getCalculationLevelText(level) { const levels = { 'item': 'الصنف', 'customer': 'العميل', 'supplier': 'المورد', 'warehouse': 'المخزن', 'category': 'الفئة' }; return levels[level] || level; } function getStatusText(status) { const statuses = { 'draft': 'مسودة', 'calculated': 'محسوب', 'approved': 'معتمد' }; return statuses[status] || status; } function getPartnerTypeText(type) { const types = { 'customer': 'عميل', 'supplier': 'مورد', 'employee': 'موظف' }; return types[type] || type; } function getPaymentStatusText(status) { const statuses = { 'pending': 'معلق', 'partial': 'جزئي', 'paid': 'مدفوع', 'overdue': 'متأخر' }; return statuses[status] || status; } function setDefaultDates() { const today = new Date(); const firstDay = new Date(today.getFullYear(), today.getMonth(), 1); document.getElementById('reportStartDate').value = firstDay.toISOString().split('T')[0]; document.getElementById('reportEndDate').value = today.toISOString().split('T')[0]; } // دوال الرسائل function showSuccess(message) { // يمكن استخدام مكتبة Toast أو Alert alert('نجح: ' + message); } function showError(message) { alert('خطأ: ' + message); } // دوال أخرى (يمكن تطويرها لاحقاً) function editCurrency(id) { console.log('تعديل العملة:', id); } function deleteCurrency(id) { console.log('حذف العملة:', id); } function viewCalculation(id) { console.log('عرض الحساب:', id); } function approveCalculation(id) { console.log('اعتماد الحساب:', id); } function addPayment(id) { console.log('إضافة دفعة:', id); } function viewSchedule(id) { console.log('عرض الجدولة:', id); } function exportToExcel() { console.log('تصدير إلى Excel'); } function exportToPDF() { console.log('تصدير إلى PDF'); } function printReport() { window.print(); } function logout() { localStorage.removeItem('authToken'); window.location.href = 'index.html'; } </script></body></html> 