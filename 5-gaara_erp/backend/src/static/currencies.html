<!-- تعليق --><!-- تعليق --><!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>إدارة العملات المتعددة</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"><link href="css/navigation.css" rel="stylesheet"><style> body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; direction: rtl; } .main-container { background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); margin: 20px; padding: 30px; -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); } .page-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; position: relative; overflow: hidden; } .page-header::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: repeating-linear-gradient( 45deg, transparent, transparent 10px, rgba(255, 255, 255, 0.1) 10px, rgba(255, 255, 255, 0.1) 20px ); animation: slide 20s linear infinite; } @keyframes slide { 0% { transform: translateX(-50px); } 100% { transform: translateX(50px); } } .page-header h1 { position: relative; z-index: 1; margin: 0; font-size: 2.5rem; font-weight: 700; } .page-header p { position: relative; z-index: 1; margin: 10px 0 0 0; font-size: 1.2rem; opacity: 0.9; } .currency-tabs { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); overflow: hidden; margin-bottom: 30px; } .nav-tabs { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: none; padding: 0; } .nav-tabs .nav-link { border: none; padding: 20px 30px; font-weight: 600; color: #495057; transition: all 0.3s ease; position: relative; background: transparent; } .nav-tabs .nav-link:hover { background: rgba(102, 126, 234, 0.1); color: #667eea; transform: translateY(-2px); } .nav-tabs .nav-link.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px 10px 0 0; } .tab-content { padding: 30px; } .action-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; } .action-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 25px; border-radius: 10px; font-weight: 600; transition: all 0.3s ease; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 10px; } .action-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); color: white; } .currency-converter { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 30px; } .converter-input { background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 10px; padding: 12px 15px; } .converter-input::placeholder { color: rgba(255, 255, 255, 0.7); } .converter-input:focus { background: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.5); color: white; box-shadow: none; } .converter-result { background: rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 20px; text-align: center; font-size: 1.3rem; font-weight: 600; margin-top: 20px; } .exchange-rate-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); margin-bottom: 20px; transition: all 0.3s ease; } .exchange-rate-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15); } .rate-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; } .currency-pair { font-size: 1.2rem; font-weight: 700; color: #2c3e50; } .rate-value { font-size: 1.5rem; font-weight: 700; color: #667eea; } .rate-change { font-size: 0.9rem; font-weight: 600; margin-top: 5px; } .rate-change.positive { color: #28a745; } .rate-change.negative { color: #dc3545; } .rate-change.neutral { color: #6c757d; } .rate-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 15px; } .rate-detail { text-align: center; padding: 10px; background: #f8f9fa; border-radius: 8px; } .rate-detail-label { font-size: 0.8rem; color: #6c757d; margin-bottom: 5px; } .rate-detail-value { font-weight: 600; color: #2c3e50; } .data-table { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); } .table { margin: 0; } .table thead th { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 20px 15px; font-weight: 600; } .table tbody td { padding: 15px; border-color: #e9ecef; vertical-align: middle; } .table tbody tr:hover { background: rgba(102, 126, 234, 0.05); } .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; } .status-active { background: #00b894; color: white; } .status-inactive { background: #d63031; color: white; } .status-base { background: #fdcb6e; color: #2d3436; } .form-container { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); margin-bottom: 30px; } .form-group { margin-bottom: 20px; } .form-label { font-weight: 600; color: #2c3e50; margin-bottom: 8px; } .form-control, .form-select { border: 2px solid #e9ecef; border-radius: 10px; padding: 12px 15px; transition: all 0.3s ease; } .form-control:focus, .form-select:focus { border-color: #667eea; box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25); } .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 12px 30px; border-radius: 10px; font-weight: 600; transition: all 0.3s ease; } .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3); } .btn-success { background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); border: none; padding: 8px 20px; border-radius: 8px; font-weight: 600; } .btn-danger { background: linear-gradient(135deg, #d63031 0%, #ff6b6b 100%); border: none; padding: 8px 20px; border-radius: 8px; font-weight: 600; } .btn-info { background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); border: none; padding: 8px 20px; border-radius: 8px; font-weight: 600; } .currency-flag { width: 24px; height: 16px; border-radius: 3px; margin-left: 8px; display: inline-block; background-size: cover; background-position: center; } .loading { display: none; text-align: center; padding: 50px; } .loading i { font-size: 3rem; color: #667eea; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } .empty-state { text-align: center; padding: 50px; color: #6c757d; } .empty-state i { font-size: 4rem; margin-bottom: 20px; opacity: 0.5; } .rate-history { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); margin-bottom: 30px; } .rate-history-chart { height: 300px; margin-top: 20px; } @media (max-width: 768px) { .main-container { margin: 10px; padding: 20px; } .page-header h1 { font-size: 2rem; } .action-buttons { grid-template-columns: 1fr; } .nav-tabs .nav-link { padding: 15px 20px; font-size: 0.9rem; } .rate-details { grid-template-columns: repeat(2, 1fr); } } </style></head><body><!-- تعليق --><nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);"><div class="container-fluid"><a class="navbar-brand" href="dashboard.html"><i class="fas fa-coins me-2"></i> إدارة العملات </a><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="تبديل القائمة" title="تبديل القائمة" ><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNav"><ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="fas fa-home me-1"></i> الرئيسية </a></li><li class="nav-item"><a class="nav-link" href="accounting.html"><i class="fas fa-calculator me-1"></i> المحاسبة </a></li><li class="nav-item"><a class="nav-link active" href="currencies.html"><i class="fas fa-coins me-1"></i> العملات </a></li></ul><ul class="navbar-nav"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" tabindex="0" tabindex="0" data-bs-toggle="dropdown"><i class="fas fa-user me-1"></i> المستخدم </a><ul class="dropdown-menu"><li><a class="dropdown-item" href="#" onclick="logout()">تسجيل الخروج</a></li></ul></li></ul></div></div></nav><div class="main-container"><!-- تعليق --><div class="page-header"><h1><i class="fas fa-coins me-3"></i>إدارة العملات المتعددة</h1><p>إدارة شاملة للعملات وأسعار الصرف مع التحويل الفوري</p></div><!-- تعليق --><div class="currency-converter"><h4><i class="fas fa-exchange-alt me-2"></i>محول العملات المتقدم</h4><div class="row mt-3"><div class="col-md-3"><label class="form-label text-white">المبلغ</label><input type="number" placeholder="أدخل رقم" class="form-control converter-input" id="convertAmount" placeholder="أدخل المبلغ" step="0.01" aria-label="حقل رقم"></div><div class="col-md-3"><label class="form-label text-white">من العملة</label><select class="form-select converter-input" id="fromCurrency" aria-label="اختيار العملة المصدر" title="اختيار العملة المصدر" ><option value="">اختر العملة</option></select></div><div class="col-md-3"><label class="form-label text-white">إلى العملة</label><select class="form-select converter-input" id="toCurrency" aria-label="اختيار العملة الهدف" title="اختيار العملة الهدف"><option value="">اختر العملة</option></select></div><div class="col-md-3 d-flex align-items-end"><button type="button" class="btn btn-light w-100" onclick="convertCurrency()"><i class="fas fa-calculator me-1"></i>تحويل </button></div></div><div class="converter-result" id="conversionResult"> أدخل المبلغ واختر العملات للتحويل </div></div><!-- تعليق --><div class="currency-tabs"><ul class="nav nav-tabs" id="currencyTabs" role="tablist"><li class="nav-item" role="presentation"><button class="nav-link active" id="currencies-tab" data-bs-toggle="tab" data-bs-target="#currencies" type="button" role="tab"><i class="fas fa-coins me-2"></i>العملات المدعومة </button></li><li class="nav-item" role="presentation"><button class="nav-link" id="exchange-rates-tab" data-bs-toggle="tab" data-bs-target="#exchange-rates" type="button" role="tab"><i class="fas fa-exchange-alt me-2"></i>أسعار الصرف </button></li><li class="nav-item" role="presentation"><button class="nav-link" id="rate-history-tab" data-bs-toggle="tab" data-bs-target="#rate-history" type="button" role="tab"><i class="fas fa-chart-line me-2"></i>تاريخ الأسعار </button></li><li class="nav-item" role="presentation"><button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab"><i class="fas fa-cog me-2"></i>الإعدادات </button></li></ul><div class="tab-content" id="currencyTabContent"><!-- تعليق --><div class="tab-pane fade show active" id="currencies" role="tabpanel"><div class="action-buttons"><button type="button" class="action-btn" onclick="showAddCurrencyModal()"><i class="fas fa-plus"></i>إضافة عملة جديدة </button><button type="button" class="action-btn" onclick="loadCurrencies()"><i class="fas fa-sync"></i>تحديث البيانات </button><button type="button" class="action-btn" onclick="importCurrencies()"><i class="fas fa-download"></i>استيراد عملات </button><button type="button" class="action-btn" onclick="exportCurrencies()"><i class="fas fa-upload"></i>تصدير العملات </button></div><div class="data-table"><table class="table"><thead><tr><th>العلم</th><th>رمز العملة</th><th>اسم العملة</th><th>الرمز</th><th>العملة الأساسية</th><th>الحالة</th><th>آخر تحديث</th><th>الإجراءات</th></tr></thead><tbody id="currenciesTableBody"><tr><td colspan="8" class="text-center"><div class="loading"><i class="fas fa-spinner"></i><p>جاري تحميل البيانات...</p></div></td></tr></tbody></table></div></div><!-- تعليق --><div class="tab-pane fade" id="exchange-rates" role="tabpanel"><div class="action-buttons"><button type="button" class="action-btn" onclick="showAddExchangeRateModal()"><i class="fas fa-plus"></i>إضافة سعر صرف </button><button type="button" class="action-btn" onclick="updateAllRates()"><i class="fas fa-sync"></i>تحديث جميع الأسعار </button><button type="button" class="action-btn" onclick="showBulkUpdateModal()"><i class="fas fa-edit"></i>تحديث مجمع </button></div><div class="row" id="exchangeRatesGrid"><!-- تعليق --></div></div><!-- تعليق --><div class="tab-pane fade" id="rate-history" role="tabpanel"><div class="form-container"><h5><i class="fas fa-filter me-2"></i>فلاتر التاريخ</h5><div class="row"><div class="col-md-3"><label class="form-label">من العملة</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="historyFromCurrency"><option value="">اختر العملة</option></select></div><div class="col-md-3"><label class="form-label">إلى العملة</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="historyToCurrency"><option value="">اختر العملة</option></select></div><div class="col-md-2"><label class="form-label">من تاريخ</label><input type="date" class="form-control" id="historyStartDate"></div><div class="col-md-2"><label class="form-label">إلى تاريخ</label><input type="date" class="form-control" id="historyEndDate"></div><div class="col-md-2 d-flex align-items-end"><button type="button" class="btn btn-primary w-100" onclick="loadRateHistory()"><i class="fas fa-search"></i>بحث </button></div></div></div><div class="rate-history"><h5><i class="fas fa-chart-line me-2"></i>رسم بياني لتاريخ الأسعار</h5><div class="rate-history-chart"><canvas id="rateHistoryChart"></canvas></div></div><div class="data-table"><table class="table"><thead><tr><th>التاريخ</th><th>من العملة</th><th>إلى العملة</th><th>السعر</th><th>التغيير</th><th>المصدر</th></tr></thead><tbody id="rateHistoryTableBody"><tr><td colspan="6" class="text-center"><div class="empty-state"><i class="fas fa-chart-line"></i><p>اختر العملات والفترة الزمنية لعرض التاريخ</p></div></td></tr></tbody></table></div></div><!-- تعليق --><div class="tab-pane fade" id="settings" role="tabpanel"><div class="form-container"><h5><i class="fas fa-cog me-2"></i>إعدادات العملات</h5><div class="row"><div class="col-md-6"><div class="form-group"><label class="form-label">العملة الأساسية للنظام</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="systemBaseCurrency"><option value="">اختر العملة الأساسية</option></select><small class="form-text text-muted">العملة التي سيتم عرض جميع التقارير بها</small></div></div><div class="col-md-6"><div class="form-group"><label class="form-label">دقة الأسعار (عدد الخانات العشرية)</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="ratePrecision"><option value="2">2 خانات</option><option value="4">4 خانات</option><option value="6">6 خانات</option><option value="8">8 خانات</option></select></div></div></div><div class="row"><div class="col-md-6"><div class="form-group"><label class="form-label">مصدر أسعار الصرف التلقائي</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="rateSource"><option value="manual">يدوي</option><option value="central_bank">البنك المركزي</option><option value="commercial_bank">البنوك التجارية</option><option value="api">API خارجي</option></select></div></div><div class="col-md-6"><div class="form-group"><label class="form-label">تكرار التحديث التلقائي</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="updateFrequency"><option value="manual">يدوي</option><option value="hourly">كل ساعة</option><option value="daily">يومياً</option><option value="weekly">أسبوعياً</option></select></div></div></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="allowNegativeRates"><label class="form-check-label" for="allowNegativeRates"> السماح بأسعار الصرف السالبة </label></div><div class="form-check mb-3"><input class="form-check-input" type="checkbox" id="enableRateAlerts"><label class="form-check-label" for="enableRateAlerts"> تفعيل تنبيهات تغيير أسعار الصرف </label></div><div class="form-group"><label class="form-label">حد التنبيه لتغيير السعر (%)</label><input type="number" placeholder="أدخل رقم" class="form-control" id="alertThreshold" placeholder="5" step="0.1" aria-label="حقل رقم"><small class="form-text text-muted">سيتم إرسال تنبيه عند تغيير السعر بهذه النسبة أو أكثر</small></div><button type="button" class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-save me-2"></i>حفظ الإعدادات </button></div></div></div></div></div><!-- تعليق --><div class="modal fade" id="addCurrencyModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">إضافة عملة جديدة</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق" title="إغلاق النافذة" ></button></div><div class="modal-body"><form id="addCurrencyForm"><div class="row"><div class="col-md-6"><div class="form-group"><label class="form-label">رمز العملة (ISO 4217)</label><input type="text" placeholder="أدخل النص" class="form-control" id="currencyCode" maxlength="3" placeholder="USD" required aria-label="حقل نص"><small class="form-text text-muted">مثال: USD, EUR, EGP</small></div></div><div class="col-md-6"><div class="form-group"><label class="form-label">اسم العملة</label><input type="text" placeholder="أدخل النص" class="form-control" id="currencyName" placeholder="الدولار الأمريكي" required aria-label="حقل نص"></div></div></div><div class="row"><div class="col-md-6"><div class="form-group"><label class="form-label">رمز العملة</label><input type="text" placeholder="أدخل النص" class="form-control" id="currencySymbol" maxlength="5" placeholder="$" required aria-label="حقل نص"></div></div><div class="col-md-6"><div class="form-group"><label class="form-label">الدولة</label><input type="text" placeholder="أدخل النص" class="form-control" id="currencyCountry" placeholder="الولايات المتحدة" aria-label="حقل نص"></div></div></div><div class="row"><div class="col-md-6"><div class="form-check"><input class="form-check-input" type="checkbox" id="isBaseCurrency"><label class="form-check-label" for="isBaseCurrency"> العملة الأساسية للنظام </label></div></div><div class="col-md-6"><div class="form-check"><input class="form-check-input" type="checkbox" id="isActive" checked><label class="form-check-label" for="isActive"> عملة نشطة </label></div></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" class="btn btn-primary" onclick="addCurrency()">إضافة العملة</button></div></div></div></div><!-- تعليق --><div class="modal fade" id="addExchangeRateModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">إضافة سعر صرف جديد</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق" title="إغلاق النافذة" ></button></div><div class="modal-body"><form id="addExchangeRateForm"><div class="row"><div class="col-md-6"><div class="form-group"><label class="form-label">من العملة</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="fromCurrencyRate" required><option value="">اختر العملة</option></select></div></div><div class="col-md-6"><div class="form-group"><label class="form-label">إلى العملة</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="toCurrencyRate" required><option value="">اختر العملة</option></select></div></div></div><div class="form-group"><label class="form-label">سعر الصرف</label><input type="number" placeholder="أدخل رقم" class="form-control" id="exchangeRate" step="0.000001" placeholder="1.0000" required aria-label="حقل رقم"><small class="form-text text-muted">كم وحدة من العملة الثانية تساوي وحدة واحدة من العملة الأولى</small></div><div class="form-group"><label class="form-label">تاريخ السريان</label><input type="date" class="form-control" id="effectiveDate" required></div><div class="form-group"><label class="form-label">المصدر</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="rateSourceSelect"><option value="manual">يدوي</option><option value="central_bank">البنك المركزي</option><option value="commercial_bank">بنك تجاري</option><option value="api">API خارجي</option></select></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" class="btn btn-primary" onclick="addExchangeRate()">إضافة السعر</button></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script><script src="js/navigation.js"></script><script> // متغيرات عامة let currentUser = null; let authToken = localStorage.getItem('authToken'); let currencies = []; let exchangeRates = []; let rateHistoryChart = null; // التحقق من تسجيل الدخول if (!authToken) { window.location.href = 'index.html'; } // تحميل البيانات عند تحميل الصفحة document.addEventListener('DOMContentLoaded', function() { loadCurrencies(); loadExchangeRates(); setDefaultDates(); initializeRateHistoryChart(); }); // تحميل العملات async function loadCurrencies() { try { const response = await fetch('/api/accounting/currencies', { headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } }); if (response.ok) { const data = await response.json(); currencies = data.currencies; displayCurrencies(currencies); populateCurrencySelects(); } else { throw new Error('خطأ في تحميل العملات'); } } catch (error) { console.error('خطأ في تحميل العملات:', error); showError('خطأ في تحميل العملات'); } } // عرض العملات في الجدول function displayCurrencies(currenciesList) { const tbody = document.getElementById('currenciesTableBody'); if (currenciesList.length === 0) { tbody.innerHTML = ` <tr><td colspan="8" class="text-center"><div class="empty-state"><i class="fas fa-coins"></i><p>لا توجد عملات مسجلة</p></div></td></tr> `; return; } tbody.innerHTML = currenciesList.map(currency => ` <tr><td><div class="currency-flag" style="background-image: url('https://flagcdn.com/24x18/${getCurrencyFlag(currency.code)}.png')"></div></td><td><strong>${currency.code}</strong></td><td>${currency.name}</td><td><strong>${currency.symbol}</strong></td><td> ${currency.is_base_currency ? '<span class="status-badge status-base">نعم</span>' : '<span class="status-badge status-inactive">لا</span>' } </td><td> ${currency.is_active ? '<span class="status-badge status-active">نشط</span>' : '<span class="status-badge status-inactive">غير نشط</span>' } </td><td>${formatDate(currency.updated_at)}</td><td><button type="button" class="btn btn-info btn-sm" onclick="editCurrency(${currency.id})" title="تعديل"><i class="fas fa-edit"></i></button><button type="button" class="btn btn-success btn-sm" onclick="toggleCurrencyStatus(${currency.id})" title="تغيير الحالة"><i class="fas fa-toggle-${currency.is_active ? 'on' : 'off'}"></i></button> ${!currency.is_base_currency ? `<button type="button" class="btn btn-danger btn-sm" onclick="deleteCurrency(${currency.id})" title="حذف"><i class="fas fa-trash"></i></button>` : '' } </td></tr> `).join(''); } // تحميل أسعار الصرف async function loadExchangeRates() { try { const response = await fetch('/api/accounting/exchange-rates', { headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } }); if (response.ok) { const data = await response.json(); exchangeRates = data.rates; displayExchangeRates(exchangeRates); } else { throw new Error('خطأ في تحميل أسعار الصرف'); } } catch (error) { console.error('خطأ في تحميل أسعار الصرف:', error); showError('خطأ في تحميل أسعار الصرف'); } } // عرض أسعار الصرف function displayExchangeRates(rates) { const grid = document.getElementById('exchangeRatesGrid'); if (rates.length === 0) { grid.innerHTML = ` <div class="col-12"><div class="empty-state"><i class="fas fa-exchange-alt"></i><p>لا توجد أسعار صرف مسجلة</p></div></div> `; return; } grid.innerHTML = rates.map(rate => { const change = calculateRateChange(rate); return ` <div class="col-md-6 col-lg-4 mb-3"><div class="exchange-rate-card"><div class="rate-header"><div class="currency-pair"> ${rate.from_currency_code} / ${rate.to_currency_code} </div><div class="rate-value"> ${formatRate(rate.rate)} </div></div><div class="rate-change ${change.class}"><i class="fas fa-${change.icon}"></i> ${change.text} </div><div class="rate-details"><div class="rate-detail"><div class="rate-detail-label"> آخر تحديث </div><div class="rate-detail-value"> ${formatDate(rate.effective_date)} </div></div><div class="rate-detail"><div class="rate-detail-label"> المصدر </div><div class="rate-detail-value"> ${getRateSourceText(rate.source)} </div></div></div><div class="mt-3"><button type="button" class="btn btn-info btn-sm" onclick="editExchangeRate(${rate.id})"><i class="fas fa-edit"></i> تعديل </button><button type="button" class="btn btn-success btn-sm" onclick="updateSingleRate(${rate.id})"><i class="fas fa-sync"></i> تحديث </button></div></div></div> `; }).join(''); } // ملء قوائم العملات function populateCurrencySelects() { const selects = [ 'fromCurrency', 'toCurrency', 'fromCurrencyRate', 'toCurrencyRate', 'historyFromCurrency', 'historyToCurrency', 'systemBaseCurrency' ]; selects.forEach(selectId => { const select = document.getElementById(selectId); if (select) { const currentValue = select.value; const firstOption = select.querySelector('option'); select.innerHTML = ''; if (firstOption) select.appendChild(firstOption); currencies.forEach(currency => { const option = document.createElement('option'); option.value = selectId.includes('Rate') || selectId.includes('history') || selectId.includes('system') ? currency.id : currency.code; option.textContent = `${currency.name} (${currency.code})`; select.appendChild(option); }); select.value = currentValue; } }); } // تحويل العملات async function convertCurrency() { const amount = document.getElementById('convertAmount').value; const fromCurrency = document.getElementById('fromCurrency').value; const toCurrency = document.getElementById('toCurrency').value; const resultDiv = document.getElementById('conversionResult'); if (!amount || !fromCurrency || !toCurrency) { resultDiv.innerHTML = 'يرجى إدخال جميع البيانات المطلوبة'; return; } if (fromCurrency === toCurrency) { resultDiv.innerHTML = `${formatNumber(amount)} ${fromCurrency} = ${formatNumber(amount)} ${toCurrency}`; return; } try { const response = await fetch(`/api/accounting/convert-currency?from=${fromCurrency}&to=${toCurrency}&amount=${amount}`, { headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } }); if (response.ok) { const data = await response.json(); resultDiv.innerHTML = ` <div class="row"><div class="col-md-6"><strong>${formatNumber(amount)} ${fromCurrency}</strong></div><div class="col-md-6"><strong>${formatNumber(data.converted_amount)} ${toCurrency}</strong></div></div><div class="mt-2"><small>سعر الصرف: ${data.exchange_rate} | آخر تحديث: ${formatDate(data.rate_date)}</small></div> `; } else { resultDiv.innerHTML = 'خطأ في التحويل - تحقق من أسعار الصرف'; } } catch (error) { console.error('خطأ في تحويل العملة:', error); resultDiv.innerHTML = 'خطأ في الاتصال بالخادم'; } } // إضافة عملة جديدة function showAddCurrencyModal() { const modal = new bootstrap.Modal(document.getElementById('addCurrencyModal')); document.getElementById('addCurrencyForm').reset(); modal.show(); } async function addCurrency() { const form = document.getElementById('addCurrencyForm'); const currencyData = { code: document.getElementById('currencyCode').value.toUpperCase(), name: document.getElementById('currencyName').value, symbol: document.getElementById('currencySymbol').value, country: document.getElementById('currencyCountry').value, is_base_currency: document.getElementById('isBaseCurrency').checked, is_active: document.getElementById('isActive').checked }; try { const response = await fetch('/api/accounting/currencies', { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(currencyData) }); if (response.ok) { showSuccess('تم إضافة العملة بنجاح'); bootstrap.Modal.getInstance(document.getElementById('addCurrencyModal')).hide(); form.reset(); loadCurrencies(); } else { const error = await response.json(); showError(error.error || 'خطأ في إضافة العملة'); } } catch (error) { console.error('خطأ في إضافة العملة:', error); showError('خطأ في الاتصال بالخادم'); } } // إضافة سعر صرف جديد function showAddExchangeRateModal() { const modal = new bootstrap.Modal(document.getElementById('addExchangeRateModal')); document.getElementById('addExchangeRateForm').reset(); document.getElementById('effectiveDate').value = new Date().toISOString().split('T')[0]; modal.show(); } async function addExchangeRate() { const rateData = { from_currency_id: document.getElementById('fromCurrencyRate').value, to_currency_id: document.getElementById('toCurrencyRate').value, rate: document.getElementById('exchangeRate').value, effective_date: document.getElementById('effectiveDate').value, source: document.getElementById('rateSourceSelect').value }; try { const response = await fetch('/api/accounting/exchange-rates', { method: 'POST', headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(rateData) }); if (response.ok) { showSuccess('تم إضافة سعر الصرف بنجاح'); bootstrap.Modal.getInstance(document.getElementById('addExchangeRateModal')).hide(); document.getElementById('addExchangeRateForm').reset(); loadExchangeRates(); } else { const error = await response.json(); showError(error.error || 'خطأ في إضافة سعر الصرف'); } } catch (error) { console.error('خطأ في إضافة سعر الصرف:', error); showError('خطأ في الاتصال بالخادم'); } } // تحميل تاريخ الأسعار async function loadRateHistory() { const fromCurrency = document.getElementById('historyFromCurrency').value; const toCurrency = document.getElementById('historyToCurrency').value; const startDate = document.getElementById('historyStartDate').value; const endDate = document.getElementById('historyEndDate').value; if (!fromCurrency || !toCurrency || !startDate || !endDate) { showError('يرجى تحديد جميع الفلاتر'); return; } try { const response = await fetch(`/api/accounting/exchange-rates/history?from_currency_id=${fromCurrency}&to_currency_id=${toCurrency}&start_date=${startDate}&end_date=${endDate}`, { headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' } }); if (response.ok) { const data = await response.json(); displayRateHistory(data.history); updateRateHistoryChart(data.history); } else { throw new Error('خطأ في تحميل تاريخ الأسعار'); } } catch (error) { console.error('خطأ في تحميل تاريخ الأسعار:', error); showError('خطأ في تحميل تاريخ الأسعار'); } } // عرض تاريخ الأسعار function displayRateHistory(history) { const tbody = document.getElementById('rateHistoryTableBody'); if (history.length === 0) { tbody.innerHTML = ` <tr><td colspan="6" class="text-center"><div class="empty-state"><i class="fas fa-chart-line"></i><p>لا توجد بيانات تاريخية للفترة المحددة</p></div></td></tr> `; return; } tbody.innerHTML = history.map((record, index) => { const change = index > 0 ? calculateHistoryChange(record.rate, history[index - 1].rate) : null; return ` <tr><td>${formatDate(record.effective_date)}</td><td>${record.from_currency_code}</td><td>${record.to_currency_code}</td><td><strong>${formatRate(record.rate)}</strong></td><td> ${change ? `<span class="rate-change ${change.class}"><i class="fas fa-${change.icon}"></i> ${change.text} </span>` : '<span class="text-muted">-</span>' } </td><td>${getRateSourceText(record.source)}</td></tr> `; }).join(''); } // تهيئة رسم تاريخ الأسعار function initializeRateHistoryChart() { const ctx = document.getElementById('rateHistoryChart').getContext('2d'); rateHistoryChart = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [{ label: 'سعر الصرف', data: [], borderColor: '#667eea', backgroundColor: 'rgba(102, 126, 234, 0.1)', tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } } }); } // تحديث رسم تاريخ الأسعار function updateRateHistoryChart(history) { if (rateHistoryChart) { rateHistoryChart.data.labels = history.map(record => formatDate(record.effective_date)); rateHistoryChart.data.datasets[0].data = history.map(record => record.rate); rateHistoryChart.update(); } } // دوال مساعدة function getCurrencyFlag(currencyCode) { const flagMap = { 'USD': 'us', 'EUR': 'eu', 'EGP': 'eg', 'SAR': 'sa', 'AED': 'ae', 'GBP': 'gb', 'JPY': 'jp', 'CNY': 'cn' }; return flagMap[currencyCode] || 'xx'; } function formatRate(rate) { return parseFloat(rate).toFixed(6); } function formatNumber(number) { return new Intl.NumberFormat('ar-EG').format(number || 0); } function formatDate(dateString) { if (!dateString) return ''; return new Date(dateString).toLocaleDateString('ar-EG'); } function getRateSourceText(source) { const sources = { 'manual': 'يدوي', 'central_bank': 'البنك المركزي', 'commercial_bank': 'بنك تجاري', 'api': 'API خارجي' }; return sources[source] || source; } function calculateRateChange(rate) { // هذا مثال - يجب تطبيق المنطق الفعلي للمقارنة مع السعر السابق const change = Math.random() * 4 - 2; // تغيير عشوائي للمثال if (change > 0) { return { text: `+${change.toFixed(2)}%`, class: 'positive', icon: 'arrow-up' }; } else if (change < 0) { return { text: `${change.toFixed(2)}%`, class: 'negative', icon: 'arrow-down' }; } else { return { text: '0%', class: 'neutral', icon: 'minus' }; } } function calculateHistoryChange(currentRate, previousRate) { const change = ((currentRate - previousRate) / previousRate) * 100; if (change > 0) { return { text: `+${change.toFixed(2)}%`, class: 'positive', icon: 'arrow-up' }; } else if (change < 0) { return { text: `${change.toFixed(2)}%`, class: 'negative', icon: 'arrow-down' }; } else { return { text: '0%', class: 'neutral', icon: 'minus' }; } } function setDefaultDates() { const today = new Date(); const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate()); document.getElementById('historyStartDate').value = lastMonth.toISOString().split('T')[0]; document.getElementById('historyEndDate').value = today.toISOString().split('T')[0]; } // دوال أخرى (يمكن تطويرها لاحقاً) function editCurrency(id) { console.log('تعديل العملة:', id); } function deleteCurrency(id) { console.log('حذف العملة:', id); } function toggleCurrencyStatus(id) { console.log('تغيير حالة العملة:', id); } function editExchangeRate(id) { console.log('تعديل سعر الصرف:', id); } function updateSingleRate(id) { console.log('تحديث سعر واحد:', id); } function updateAllRates() { console.log('تحديث جميع الأسعار'); } function showBulkUpdateModal() { console.log('تحديث مجمع'); } function importCurrencies() { console.log('استيراد عملات'); } function exportCurrencies() { console.log('تصدير عملات'); } function saveSettings() { console.log('حفظ الإعدادات'); } // دوال الرسائل function showSuccess(message) { alert('نجح: ' + message); } function showError(message) { alert('خطأ: ' + message); } function logout() { localStorage.removeItem('authToken'); window.location.href = 'index.html'; } </script></body></html>