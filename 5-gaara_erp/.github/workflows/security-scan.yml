# FILE: .github/workflows/security-scan.yml | PURPOSE: CI/CD Secret Scanning | OWNER: Security Team | RELATED: .secrets.baseline | LAST-AUDITED: 2025-11-19

name: Security Scan

on:
  push:
    branches: [ main, develop, staging ]
  pull_request:
    branches: [ main, develop, staging ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  secret-scan:
    name: Secret Detection Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better detection
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install detect-secrets
      run: |
        pip install detect-secrets==1.5.0
    
    - name: Run secret scan
      run: |
        # Scan for secrets and compare with baseline
        detect-secrets scan --baseline .secrets.baseline
        
        # Audit the baseline (check for new secrets)
        detect-secrets audit .secrets.baseline
    
    - name: Check for new secrets
      run: |
        # This will fail if new secrets are detected
        python -m detect_secrets scan --baseline .secrets.baseline --fail-on-unaudited
    
    - name: Upload scan results
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: secret-scan-results
        path: .secrets.baseline
        retention-days: 30

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd gaara_erp
        pip install -r requirements.txt
    
    - name: Run safety check
      run: |
        pip install safety
        safety check --json --output safety-report.json || true
    
    - name: Upload safety report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: safety-report
        path: safety-report.json
        retention-days: 30

  code-quality:
    name: Code Quality & Security Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install linting tools
      run: |
        pip install bandit flake8 pylint
    
    - name: Run Bandit (Security Linter)
      run: |
        bandit -r gaara_erp/ -f json -o bandit-report.json || true
    
    - name: Run Flake8
      run: |
        flake8 gaara_erp/ --max-line-length=120 --exclude=migrations,__pycache__,.venv --output-file=flake8-report.txt || true
    
    - name: Upload reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: code-quality-reports
        path: |
          bandit-report.json
          flake8-report.txt
        retention-days: 30

  security-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs: [secret-scan, dependency-scan, code-quality]
    if: always()
    
    steps:
    - name: Check scan results
      run: |
        echo "Security scans completed!"
        echo "- Secret scan: ${{ needs.secret-scan.result }}"
        echo "- Dependency scan: ${{ needs.dependency-scan.result }}"
        echo "- Code quality: ${{ needs.code-quality.result }}"
        
        if [ "${{ needs.secret-scan.result }}" == "failure" ]; then
          echo "❌ Secret scan failed! New secrets detected."
          exit 1
        fi
        
        echo "✅ All security scans passed!"

