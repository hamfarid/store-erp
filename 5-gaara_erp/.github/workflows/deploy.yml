# FILE: .github/workflows/deploy.yml | PURPOSE: Auto deployment (dev→staging→prod) | OWNER: DevOps | RELATED: docs/Runbook.md | LAST-AUDITED: 2025-10-21

name: Deploy (Dev → Staging → Production)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths-ignore:
      - "**.md"
      - "docs/**"

permissions:
  contents: read
  deployments: write
  id-token: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  APP_NAME: gaara-store
  ARTIFACT_NAME: build-artifacts
  NODE_VERSION: "20.19.0"
  PYTHON_VERSION: "3.11"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node (Frontend)
        if: ${{ hashFiles('frontend/package.json') != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install Frontend deps
        if: ${{ hashFiles('frontend/package.json') != '' }}
        working-directory: frontend
        run: npm ci || npm i --no-audit --no-fund

      - name: Build Frontend
        if: ${{ hashFiles('frontend/package.json') != '' }}
        working-directory: frontend
        run: npm run build --if-present

      - name: Setup Python
        if: ${{ hashFiles('**/requirements.txt','**/pyproject.toml') != '' }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python deps
        if: ${{ hashFiles('**/requirements.txt') != '' }}
        run: pip install -r requirements.txt

      - name: Build BE (if applicable)
        if: ${{ hashFiles('**/pyproject.toml') != '' }}
        run: python -m compileall .

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            dist/**
            build/**
            .next/**
            out/**
            **/*.tar.gz
            **/*.whl
            !**/node_modules/**
            !**/.venv/**
          if-no-files-found: ignore

  deploy_dev:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: development
      url: ${{ steps.out.outputs.url }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}

      - name: Deploy to Dev
        run: |
          echo "Deploying to DEV environment..."
          # Add actual deployment commands here
          # Example: scp, rsync, kubectl, terraform apply, etc.

      - name: Output Dev URL
        id: out
        run: echo "url=https://dev.gaaragroup.com" >> $GITHUB_OUTPUT

  deploy_staging:
    needs: deploy_dev
    runs-on: ubuntu-latest
    environment:
      name: staging-env
      url: ${{ steps.out.outputs.url }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}

      - name: Deploy to Staging
        run: |
          echo "Deploying to STAGING environment..."
          # Add actual deployment commands here

      - name: Output Staging URL
        id: out
        run: echo "url=https://staging.gaaragroup.com" >> $GITHUB_OUTPUT

  deploy_prod:
    needs: deploy_staging
    runs-on: ubuntu-latest
    environment:
      name: production-env
      url: ${{ steps.out.outputs.url }}
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}

      - name: Preflight Checks
        run: |
          echo "All CI gates must have passed already."
          echo "Verifying security scans, tests, and SBOM..."

      - name: Deploy to Production (HTTPS + HSTS enforced)
        run: |
          echo "Deploying to PRODUCTION environment..."
          # Add actual deployment commands here
          # Ensure HTTPS is enforced and HSTS headers are set

      - name: Output Prod URL
        id: out
        run: echo "url=https://app.gaaragroup.com" >> $GITHUB_OUTPUT

      - name: Post-Deployment Health Check
        run: |
          echo "Running health checks..."
          # curl -f https://app.gaaragroup.com/api/health || exit 1

