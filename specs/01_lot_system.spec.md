# ðŸ“‹ Spec: Ù†Ø¸Ø§Ù… Lot Ø§Ù„Ù…ØªÙ‚Ø¯Ù… | Advanced Lot System

**Version:** 2.0.0
**Date:** 2026-01-16
**Role:** The Architect
**Status:** âœ… Approved
**Priority:** â­â­â­ Critical

---

## 1. Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© | Overview

Ù†Ø¸Ø§Ù… Ù…ØªÙ‚Ø¯Ù… Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù„ÙˆØªØ§Øª (Lots) Ù…ØµÙ…Ù… Ø®ØµÙŠØµØ§Ù‹ Ù„Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø¨Ø°ÙˆØ± ÙˆØ§Ù„Ø£Ø³Ù…Ø¯Ø© ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ©. ÙŠÙˆÙØ± ØªØªØ¨Ø¹Ø§Ù‹ Ø´Ø§Ù…Ù„Ø§Ù‹ Ù„Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„ÙƒÙ…ÙŠØ© ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ø¹ Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ²Ø§Ø±ÙŠØ©.

---

## 2. Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ¸ÙŠÙÙŠØ© | Functional Requirements

### 2.1 Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„ÙˆØªØ§Øª | Lot Management
- [ ] FR-001: Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØª Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ 50+ Ø­Ù‚Ù„ Ù…ØªØ®ØµØµ
- [ ] FR-002: ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„ÙˆØª
- [ ] FR-003: Ø­Ø°Ù Ø§Ù„Ù„ÙˆØª (soft delete)
- [ ] FR-004: Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„ÙˆØªØ§Øª Ù…Ø¹ ÙÙ„ØªØ±Ø© ÙˆØªØ±ØªÙŠØ¨
- [ ] FR-005: Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù„ÙˆØªØ§Øª

### 2.2 ØªØªØ¨Ø¹ Ø§Ù„Ø¬ÙˆØ¯Ø© | Quality Tracking
- [ ] FR-006: ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù†Ø¨Ø§Øª (Germination Rate)
- [ ] FR-007: ØªØ³Ø¬ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ù‚Ø§Ø¡ (Purity Rate)
- [ ] FR-008: ØªØ³Ø¬ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø·ÙˆØ¨Ø© (Moisture Content)
- [ ] FR-009: ØªØ§Ø±ÙŠØ® ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø©
- [ ] FR-010: Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø©

### 2.3 Ø§Ù„Ù„ÙˆØªØ§Øª Ø§Ù„ÙˆØ²Ø§Ø±ÙŠØ© | Ministry Lots
- [ ] FR-011: Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„ÙˆØ²Ø§Ø±ÙŠØ©
- [ ] FR-012: ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
- [ ] FR-013: ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
- [ ] FR-014: Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© (Ø§Ø³ØªÙŠØ±Ø§Ø¯ØŒ Ù…Ø­Ù„ÙŠØŒ ØªØµØ¯ÙŠØ±)
- [ ] FR-015: Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„ÙˆØ²Ø§Ø±ÙŠØ©

### 2.4 Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù„ÙˆØª | Lot States
- [ ] FR-016: Ù…ØªØ§Ø­ (AVAILABLE) - Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨ÙŠØ¹
- [ ] FR-017: Ù…Ø­Ø¬ÙˆØ² (RESERVED) - Ù…Ø­Ø¬ÙˆØ² Ù„Ø·Ù„Ø¨ Ù…Ø¹ÙŠÙ†
- [ ] FR-018: Ù…Ø¨Ø§Ø¹ (SOLD) - ØªÙ… Ø¨ÙŠØ¹Ù‡ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
- [ ] FR-019: Ù…Ù†ØªÙ‡ÙŠ (EXPIRED) - Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØªÙ‡
- [ ] FR-020: Ù…Ø¹Ø·ÙˆØ¨ (DAMAGED) - ØªØ§Ù„Ù Ø£Ùˆ Ù…Ø¹ÙŠØ¨
- [ ] FR-021: Ù…Ø±ØªØ¬Ø¹ (RETURNED) - ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹Ù‡
- [ ] FR-022: Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (IN_REVIEW) - Ù‚ÙŠØ¯ Ø§Ù„ÙØ­Øµ
- [ ] FR-023: Ù…Ø­Ø¸ÙˆØ± (BLOCKED) - Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø§Ù„Ø¨ÙŠØ¹

### 2.5 Ø§Ø®ØªÙŠØ§Ø± FIFO/LIFO
- [ ] FR-024: Ø§Ø®ØªÙŠØ§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ FIFO (Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹)
- [ ] FR-025: Ø§Ø®ØªÙŠØ§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ LIFO (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
- [ ] FR-026: Ø§Ø®ØªÙŠØ§Ø± ÙŠØ¯ÙˆÙŠ Ù„Ù„ÙˆØª
- [ ] FR-027: ØªØ¬Ø§ÙˆØ² FIFO Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ© Ø®Ø§ØµØ©

### 2.6 ØªØªØ¨Ø¹ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ | Expiry Tracking
- [ ] FR-028: ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ 30 ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
- [ ] FR-029: ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ 7 Ø£ÙŠØ§Ù… Ù…Ù† Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
- [ ] FR-030: ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
- [ ] FR-031: Ø­Ø¸Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙƒÙˆÙŠÙ†)

### 2.7 Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª | Multi-Warehouse
- [ ] FR-032: ØªØªØ¨Ø¹ Ø§Ù„Ù„ÙˆØª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
- [ ] FR-033: Ù†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª
- [ ] FR-034: ØªÙ‚Ø§Ø±ÙŠØ± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹

---

## 3. Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù„ÙˆØª (50+ Ø­Ù‚Ù„) | Lot Fields

### 3.1 Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© | Basic Info
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| lot_number | String | âœ… | Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØª Ø§Ù„ÙØ±ÙŠØ¯ |
| product_id | FK | âœ… | Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ |
| supplier_id | FK | âœ… | Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙˆØ±Ø¯ |
| warehouse_id | FK | âœ… | Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ |
| purchase_order_id | FK | âŒ | Ù…Ø¹Ø±Ù Ø£Ù…Ø± Ø§Ù„Ø´Ø±Ø§Ø¡ |

### 3.2 Ø§Ù„ÙƒÙ…ÙŠØ§Øª | Quantities
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| initial_quantity | Decimal | âœ… | Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© |
| current_quantity | Decimal | âœ… | Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© |
| reserved_quantity | Decimal | âœ… | Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø© |
| sold_quantity | Decimal | âœ… | Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© |
| damaged_quantity | Decimal | âŒ | Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ØªØ§Ù„ÙØ© |
| unit_id | FK | âœ… | ÙˆØ­Ø¯Ø© Ø§Ù„Ù‚ÙŠØ§Ø³ |

### 3.3 Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® | Dates
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| manufacture_date | Date | âŒ | ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµÙ†ÙŠØ¹ |
| expiry_date | Date | âœ… | ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ |
| received_date | Date | âœ… | ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… |
| quality_check_date | Date | âŒ | ØªØ§Ø±ÙŠØ® ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø© |

### 3.4 Ø§Ù„Ø¬ÙˆØ¯Ø© | Quality
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| germination_rate | Decimal | âŒ | Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù†Ø¨Ø§Øª (%) |
| purity_rate | Decimal | âŒ | Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ù‚Ø§Ø¡ (%) |
| moisture_content | Decimal | âŒ | Ù†Ø³Ø¨Ø© Ø§Ù„Ø±Ø·ÙˆØ¨Ø© (%) |
| quality_grade | Enum | âŒ | Ø¯Ø±Ø¬Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© (A, B, C) |
| quality_notes | Text | âŒ | Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø© |

### 3.5 Ø§Ù„ÙˆØ²Ø§Ø±ÙŠØ© | Ministry
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| is_ministry_lot | Boolean | âœ… | Ù‡Ù„ Ù„ÙˆØª ÙˆØ²Ø§Ø±ÙŠ |
| ministry_approval_number | String | âŒ | Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© |
| ministry_approval_date | Date | âŒ | ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© |
| ministry_expiry_date | Date | âŒ | Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© |
| approval_type | Enum | âŒ | Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© |

### 3.6 Ø§Ù„ØªØ³Ø¹ÙŠØ± | Pricing
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| cost_price | Decimal | âœ… | Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© |
| selling_price | Decimal | âŒ | Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ |
| currency_id | FK | âœ… | Ø§Ù„Ø¹Ù…Ù„Ø© |

### 3.7 Ø§Ù„Ø­Ø§Ù„Ø© | Status
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| status | Enum | âœ… | Ø­Ø§Ù„Ø© Ø§Ù„Ù„ÙˆØª |
| is_active | Boolean | âœ… | Ù†Ø´Ø· |
| blocked_reason | Text | âŒ | Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø± |

---

## 4. API Endpoints

### 4.1 CRUD Operations
```
GET    /api/v1/lots              # List lots (with pagination, filter, sort)
GET    /api/v1/lots/{id}         # Get lot details
POST   /api/v1/lots              # Create new lot
PUT    /api/v1/lots/{id}         # Update lot
DELETE /api/v1/lots/{id}         # Soft delete lot
```

### 4.2 Special Operations
```
GET    /api/v1/lots/expiring                    # Get expiring lots
GET    /api/v1/lots/by-product/{product_id}     # Get lots by product
GET    /api/v1/lots/by-warehouse/{warehouse_id} # Get lots by warehouse
POST   /api/v1/lots/{id}/reserve                # Reserve quantity
POST   /api/v1/lots/{id}/release                # Release reservation
POST   /api/v1/lots/{id}/transfer               # Transfer to warehouse
GET    /api/v1/lots/fifo/{product_id}           # Get FIFO selection
POST   /api/v1/lots/{id}/quality-check          # Record quality check
```

---

## 5. Database Schema

```sql
CREATE TABLE lots (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    lot_number VARCHAR(50) UNIQUE NOT NULL,
    product_id INTEGER NOT NULL REFERENCES products(id),
    supplier_id INTEGER NOT NULL REFERENCES suppliers(id),
    warehouse_id INTEGER NOT NULL REFERENCES warehouses(id),
    purchase_order_id INTEGER REFERENCES purchase_orders(id),
    
    -- Quantities
    initial_quantity DECIMAL(15,4) NOT NULL DEFAULT 0,
    current_quantity DECIMAL(15,4) NOT NULL DEFAULT 0,
    reserved_quantity DECIMAL(15,4) NOT NULL DEFAULT 0,
    sold_quantity DECIMAL(15,4) NOT NULL DEFAULT 0,
    damaged_quantity DECIMAL(15,4) DEFAULT 0,
    unit_id INTEGER NOT NULL REFERENCES units(id),
    
    -- Dates
    manufacture_date DATE,
    expiry_date DATE NOT NULL,
    received_date DATE NOT NULL DEFAULT CURRENT_DATE,
    quality_check_date DATE,
    
    -- Quality
    germination_rate DECIMAL(5,2),
    purity_rate DECIMAL(5,2),
    moisture_content DECIMAL(5,2),
    quality_grade VARCHAR(1) CHECK (quality_grade IN ('A', 'B', 'C')),
    quality_notes TEXT,
    
    -- Ministry
    is_ministry_lot BOOLEAN DEFAULT FALSE,
    ministry_approval_number VARCHAR(50),
    ministry_approval_date DATE,
    ministry_expiry_date DATE,
    approval_type VARCHAR(20) CHECK (approval_type IN ('import', 'local', 'export')),
    
    -- Pricing
    cost_price DECIMAL(15,4) NOT NULL,
    selling_price DECIMAL(15,4),
    currency_id INTEGER NOT NULL REFERENCES currencies(id),
    
    -- Status
    status VARCHAR(20) NOT NULL DEFAULT 'available'
        CHECK (status IN ('available', 'reserved', 'sold', 'expired', 
                          'damaged', 'returned', 'in_review', 'blocked')),
    is_active BOOLEAN DEFAULT TRUE,
    blocked_reason TEXT,
    
    -- Audit
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER REFERENCES users(id),
    updated_by INTEGER REFERENCES users(id)
);

-- Indexes
CREATE INDEX idx_lots_product ON lots(product_id);
CREATE INDEX idx_lots_expiry ON lots(expiry_date);
CREATE INDEX idx_lots_status ON lots(status);
CREATE INDEX idx_lots_warehouse ON lots(warehouse_id);
CREATE INDEX idx_lots_fifo ON lots(product_id, expiry_date, received_date);
```

---

## 6. Business Rules

### 6.1 FIFO Selection
```python
def get_fifo_lots(product_id, quantity_needed):
    """
    Select lots using FIFO (First In First Out)
    Priority: expiry_date ASC, received_date ASC, id ASC
    """
    lots = Lot.query.filter(
        Lot.product_id == product_id,
        Lot.status == 'available',
        Lot.current_quantity > 0,
        Lot.expiry_date > datetime.now()
    ).order_by(
        Lot.expiry_date.asc(),
        Lot.received_date.asc(),
        Lot.id.asc()
    ).all()
    
    return select_lots_for_quantity(lots, quantity_needed)
```

### 6.2 Expiry Rules
- 30 days before: Warning notification
- 7 days before: Critical notification
- Expired: Auto-block (configurable)

---

## 7. Testing Requirements

### 7.1 Unit Tests
- [ ] Test lot creation with all fields
- [ ] Test lot status transitions
- [ ] Test FIFO selection algorithm
- [ ] Test quantity calculations
- [ ] Test expiry notifications

### 7.2 Integration Tests
- [ ] Test lot API endpoints
- [ ] Test lot-product relationship
- [ ] Test lot-warehouse transfer
- [ ] Test lot-POS integration

---

## 8. Security Considerations

### 8.1 Permissions Required
| Operation | Permission |
|-----------|------------|
| View lots | `lot.view` |
| Create lot | `lot.create` |
| Update lot | `lot.update` |
| Delete lot | `lot.delete` |
| Block lot | `lot.block` |
| Override FIFO | `lot.override_fifo` |

---

## 9. Related Files

- `backend/src/models/lot.py` - Lot model
- `backend/src/routes/lot_routes.py` - API routes
- `backend/src/services/lot_service.py` - Business logic
- `frontend/src/pages/lots/` - Lot pages
- `frontend/src/components/lots/` - Lot components

---

*Spec Status: âœ… Approved*
*Implementation: âœ… Complete*
