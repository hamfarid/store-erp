---
alwaysApply: true
description: Combined MCP research workflow - Exa, Speckit, Ref integration
globs:
  - "**/*"
---

# Research Workflow Rules v0.3

## ðŸš¨ CRITICAL: Date Verification

ALWAYS verify the current date before ANY MCP query:

```bash
# Run this FIRST
date +"%Y-%m-%d %H:%M:%S %Z"
```

Assume your internal date knowledge is WRONG. Always verify.
Attach verified date to queries for temporal relevance.

---

## Priority Hierarchy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PRIORITY 1: Exa MCP                                    â”‚
â”‚  â”œâ”€â”€ get_code_context_exa (FIRST)                      â”‚
â”‚  â””â”€â”€ web_search_exa (FALLBACK)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PRIORITY 2: Speckit MCP (for API work)                â”‚
â”‚  â”œâ”€â”€ speckit_search                                     â”‚
â”‚  â”œâ”€â”€ speckit_get_spec                                   â”‚
â”‚  â””â”€â”€ speckit_validate                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PRIORITY 3: Ref MCP (documentation verification)      â”‚
â”‚  â”œâ”€â”€ ref_search_documentation âœ…                        â”‚
â”‚  â”œâ”€â”€ ref_read_url âœ…                                    â”‚
â”‚  â”œâ”€â”€ search_docs âŒ PROHIBITED                          â”‚
â”‚  â””â”€â”€ my_docs âŒ PROHIBITED                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Decision Flowchart

```
START
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Verify System Date  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Is this code/impl   â”‚
â”‚ related?            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”œâ”€â”€ YES â”€â”€â–¶ get_code_context_exa
  â”‚             â”‚
  â”‚             â”œâ”€â”€ Results Good? â”€â”€â–¶ USE RESULTS
  â”‚             â”‚
  â”‚             â””â”€â”€ Results Bad? â”€â”€â–¶ web_search_exa
  â”‚                                    â”‚
  â”‚                                    â”œâ”€â”€ Results Good? â”€â”€â–¶ USE RESULTS
  â”‚                                    â”‚
  â”‚                                    â””â”€â”€ Results Bad? â”€â”€â–¶ Continue below
  â”‚
  â””â”€â”€ NO
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Is this REST API    â”‚
â”‚ related?            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”œâ”€â”€ YES â”€â”€â–¶ speckit_search â†’ speckit_get_spec
  â”‚             â”‚
  â”‚             â””â”€â”€ Need validation? â”€â”€â–¶ speckit_validate
  â”‚
  â””â”€â”€ NO
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ref Trigger Check:  â”‚
â”‚ â€¢ User requests?    â”‚
â”‚ â€¢ Results conflict? â”‚
â”‚ â€¢ 2+ failed fixes?  â”‚
â”‚ â€¢ Doc drift likely? â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â”œâ”€â”€ ANY YES â”€â”€â–¶ ref_search_documentation
  â”‚                  â”‚
  â”‚                  â””â”€â”€ Need specific page? â”€â”€â–¶ ref_read_url
  â”‚
  â””â”€â”€ ALL NO â”€â”€â–¶ Retry Exa with refined query
```

---

## Query Templates

### Exa: Code Context
```
[library] [version] [feature] [language] implementation example [year]
```

### Exa: Web Search
```
[topic] [specific aspect] [version] [year] best practices
```

### Speckit: API Search
```
[service] [API type] [version]
```

### Ref: Documentation
```
[library/framework] [version] [topic] official documentation
```

---

## Operational Steps

### Step 1: Pre-Research
```
1. Verify system date
2. Identify query type (code/API/docs)
3. Determine library/framework versions
4. Prepare specific query terms
```

### Step 2: Primary Research (Exa)
```
1. Start with get_code_context_exa
2. Use precise, code-oriented query
3. Include version and language
4. Evaluate result relevance
```

### Step 3: Fallback Research (Exa)
```
If Step 2 insufficient:
1. Refine query terms
2. Use web_search_exa
3. Target authoritative sources
4. Cross-reference results
```

### Step 4: API Specification (Speckit)
```
If working with external APIs:
1. speckit_search for API discovery
2. speckit_get_spec for full docs
3. speckit_validate for debugging
```

### Step 5: Documentation Verification (Ref)
```
Only if triggers met:
1. ref_search_documentation
2. Include specific version
3. ref_read_url for primary sources
4. Extract authoritative details
```

### Step 6: Implementation
```
1. Apply research findings
2. Test implementation
3. Document sources in code
4. Note version dependencies
```

---

## Code Annotation Standard

When implementing based on MCP research:

```python
"""
Research Sources:
- Exa: [query used] â†’ [result summary]
- Speckit: [API spec ID] â†’ [endpoints used]  
- Ref: [doc URL] â†’ [key details]

Version Requirements:
- Library: [name] >= [version]
- API: [service] [version]

Date Verified: [YYYY-MM-DD]
Potential Drift: [areas that may change]
"""
```

---

## Error Recovery

### Contradictory Results
```
1. Note the contradiction
2. Check result timestamps
3. Use Ref for authoritative source
4. Prefer newer, official sources
5. Document uncertainty
```

### No Results Found
```
1. Broaden search terms
2. Try alternative terminology
3. Check spelling/naming
4. Verify feature exists in version
5. Consider version mismatch
```

### Integration Failures
```
1. Document exact error
2. Verify API/library version
3. speckit_validate if API issue
4. ref_search_documentation for updates
5. Check for breaking changes
```

---

## Quality Checklist

Before completing research:
- [ ] Date verified
- [ ] Exa tried first
- [ ] Version numbers included
- [ ] Results cross-referenced
- [ ] Sources documented
- [ ] Potential drift noted
