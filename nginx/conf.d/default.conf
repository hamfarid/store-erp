# ==============================================
# Nginx Configuration - Unified Entry Point
# ==============================================
# All projects accessible via port 80 with path-based routing
# Network: Ai_project
# Uses resolver for dynamic upstream resolution
# ==============================================

resolver 127.0.0.11 valid=10s ipv6=off;

# ===== Main Server Block =====
server {
    listen 80;
    server_name localhost;

    # Health check
    location /health {
        return 200 'Nginx proxy healthy\n';
        add_header Content-Type text/plain;
    }

    # ===== Project 1: Test Projects =====
    location /test/ {
        set $test_frontend test-frontend:1051;
        rewrite ^/test/(.*) /$1 break;
        proxy_pass http://$test_frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /test/api/ {
        set $test_backend test-backend:3001;
        rewrite ^/test/api/(.*) /api/$1 break;
        proxy_pass http://$test_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
    }

    # ===== Project 2: Gold Price Predictor =====
    location /gold/ {
        set $gold_frontend gold-price-predictor-frontend:2501;
        rewrite ^/gold/(.*) /$1 break;
        proxy_pass http://$gold_frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /gold/api/ {
        set $gold_backend gold-price-predictor-backend:2001;
        rewrite ^/gold/api/(.*) /api/$1 break;
        proxy_pass http://$gold_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
    }

    location /gold/ml/ {
        set $gold_ml gold-price-predictor-ml:2101;
        rewrite ^/gold/ml/(.*) /$1 break;
        proxy_pass http://$gold_ml;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /gold/ai/ {
        set $gold_ai gold-price-predictor-ai:2601;
        rewrite ^/gold/ai/(.*) /$1 break;
        proxy_pass http://$gold_ai;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ===== Project 3: Zakat =====
    location /zakat/ {
        set $zakat_frontend zakat_frontend:80;
        rewrite ^/zakat/(.*) /$1 break;
        proxy_pass http://$zakat_frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /zakat/api/ {
        set $zakat_backend zakat_backend:3001;
        rewrite ^/zakat/api/(.*) /api/$1 break;
        proxy_pass http://$zakat_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ===== Project 4: Scan AI =====
    location /scan/ {
        set $scan_frontend scan_ai-Manus-frontend:4501;
        rewrite ^/scan/(.*) /$1 break;
        proxy_pass http://$scan_frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /scan/api/ {
        set $scan_backend scan_ai-Manus-backend:4001;
        rewrite ^/scan/api/(.*) /api/$1 break;
        proxy_pass http://$scan_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /scan/ml/ {
        set $scan_ml scan_ai-Manus-ml:4101;
        rewrite ^/scan/ml/(.*) /$1 break;
        proxy_pass http://$scan_ml;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /scan/ai/ {
        set $scan_ai scan_ai-Manus-ai:4601;
        rewrite ^/scan/ai/(.*) /$1 break;
        proxy_pass http://$scan_ai;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ===== Project 5: Gaara ERP =====
    location /erp/ {
        set $erp_frontend gaara_frontend:80;
        rewrite ^/erp/(.*) /$1 break;
        proxy_pass http://$erp_frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /erp/api/ {
        set $erp_backend gaara_backend:8000;
        rewrite ^/erp/api/(.*) /api/$1 break;
        proxy_pass http://$erp_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ===== Project 6: Store =====
    location /store/ {
        set $store_frontend store_frontend:80;
        rewrite ^/store/(.*) /$1 break;
        proxy_pass http://$store_frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /store/api/ {
        set $store_backend store_backend:5000;
        rewrite ^/store/api/(.*) /api/$1 break;
        proxy_pass http://$store_backend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # ===== Portainer (Docker Management) =====
    location /portainer/ {
        set $portainer portainer:9000;
        rewrite ^/portainer/(.*) /$1 break;
        proxy_pass http://$portainer;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Default root - show available routes
    location / {
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html>
<head><title>AI Project Gateway</title>
<style>
body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; }
h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
h2 { color: #555; margin-top: 30px; }
ul { list-style-type: none; padding: 0; }
li { padding: 8px 0; }
a { color: #007bff; text-decoration: none; }
a:hover { text-decoration: underline; }
.project { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; }
.api { background: #e9ecef; padding: 10px 15px; margin: 5px 0; border-radius: 3px; font-family: monospace; }
.tools { background: #fff3cd; padding: 15px; margin: 10px 0; border-radius: 5px; }
</style>
</head>
<body>
<h1>üöÄ AI Project Gateway</h1>

<h2>üìÅ Projects:</h2>
<div class="project"><a href="/test/">1. Test Projects</a> - /test/ (Backend: 1001, Frontend: 1501)</div>
<div class="project"><a href="/gold/">2. Gold Price Predictor</a> - /gold/ (Backend: 2001, Frontend: 2501, ML: 2101, AI/RAG: 2601)</div>
<div class="project"><a href="/zakat/">3. Zakat System</a> - /zakat/ (Backend: 3001, Frontend: 3501)</div>
<div class="project"><a href="/scan/">4. Scan AI</a> - /scan/ (Backend: 4001, Frontend: 4501, ML: 4101, AI: 4601)</div>
<div class="project"><a href="/erp/">5. Gaara ERP</a> - /erp/ (Backend: 5001, Frontend: 5501)</div>
<div class="project"><a href="/store/">6. Store/Inventory</a> - /store/ (Backend: 6001, Frontend: 6501)</div>

<h2>üîå API Endpoints:</h2>
<div class="api">/test/api/ - Test Projects API</div>
<div class="api">/gold/api/ - Gold Price Predictor API</div>
<div class="api">/gold/ml/ - Gold ML Service</div>
<div class="api">/gold/ai/ - Gold AI/RAG Service</div>
<div class="api">/zakat/api/ - Zakat System API</div>
<div class="api">/scan/api/ - Scan AI API</div>
<div class="api">/scan/ml/ - Scan ML Service</div>
<div class="api">/scan/ai/ - Scan AI Service</div>
<div class="api">/erp/api/ - Gaara ERP API</div>
<div class="api">/store/api/ - Store API</div>

<h2>üõ†Ô∏è Tools:</h2>
<div class="tools"><a href="/portainer/">Portainer</a> - Docker Container Management (port 9000)</div>

</body>
</html>';
    }
}

# ===== Nginx Status/Config Server (Port 8181) =====
server {
    listen 8181;
    server_name localhost;

    # Nginx status page
    location /nginx_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        deny all;
    }

    # Configuration info
    location / {
        default_type text/html;
        return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Nginx Configuration - Port 8181</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #1a1a2e; color: #eee; }
        h1 { color: #00ff88; }
        .section { background: #16213e; padding: 20px; margin: 20px 0; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #333; }
        th { background: #0f3460; color: #00ff88; }
        .port { color: #00d4ff; font-weight: bold; }
        a { color: #00ff88; }
    </style>
</head>
<body>
    <h1>üîß Nginx Configuration Dashboard</h1>
    
    <div class="section">
        <h2>üìä Server Status</h2>
        <p><a href="/nginx_status">View Nginx Status</a></p>
    </div>

    <div class="section">
        <h2>üåê Port Assignments</h2>
        <table>
            <tr><th>Project</th><th>Backend</th><th>Frontend</th><th>Database</th><th>ML</th><th>AI/RAG</th><th>Redis</th></tr>
            <tr><td>Test</td><td class="port">1001</td><td class="port">1501</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
            <tr><td>Gold</td><td class="port">2001</td><td class="port">2501</td><td class="port">4502</td><td class="port">2101</td><td class="port">2601</td><td class="port">6372</td></tr>
            <tr><td>Zakat</td><td class="port">3001</td><td class="port">3501</td><td class="port">6502</td><td>-</td><td>-</td><td class="port">6373</td></tr>
            <tr><td>Scan AI</td><td class="port">4001</td><td class="port">4501</td><td class="port">8502</td><td class="port">4101</td><td class="port">4601</td><td class="port">6374</td></tr>
            <tr><td>ERP</td><td class="port">5001</td><td class="port">5501</td><td class="port">10502</td><td>-</td><td>-</td><td class="port">6375</td></tr>
            <tr><td>Store</td><td class="port">6001</td><td class="port">6501</td><td class="port">12502</td><td>-</td><td>-</td><td class="port">6376</td></tr>
        </table>
    </div>

    <div class="section">
        <h2>üîó Infrastructure</h2>
        <table>
            <tr><th>Service</th><th>Port</th><th>Purpose</th></tr>
            <tr><td>Nginx HTTP</td><td class="port">80</td><td>Main Proxy</td></tr>
            <tr><td>Nginx HTTPS</td><td class="port">443</td><td>Secure Proxy</td></tr>
            <tr><td>Nginx Config</td><td class="port">8181</td><td>This Dashboard</td></tr>
            <tr><td>Portainer HTTP</td><td class="port">9000</td><td>Docker UI</td></tr>
            <tr><td>Portainer HTTPS</td><td class="port">9443</td><td>Docker UI Secure</td></tr>
        </table>
    </div>

    <div class="section">
        <h2>üåç Localization</h2>
        <p>Timezone: <strong>Africa/Cairo</strong></p>
        <p>Language: <strong>Arabic (ar)</strong></p>
        <p>Currency: <strong>EGP</strong></p>
    </div>
</body>
</html>';
    }
}
