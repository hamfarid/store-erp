<!-- ملف: /home/ubuntu/complete_inventory_system/backend/src/static/batch_management.html --><!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>إدارة اللوطات المتقدمة</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"><link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"><link href="css/navigation.css" rel="stylesheet"><style> :root { --primary-color: #2c5aa0; --secondary-color: #f8f9fa; --success-color: #28a745; --warning-color: #ffc107; --danger-color: #dc3545; --info-color: #17a2b8; --dark-color: #343a40; --light-color: #f8f9fa; } body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; direction: rtl; } .main-container { background: rgba(255, 255, 255, 0.95); -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); margin: 20px; padding: 30px; min-height: calc(100vh - 40px); } .page-header { background: linear-gradient(135deg, var(--primary-color), #1e3c72); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; text-align: center; position: relative; overflow: hidden; } .page-header::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: repeating-linear-gradient( 45deg, transparent, transparent 10px, rgba(255, 255, 255, 0.05) 10px, rgba(255, 255, 255, 0.05) 20px ); animation: slide 20s linear infinite; } @keyframes slide { 0% { transform: translateX(-50px); } 100% { transform: translateX(50px); } } .page-header h1 { position: relative; z-index: 1; margin: 0; font-size: 2.5rem; font-weight: 700; } .page-header p { position: relative; z-index: 1; margin: 10px 0 0 0; opacity: 0.9; font-size: 1.1rem; } .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; } .stat-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); border-left: 5px solid var(--primary-color); transition: all 0.3s ease; position: relative; overflow: hidden; } .stat-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, transparent 0%, rgba(44, 90, 160, 0.05) 100%); transition: all 0.3s ease; } .stat-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15); } .stat-card:hover::before { background: linear-gradient(135deg, transparent 0%, rgba(44, 90, 160, 0.1) 100%); } .stat-card .icon { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 15px; } .stat-card .number { font-size: 2rem; font-weight: 700; color: var(--dark-color); margin-bottom: 5px; } .stat-card .label { color: #6c757d; font-size: 0.9rem; font-weight: 500; } .control-panel { background: white; border-radius: 15px; padding: 25px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); } .control-panel h3 { color: var(--primary-color); margin-bottom: 20px; font-weight: 600; } .filter-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; } .btn-custom { background: linear-gradient(135deg, var(--primary-color), #1e3c72); border: none; color: white; padding: 12px 25px; border-radius: 10px; font-weight: 600; transition: all 0.3s ease; position: relative; overflow: hidden; } .btn-custom::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); transition: left 0.5s; } .btn-custom:hover::before { left: 100%; } .btn-custom:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(44, 90, 160, 0.3); } .batches-table { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); } .table { margin: 0; } .table thead th { background: linear-gradient(135deg, var(--primary-color), #1e3c72); color: white; border: none; padding: 15px; font-weight: 600; text-align: center; } .table tbody td { padding: 15px; vertical-align: middle; border-color: #e9ecef; text-align: center; } .table tbody tr:hover { background-color: rgba(44, 90, 160, 0.05); } .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; } .status-active { background-color: rgba(40, 167, 69, 0.1); color: var(--success-color); } .status-expired { background-color: rgba(220, 53, 69, 0.1); color: var(--danger-color); } .status-low-stock { background-color: rgba(255, 193, 7, 0.1); color: var(--warning-color); } .progress-bar-custom { height: 8px; border-radius: 10px; background-color: #e9ecef; overflow: hidden; } .progress-fill { height: 100%; border-radius: 10px; transition: width 0.3s ease; } .modal-content { border-radius: 15px; border: none; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2); } .modal-header { background: linear-gradient(135deg, var(--primary-color), #1e3c72); color: white; border-radius: 15px 15px 0 0; border: none; } .form-control, .form-select { border-radius: 10px; border: 2px solid #e9ecef; padding: 12px 15px; transition: all 0.3s ease; } .form-control:focus, .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(44, 90, 160, 0.25); } .action-buttons { display: flex; gap: 5px; justify-content: center; } .btn-action { padding: 8px 12px; border-radius: 8px; border: none; font-size: 0.9rem; transition: all 0.3s ease; } .btn-action:hover { transform: translateY(-2px); } .loading-spinner { display: none; text-align: center; padding: 50px; } .spinner-border { color: var(--primary-color); } .alert-custom { border-radius: 10px; border: none; padding: 15px 20px; margin-bottom: 20px; } .pagination { justify-content: center; margin-top: 20px; } .page-link { border-radius: 8px; margin: 0 2px; border: 2px solid #e9ecef; color: var(--primary-color); padding: 10px 15px; } .page-link:hover { background-color: var(--primary-color); border-color: var(--primary-color); color: white; } .page-item.active .page-link { background-color: var(--primary-color); border-color: var(--primary-color); } @media (max-width: 768px) { .main-container { margin: 10px; padding: 20px; } .page-header h1 { font-size: 2rem; } .stats-cards { grid-template-columns: 1fr; } .filter-section { grid-template-columns: 1fr; } .table-responsive { font-size: 0.9rem; } } </style></head><body><!-- Navigation --><nav class="navbar navbar-expand-lg navbar-dark"><div class="container-fluid"><a class="navbar-brand" href="dashboard.html"><i class="fas fa-cubes"></i> نظام إدارة المخزون </a><button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="تبديل القائمة" title="تبديل القائمة" ><span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarNav"><ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="dashboard.html"><i class="fas fa-tachometer-alt"></i> لوحة التحكم </a></li><li class="nav-item"><a class="nav-link" href="inventory.html"><i class="fas fa-boxes"></i> المخزون </a></li><li class="nav-item"><a class="nav-link active" href="batch_management.html"><i class="fas fa-tags"></i> إدارة اللوطات </a></li><li class="nav-item"><a class="nav-link" href="sales.html"><i class="fas fa-shopping-cart"></i> المبيعات </a></li><li class="nav-item"><a class="nav-link" href="purchases.html"><i class="fas fa-shopping-bag"></i> المشتريات </a></li></ul><ul class="navbar-nav"><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" tabindex="0" tabindex="0" data-bs-toggle="dropdown"><i class="fas fa-user"></i> المستخدم </a><ul class="dropdown-menu"><li><a class="dropdown-item" href="#"><i class="fas fa-cog"></i> الإعدادات</a></li><li><hr class="dropdown-divider"></li><li><a class="dropdown-item" href="index.html"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</a></li></ul></li></ul></div></div></nav><div class="main-container"><!-- Page Header --><div class="page-header"><h1><i class="fas fa-tags"></i> إدارة اللوطات المتقدمة</h1><p>نظام شامل لإدارة وتتبع اللوطات ولوطات الوزارة مع التقارير المتخصصة</p></div><!-- Statistics Cards --><div class="stats-cards"><div class="stat-card"><div class="icon"><i class="fas fa-tags"></i></div><div class="number" id="totalLots">0</div><div class="label">إجمالي اللوطات</div></div><div class="stat-card"><div class="icon"><i class="fas fa-check-circle"></i></div><div class="number" id="activeLots">0</div><div class="label">اللوطات النشطة</div></div><div class="stat-card"><div class="icon"><i class="fas fa-exclamation-triangle"></i></div><div class="number" id="expiredLots">0</div><div class="label">اللوطات المنتهية</div></div><div class="stat-card"><div class="icon"><i class="fas fa-certificate"></i></div><div class="number" id="ministryLots">0</div><div class="label">لوطات الوزارة</div></div></div><!-- Control Panel --><div class="control-panel"><h3><i class="fas fa-filter"></i> لوحة التحكم والفلترة</h3><div class="filter-section"><div><label class="form-label">البحث</label><input type="text" placeholder="أدخل النص" class="form-control" id="searchInput" placeholder="رقم اللوط، المنتج، أو الملاحظات" aria-label="حقل نص"></div><div><label class="form-label">المنتج</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="productFilter"><option value="">جميع المنتجات</option></select></div><div><label class="form-label">المخزن</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="warehouseFilter"><option value="">جميع المخازن</option></select></div><div><label class="form-label">المورد</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="supplierFilter"><option value="">جميع الموردين</option></select></div><div><label class="form-label">الحالة</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" id="statusFilter"><option value="">جميع الحالات</option><option value="active">نشط</option><option value="expired">منتهي الصلاحية</option><option value="sold_out">نفد المخزون</option><option value="recalled">مسحوب</option></select></div><div><label class="form-label">خيارات إضافية</label><div class="form-check"><input class="form-check-input" type="checkbox" id="expiredOnlyFilter"><label class="form-check-label" for="expiredOnlyFilter"> المنتهية الصلاحية فقط </label></div><div class="form-check"><input class="form-check-input" type="checkbox" id="lowStockFilter"><label class="form-check-label" for="lowStockFilter"> قليلة المخزون فقط </label></div></div></div><div class="d-flex gap-2 flex-wrap"><button type="button" class="btn btn-custom" onclick="applyFilters()"><i class="fas fa-search"></i> تطبيق الفلاتر </button><button type="button" class="btn btn-success" onclick="showAddLotModal()"><i class="fas fa-plus"></i> إضافة لوط جديد </button><button type="button" class="btn btn-info" onclick="showMinistryLotModal()"><i class="fas fa-certificate"></i> إضافة لوط وزارة </button><button type="button" class="btn btn-warning" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> تصدير Excel </button><button type="button" class="btn btn-danger" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> تصدير PDF </button></div></div><!-- Loading Spinner --><div class="loading-spinner" id="loadingSpinner"><div class="spinner-border" role="status"><span class="visually-hidden">جاري التحميل...</span></div><p class="mt-3">جاري تحميل البيانات...</p></div><!-- Lots Table --><div class="batches-table" id="batchesTable" style="display: none;"><div class="table-responsive"><table class="table table-hover"><thead><tr><th>رقم اللوط</th><th>المنتج</th><th>المخزن</th><th>تاريخ الإنشاء</th><th>الكمية الحالية</th><th>نسبة المخزون</th><th>تاريخ الانتهاء</th><th>الحالة</th><th>الإجراءات</th></tr></thead><tbody id="batchesTableBody"><!-- سيتم ملء البيانات هنا --></tbody></table></div><!-- Pagination --><nav aria-label="تصفح الصفحات"><ul class="pagination" id="pagination"><!-- سيتم إنشاء أزرار التصفح هنا --></ul></nav></div></div><!-- Add Lot Modal --><div class="modal fade" id="addLotModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="fas fa-plus"></i> إضافة لوط جديد</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="addLotForm"><div class="row"><div class="col-md-6 mb-3"><label class="form-label">رقم اللوط *</label><input type="text" placeholder="أدخل النص" class="form-control" name="batch_number" required aria-label="حقل نص"></div><div class="col-md-6 mb-3"><label class="form-label">المنتج *</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" name="product_id" required><option value="">اختر المنتج</option></select></div><div class="col-md-6 mb-3"><label class="form-label">المخزن *</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" name="warehouse_id" required><option value="">اختر المخزن</option></select></div><div class="col-md-6 mb-3"><label class="form-label">تاريخ إنشاء اللوط *</label><input type="date" class="form-control" name="batch_creation_date" required></div><div class="col-md-6 mb-3"><label class="form-label">تاريخ الإنتاج</label><input type="date" class="form-control" name="production_date"></div><div class="col-md-6 mb-3"><label class="form-label">تاريخ الانتهاء</label><input type="date" class="form-control" name="expiry_date"></div><div class="col-md-6 mb-3"><label class="form-label">الكمية الأصلية *</label><input type="number" placeholder="أدخل رقم" class="form-control" name="initial_quantity" step="0.01" required aria-label="حقل رقم"></div><div class="col-md-6 mb-3"><label class="form-label">المورد</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" name="supplier_id"><option value="">اختر المورد</option></select></div><div class="col-md-6 mb-3"><label class="form-label">المادة المعاملة</label><input type="text" placeholder="أدخل النص" class="form-control" name="treated_material" aria-label="حقل نص"></div><div class="col-md-6 mb-3"><label class="form-label">معدل الإنبات (%)</label><input type="number" placeholder="أدخل رقم" class="form-control" name="germination_rate" step="0.01" min="0" max="100" aria-label="حقل رقم"></div><div class="col-md-6 mb-3"><label class="form-label">معدل النقاوة (%)</label><input type="number" placeholder="أدخل رقم" class="form-control" name="purity_rate" step="0.01" min="0" max="100" aria-label="حقل رقم"></div><div class="col-md-6 mb-3"><label class="form-label">نسبة الرطوبة (%)</label><input type="number" placeholder="أدخل رقم" class="form-control" name="moisture_content" step="0.01" min="0" max="100" aria-label="حقل رقم"></div><div class="col-md-6 mb-3"><label class="form-label">حجم البذرة</label><input type="text" placeholder="أدخل النص" class="form-control" name="seed_size" aria-label="حقل نص"></div><div class="col-md-6 mb-3"><label class="form-label">بلد المنشأ</label><input type="text" placeholder="أدخل النص" class="form-control" name="origin_country" aria-label="حقل نص"></div><div class="col-md-6 mb-3"><label class="form-label">الصنف/التنوع</label><input type="text" placeholder="أدخل النص" class="form-control" name="variety" aria-label="حقل نص"></div><div class="col-md-6 mb-3"><label class="form-label">درجة الجودة</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" name="quality_grade"><option value="">اختر درجة الجودة</option><option value="A">A - ممتاز</option><option value="B">B - جيد جداً</option><option value="C">C - جيد</option><option value="D">D - مقبول</option></select></div><div class="col-12 mb-3"><label class="form-label">ملاحظات</label><textarea class="form-control" name="notes" rows="3"></textarea></div><div class="col-12 mb-3"><label class="form-label">ملاحظات داخلية</label><textarea class="form-control" name="internal_notes" rows="2"></textarea></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" class="btn btn-custom" onclick="saveLot()">حفظ اللوط</button></div></div></div></div><!-- Ministry Lot Modal --><div class="modal fade" id="ministryLotModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="fas fa-certificate"></i> إضافة لوط وزارة</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><form id="ministryLotForm"><div class="row"><div class="col-md-6 mb-3"><label class="form-label">اللوط الأساسي *</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" name="batch_id" required><option value="">اختر اللوط الأساسي</option></select></div><div class="col-md-6 mb-3"><label class="form-label">رقم لوط الوزارة *</label><input type="text" placeholder="أدخل النص" class="form-control" name="ministry_batch_number" required aria-label="حقل نص"></div><div class="col-md-6 mb-3"><label class="form-label">تاريخ الفحص *</label><input type="date" class="form-control" name="test_date" required></div><div class="col-md-6 mb-3"><label class="form-label">معدل الإنبات (%) *</label><input type="number" placeholder="أدخل رقم" class="form-control" name="germination_rate" step="0.01" min="0" max="100" required aria-label="حقل رقم"></div><div class="col-md-6 mb-3"><label class="form-label">معدل النقاوة (%) *</label><input type="number" placeholder="أدخل رقم" class="form-control" name="purity_rate" step="0.01" min="0" max="100" required aria-label="حقل رقم"></div><div class="col-md-6 mb-3"><label class="form-label">رقم الشهادة</label><input type="text" placeholder="أدخل النص" class="form-control" name="certificate_number" aria-label="حقل نص"></div><div class="col-md-6 mb-3"><label class="form-label">تاريخ الشهادة</label><input type="date" class="form-control" name="certificate_date"></div><div class="col-md-6 mb-3"><label class="form-label">تاريخ انتهاء الشهادة</label><input type="date" class="form-control" name="certificate_expiry"></div><div class="col-md-6 mb-3"><label class="form-label">اسم المفتش</label><input type="text" placeholder="أدخل النص" class="form-control" name="inspector_name" aria-label="حقل نص"></div><div class="col-md-6 mb-3"><label class="form-label">اسم المختبر</label><input type="text" placeholder="أدخل النص" class="form-control" name="laboratory_name" aria-label="حقل نص"></div><div class="col-md-6 mb-3"><label class="form-label">طريقة الفحص</label><input type="text" placeholder="أدخل النص" class="form-control" name="test_method" aria-label="حقل نص"></div><div class="col-md-6 mb-3"><label class="form-label">نسبة الرطوبة (%)</label><input type="number" placeholder="أدخل رقم" class="form-control" name="moisture_content" step="0.01" min="0" max="100" aria-label="حقل رقم"></div><div class="col-md-6 mb-3"><label class="form-label">المواد الغريبة (%)</label><input type="number" placeholder="أدخل رقم" class="form-control" name="foreign_matter" step="0.01" min="0" max="100" aria-label="حقل رقم"></div><div class="col-md-6 mb-3"><label class="form-label">البذور التالفة (%)</label><input type="number" placeholder="أدخل رقم" class="form-control" name="damaged_seeds" step="0.01" min="0" max="100" aria-label="حقل رقم"></div><div class="col-md-6 mb-3"><label class="form-label">بذور الأعشاب (%)</label><input type="number" placeholder="أدخل رقم" class="form-control" name="weed_seeds" step="0.01" min="0" max="100" aria-label="حقل رقم"></div><div class="col-md-6 mb-3"><label class="form-label">درجة حرارة الفحص</label><input type="number" placeholder="أدخل رقم" class="form-control" name="test_temperature" step="0.1" aria-label="حقل رقم"></div><div class="col-md-6 mb-3"><label class="form-label">رطوبة الفحص (%)</label><input type="number" placeholder="أدخل رقم" class="form-control" name="test_humidity" step="0.01" min="0" max="100" aria-label="حقل رقم"></div><div class="col-md-6 mb-3"><label class="form-label">وزن العينة (جرام)</label><input type="number" placeholder="أدخل رقم" class="form-control" name="sample_weight" step="0.01" aria-label="حقل رقم"></div><div class="col-md-6 mb-3"><label class="form-label">حالة الموافقة</label><select class="form-select" aria-label="اختيار من القائمة" title="اختيار من القائمة" name="approval_status"><option value="pending">في الانتظار</option><option value="approved">موافق عليه</option><option value="rejected">مرفوض</option><option value="conditional">موافقة مشروطة</option></select></div><div class="col-12 mb-3"><label class="form-label">ملاحظات الموافقة</label><textarea class="form-control" name="approval_notes" rows="2"></textarea></div><div class="col-12 mb-3"><label class="form-label">ملاحظات عامة</label><textarea class="form-control" name="notes" rows="3"></textarea></div></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button><button type="button" class="btn btn-custom" onclick="saveMinistryLot()">حفظ لوط الوزارة</button></div></div></div></div><!-- Scripts --><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><script src="https://code.jquery.com/jquery-3.7.0.min.js"></script><script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script><script src="js/navigation.js"></script><script> // متغيرات عامة let currentPage = 1; let totalPages = 1; let currentFilters = {}; // تحميل البيانات عند تحميل الصفحة document.addEventListener('DOMContentLoaded', function() { loadInitialData(); loadLots(); }); // تحميل البيانات الأولية async function loadInitialData() { try { // تحميل المنتجات const productsResponse = await fetch('/api/products'); const products = await productsResponse.json(); const productSelects = document.querySelectorAll('select[name="product_id"], #productFilter'); productSelects.forEach(select => { products.forEach(product => { const option = document.createElement('option'); option.value = product.id; option.textContent = product.name; select.appendChild(option); }); }); // تحميل المخازن const warehousesResponse = await fetch('/api/warehouses'); const warehouses = await warehousesResponse.json(); const warehouseSelects = document.querySelectorAll('select[name="warehouse_id"], #warehouseFilter'); warehouseSelects.forEach(select => { warehouses.forEach(warehouse => { const option = document.createElement('option'); option.value = warehouse.id; option.textContent = warehouse.name; select.appendChild(option); }); }); // تحميل الموردين const suppliersResponse = await fetch('/api/suppliers'); const suppliers = await suppliersResponse.json(); const supplierSelects = document.querySelectorAll('select[name="supplier_id"], #supplierFilter'); supplierSelects.forEach(select => { suppliers.forEach(supplier => { const option = document.createElement('option'); option.value = supplier.id; option.textContent = supplier.name; select.appendChild(option); }); }); // تحميل اللوطات للوط الوزارة const batchesResponse = await fetch('/api/batches'); const batches = await batchesResponse.json(); const lotSelect = document.querySelector('select[name="batch_id"]'); batches.batches.forEach(lot => { const option = document.createElement('option'); option.value = lot.id; option.textContent = `${lot.batch_number} - ${lot.product_name}`; lotSelect.appendChild(option); }); } catch (error) { console.error('خطأ في تحميل البيانات الأولية:', error); } } // تحميل اللوطات async function loadLots(page = 1) { showLoading(); try { const params = new URLSearchParams({ page: page, per_page: 20, ...currentFilters }); const response = await fetch(`/api/batches?${params}`); const data = await response.json(); if (data.success) { displayLots(data.batches); updatePagination(data.pagination); updateStatistics(data); currentPage = page; } else { showAlert('خطأ في تحميل البيانات: ' + data.message, 'danger'); } } catch (error) { console.error('خطأ في تحميل اللوطات:', error); showAlert('خطأ في الاتصال بالخادم', 'danger'); } finally { hideLoading(); } } // عرض اللوطات في الجدول function displayLots(batches) { const tbody = document.getElementById('batchesTableBody'); tbody.innerHTML = ''; batches.forEach(lot => { const row = document.createElement('tr'); // حساب نسبة المخزون const stockPercentage = lot.quantity_percentage || 0; let stockClass = 'bg-success'; if (stockPercentage < 20) stockClass = 'bg-danger'; else if (stockPercentage < 50) stockClass = 'bg-warning'; // تحديد حالة اللوط let statusBadge = ''; if (lot.is_expired) { statusBadge = '<span class="status-badge status-expired">منتهي الصلاحية</span>'; } else if (stockPercentage < 20) { statusBadge = '<span class="status-badge status-low-stock">قليل المخزون</span>'; } else { statusBadge = '<span class="status-badge status-active">نشط</span>'; } row.innerHTML = ` <td><strong>${lot.batch_number}</strong></td><td>${lot.product_name || ''}</td><td>${lot.warehouse_name || ''}</td><td>${lot.batch_creation_date || ''}</td><td>${lot.current_quantity} / ${lot.initial_quantity}</td><td><div class="progress-bar-custom"><div class="progress-fill ${stockClass}" style="width: ${stockPercentage}%"></div></div><small>${stockPercentage.toFixed(1)}%</small></td><td>${lot.expiry_date || 'غير محدد'}</td><td>${statusBadge}</td><td><div class="action-buttons"><button type="button" class="btn btn-action btn-primary btn-sm" onclick="viewLotDetails(${lot.id})" title="عرض التفاصيل"><i class="fas fa-eye"></i></button><button type="button" class="btn btn-action btn-warning btn-sm" onclick="editLot(${lot.id})" title="تعديل"><i class="fas fa-edit"></i></button><button type="button" class="btn btn-action btn-info btn-sm" onclick="viewLotReport('${lot.batch_number}')" title="تقرير اللوط"><i class="fas fa-chart-line"></i></button><button type="button" class="btn btn-action btn-success btn-sm" onclick="addMinistryLotForLot(${lot.id})" title="إضافة لوط وزارة"><i class="fas fa-certificate"></i></button></div></td> `; tbody.appendChild(row); }); document.getElementById('batchesTable').style.display = 'block'; } // تحديث الإحصائيات function updateStatistics(data) { // هذه دالة مبسطة - يمكن تحسينها لاحقاً document.getElementById('totalLots').textContent = data.pagination?.total || 0; // حساب الإحصائيات من البيانات المحملة const activeLots = data.batches?.filter(lot => !lot.is_expired && lot.current_quantity > 0).length || 0; const expiredLots = data.batches?.filter(lot => lot.is_expired).length || 0; document.getElementById('activeLots').textContent = activeLots; document.getElementById('expiredLots').textContent = expiredLots; document.getElementById('ministryLots').textContent = '0'; // سيتم تحديثها لاحقاً } // تحديث أزرار التصفح function updatePagination(pagination) { const paginationElement = document.getElementById('pagination'); paginationElement.innerHTML = ''; totalPages = pagination.pages; // زر السابق if (pagination.has_prev) { const prevItem = document.createElement('li'); prevItem.className = 'page-item'; prevItem.innerHTML = `<a class="page-link" href="#" onclick="loadLots(${pagination.page - 1})">السابق</a>`; paginationElement.appendChild(prevItem); } // أرقام الصفحات const startPage = Math.max(1, pagination.page - 2); const endPage = Math.min(pagination.pages, pagination.page + 2); for (let i = startPage; i <= endPage; i++) { const pageItem = document.createElement('li'); pageItem.className = `page-item ${i === pagination.page ? 'active' : ''}`; pageItem.innerHTML = `<a class="page-link" href="#" onclick="loadLots(${i})">${i}</a>`; paginationElement.appendChild(pageItem); } // زر التالي if (pagination.has_next) { const nextItem = document.createElement('li'); nextItem.className = 'page-item'; nextItem.innerHTML = `<a class="page-link" href="#" onclick="loadLots(${pagination.page + 1})">التالي</a>`; paginationElement.appendChild(nextItem); } } // تطبيق الفلاتر function applyFilters() { currentFilters = { search: document.getElementById('searchInput').value, product_id: document.getElementById('productFilter').value, warehouse_id: document.getElementById('warehouseFilter').value, supplier_id: document.getElementById('supplierFilter').value, status: document.getElementById('statusFilter').value, expired_only: document.getElementById('expiredOnlyFilter').checked, low_stock: document.getElementById('lowStockFilter').checked }; // إزالة القيم الفارغة Object.keys(currentFilters).forEach(key => { if (!currentFilters[key] && currentFilters[key] !== true) { delete currentFilters[key]; } }); loadLots(1); } // عرض نافذة إضافة لوط function showAddLotModal() { document.getElementById('addLotForm').reset(); const modal = new bootstrap.Modal(document.getElementById('addLotModal')); modal.show(); } // عرض نافذة إضافة لوط وزارة function showMinistryLotModal() { document.getElementById('ministryLotForm').reset(); const modal = new bootstrap.Modal(document.getElementById('ministryLotModal')); modal.show(); } // حفظ لوط جديد async function saveLot() { const form = document.getElementById('addLotForm'); const formData = new FormData(form); const data = Object.fromEntries(formData.entries()); try { const response = await fetch('/api/batches', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); const result = await response.json(); if (result.success) { showAlert('تم إنشاء اللوط بنجاح', 'success'); bootstrap.Modal.getInstance(document.getElementById('addLotModal')).hide(); loadLots(currentPage); } else { showAlert('خطأ في إنشاء اللوط: ' + result.message, 'danger'); } } catch (error) { console.error('خطأ في حفظ اللوط:', error); showAlert('خطأ في الاتصال بالخادم', 'danger'); } } // حفظ لوط وزارة جديد async function saveMinistryLot() { const form = document.getElementById('ministryLotForm'); const formData = new FormData(form); const data = Object.fromEntries(formData.entries()); if (!data.batch_id) { showAlert('يرجى اختيار اللوط الأساسي', 'warning'); return; } try { const response = await fetch(`/api/batches/${data.batch_id}/ministry`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) }); const result = await response.json(); if (result.success) { showAlert('تم إنشاء لوط الوزارة بنجاح', 'success'); bootstrap.Modal.getInstance(document.getElementById('ministryLotModal')).hide(); loadLots(currentPage); } else { showAlert('خطأ في إنشاء لوط الوزارة: ' + result.message, 'danger'); } } catch (error) { console.error('خطأ في حفظ لوط الوزارة:', error); showAlert('خطأ في الاتصال بالخادم', 'danger'); } } // عرض تفاصيل اللوط function viewLotDetails(lotId) { // سيتم تطوير هذه الوظيفة لاحقاً showAlert('سيتم تطوير عرض التفاصيل قريباً', 'info'); } // تعديل اللوط function editLot(lotId) { // سيتم تطوير هذه الوظيفة لاحقاً showAlert('سيتم تطوير التعديل قريباً', 'info'); } // عرض تقرير اللوط function viewLotReport(lotNumber) { window.open(`/api/reports/lot-tracking/${lotNumber}`, '_blank'); } // إضافة لوط وزارة للوط محدد function addMinistryLotForLot(lotId) { document.getElementById('ministryLotForm').reset(); document.querySelector('select[name="batch_id"]').value = lotId; const modal = new bootstrap.Modal(document.getElementById('ministryLotModal')); modal.show(); } // تصدير إلى Excel function exportToExcel() { const params = new URLSearchParams(currentFilters); window.open(`/api/reports/export/batches-excel?${params}`, '_blank'); } // تصدير إلى PDF function exportToPDF() { const params = new URLSearchParams(currentFilters); window.open(`/api/reports/export/batches-pdf?${params}`, '_blank'); } // عرض/إخفاء مؤشر التحميل function showLoading() { document.getElementById('loadingSpinner').style.display = 'block'; document.getElementById('batchesTable').style.display = 'none'; } function hideLoading() { document.getElementById('loadingSpinner').style.display = 'none'; } // عرض التنبيهات function showAlert(message, type = 'info') { const alertDiv = document.createElement('div'); alertDiv.className = `alert alert-${type} alert-custom alert-dismissible fade show`; alertDiv.innerHTML = ` ${message} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="إغلاق" title="إغلاق النافذة" ></button> `; const container = document.querySelector('.main-container'); container.insertBefore(alertDiv, container.firstChild); // إزالة التنبيه تلقائياً بعد 5 ثوان setTimeout(() => { if (alertDiv.parentNode) { alertDiv.remove(); } }, 5000); } // البحث السريع document.getElementById('searchInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') { applyFilters(); } }); </script></body></html> 