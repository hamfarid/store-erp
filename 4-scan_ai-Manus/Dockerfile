# File: /home/ubuntu/clean_project/Dockerfile
# Dockerfile Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù„Ù†Ø¸Ø§Ù… Gaara Scan AI Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
# ÙŠØ³ØªØ®Ø¯Ù… Ø¨Ù†Ø§Ø¡ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„Ø£Ù…Ø§Ù† ÙˆØªÙ‚Ù„ÙŠÙ„ Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©

# ==========================================
# Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ (Build Stage)
# ==========================================
FROM python:3.11-slim as builder

# ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ù„Ù„Ø¨Ù†Ø§Ø¡
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1

# ØªØ«Ø¨ÙŠØª Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc \
    g++ \
    pkg-config \
    libpq-dev \
    libffi-dev \
    libssl-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„
WORKDIR /build

# Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
COPY requirements.txt .
COPY src/requirements.txt ./src/
COPY src/modules/*/requirements.txt ./modules/

# Ø¯Ù…Ø¬ Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
RUN cat requirements.txt > all_requirements.txt && \
    find . -name "requirements.txt" -not -path "./all_requirements.txt" -exec cat {} \; >> all_requirements.txt && \
    sort all_requirements.txt | uniq > final_requirements.txt

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"
RUN pip install --upgrade pip setuptools wheel && \
    pip install -r final_requirements.txt

# ==========================================
# Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ (Production Stage)
# ==========================================
FROM python:3.11-slim as production

# ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ù„Ù„Ø¥Ù†ØªØ§Ø¬
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app
ENV PATH="/opt/venv/bin:$PATH"

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ´ØºÙŠÙ„ ÙÙ‚Ø·
RUN apt-get update && apt-get install -y \
    libpq5 \
    libffi8 \
    libssl3 \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root Ù„Ù„Ø£Ù…Ø§Ù†
RUN groupadd -r gaara && useradd -r -g gaara -d /app -s /bin/bash gaara

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯Ù„Ø§Ø¦Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
RUN mkdir -p /app /app/logs /app/uploads /app/static /app/media && \
    chown -R gaara:gaara /app

# Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ù† Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡
COPY --from=builder /opt/venv /opt/venv

# ØªØ¹ÙŠÙŠÙ† Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„
WORKDIR /app

# Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
COPY --chown=gaara:gaara . .

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
RUN echo "DATABASE_URL=postgresql://postgres:postgres@db:5432/gaara_scan_ai" > .env && \
    echo "REDIS_URL=redis://redis:6379/0" >> .env && \
    echo "SECRET_KEY=your-secret-key-here" >> .env && \
    echo "DEBUG=False" >> .env && \
    echo "ENVIRONMENT=production" >> .env && \
    chown gaara:gaara .env

# Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
RUN cat > /app/start.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Gaara Scan AI..."

# Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
echo "â³ Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..."
while ! curl -s db:5432 > /dev/null; do
    sleep 1
done

# ØªØ´ØºÙŠÙ„ migrations Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
if [ -f "src/database.py" ]; then
    echo "ğŸ”„ ØªØ´ØºÙŠÙ„ migrations Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª..."
    python src/database.py
fi

# Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
echo "âœ… Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚..."
exec uvicorn src.main:app --host 0.0.0.0 --port 8000 --workers 4
EOF

RUN chmod +x /app/start.sh && chown gaara:gaara /app/start.sh

# Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root
USER gaara

# ØªØ¹Ø±ÙŠØ¶ Ø§Ù„Ù…Ù†Ø§ÙØ°
EXPOSE 8000

# Ø¥Ø¹Ø¯Ø§Ø¯ health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# ØªØ¹ÙŠÙŠÙ† Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
ENTRYPOINT ["/app/start.sh"]

# ==========================================
# Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ·ÙˆÙŠØ± (Development Stage)
# ==========================================
FROM production as development

# Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù…Ø³ØªØ®Ø¯Ù… root Ù„ØªØ«Ø¨ÙŠØª Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ·ÙˆÙŠØ±
USER root

# ØªØ«Ø¨ÙŠØª Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ·ÙˆÙŠØ±
RUN apt-get update && apt-get install -y \
    git \
    vim \
    htop \
    && rm -rf /var/lib/apt/lists/*

# ØªØ«Ø¨ÙŠØª Ø£Ø¯ÙˆØ§Øª Python Ù„Ù„ØªØ·ÙˆÙŠØ±
RUN /opt/venv/bin/pip install \
    pytest \
    pytest-cov \
    black \
    flake8 \
    mypy \
    ipython \
    jupyter

# Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª ØªØ·ÙˆÙŠØ±
RUN cat > /app/dev.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸ”§ Ø¨Ø¯Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ± Ù„Ù†Ø¸Ø§Ù… Gaara Scan AI..."

# ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ·ÙˆÙŠØ±
exec uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload --log-level debug
EOF

RUN chmod +x /app/dev.sh && chown gaara:gaara /app/dev.sh

# Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root
USER gaara

# ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·ÙˆÙŠØ±
ENV DEBUG=True
ENV ENVIRONMENT=development

# ==========================================
# Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Testing Stage)
# ==========================================
FROM development as testing

# Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù…Ø³ØªØ®Ø¯Ù… root
USER root

# ØªØ«Ø¨ÙŠØª Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
RUN /opt/venv/bin/pip install \
    selenium \
    requests-mock \
    factory-boy \
    faker

# Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
RUN cat > /app/test.sh << 'EOF'
#!/bin/bash
set -e

echo "ğŸ§ª Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª..."

# ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©
echo "ğŸ“‹ ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ÙˆØ­Ø¯Ø©..."
python -m pytest tests/ -v --cov=src --cov-report=html --cov-report=term

# ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯
echo "ğŸ” ÙØ­Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯..."
flake8 src/ --max-line-length=120 --ignore=E501,W503

# ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹
echo "ğŸ” ÙØ­Øµ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹..."
mypy src/ --ignore-missing-imports

echo "âœ… Ø§ÙƒØªÙ…Ù„Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!"
EOF

RUN chmod +x /app/test.sh && chown gaara:gaara /app/test.sh

# Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root
USER gaara

# ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
ENV ENVIRONMENT=testing
ENV DATABASE_URL=sqlite:///test.db

# ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
CMD ["/app/test.sh"]

