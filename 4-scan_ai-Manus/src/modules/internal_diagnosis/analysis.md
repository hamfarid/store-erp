# تحليل وظائف وحدة التشخيص الداخلي (internal_diagnosis)

**الوظيفة الأساسية:**
توفير خدمات التشخيص الداخلي للمشاكل الزراعية، مع التركيز بشكل خاص على تشخيص الأمراض النباتية باستخدام نماذج التعلم العميق (مثل ResNet) المدربة مسبقًا، بالإضافة إلى إمكانية التشخيص بناءً على الأعراض المقدمة (باستخدام قاعدة معرفية، وإن كانت هذه الميزة غير مكتملة حاليًا).

**المكونات الرئيسية والمهام:**

1. **`service.py` (خدمة التشخيص الداخلي):**
    * **المهام:**
        * تهيئة الخدمة مع إعدادات التكوين (مثل مسار سجل النماذج، اسم النموذج الافتراضي، الجهاز المستخدم).
        * التكامل مع `ModelRegistry` و `DataPreprocessor` من وحدة `training_pipeline` لتحميل النماذج المدربة مسبقًا ومعالجة الصور.
        * تحميل نماذج التعلم العميق (PyTorch) عند الحاجة وتخزينها مؤقتًا (caching) مع بياناتها الوصفية وخرائط التسميات (label maps).
        * توفير دالة `diagnose_from_image`:
            * تأخذ مسار صورة كمدخل.
            * تحميل النموذج المناسب وخريطة التسميات.
            * معالجة الصورة باستخدام `DataPreprocessor`.
            * إجراء الاستدلال (inference) باستخدام النموذج المحمل.
            * إرجاع أفضل K تنبؤات (التشخيصات المحتملة) مع درجات الثقة الخاصة بها.
        * توفير دالة `diagnose_from_symptoms` (غير مكتملة):
            * تأخذ قائمة بالأعراض كمدخل.
            * (مستقبلاً) الاستعلام عن قاعدة المعرفة لتحديد الأمراض المحتملة بناءً على الأعراض.
            * حالياً، تقدم نتائج محاكاة بسيطة.
        * التعامل مع الأخطاء (مثل عدم توفر الملفات، فشل تحميل النموذج، أخطاء الاستدلال).
        * التكامل مع وحدة تسجيل النشاط (`log_activity`) لتسجيل عمليات التشخيص والأخطاء.
    * **الاعتماديات:** `os`, `sys`, `typing`, `log_activity.logger` (اختياري), `training_pipeline.ModelRegistry`, `training_pipeline.DataPreprocessor`, `torch`, `PIL` (Pillow).

**الاستنتاج:**
تعتبر وحدة `internal_diagnosis` مكونًا رئيسيًا لتشخيص الأمراض النباتية باستخدام الذكاء الاصطناعي. تعتمد بشكل كبير على النماذج المدربة بواسطة وحدة `training_pipeline` وتوفر واجهة لطلب التشخيص إما من خلال الصور أو (مستقبلاً) من خلال الأعراض. تحتاج الوحدة إلى توفر مكتبات التعلم العميق (PyTorch) ومعالجة الصور (Pillow) لتعمل بكامل طاقتها.
