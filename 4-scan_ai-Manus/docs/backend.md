# تحليل الواجهة الخلفية لنظام Gaara AI

**الإصدار:** 1.0.0  
**تاريخ التحليل:** 2025-11-15  
**المحلل:** Manus AI

---

## 1. نظرة عامة على البنية

تعتمد الواجهة الخلفية لنظام Gaara AI على إطار عمل **Flask** مع مجموعة من المكتبات القوية لضمان الأمان، الأداء، وقابلية التوسع. البنية مصممة بشكل وحدات (modular) لتسهيل الصيانة والتطوير المستقبلي.

### المكونات الرئيسية:

*   **تطبيق Flask:** التطبيق الرئيسي الذي يدير جميع الطلبات والمسارات.
*   **SQLAlchemy:** لإدارة قواعد البيانات والتفاعل معها بشكل آمن.
*   **Flask-JWT-Extended:** لإدارة المصادقة باستخدام توكن JWT.
*   **Flask-Limiter:** لتحديد عدد الطلبات وحماية النظام من هجمات DDoS.
*   **Flask-Talisman:** لإضافة طبقة من الأمان عن طريق إعداد HTTP headers.
*   **Celery & Redis:** لتشغيل المهام غير المتزامنة في الخلفية (مثل إرسال الإشعارات أو معالجة الصور).
*   **بنية وحدات (Modular):** تم تقسيم الكود إلى وحدات منطقية مثل `models`, `routes`, `services`, `utils` لتنظيم أفضل.

---

## 2. نقاط النهاية (API Endpoints)

تم تحديد **41 نقطة نهاية (endpoint)** فريدة في الواجهة الخلفية، موزعة على عدة ملفات. هذه النقاط تغطي جميع الوظائف الأساسية للنظام.

### نقاط النهاية الرئيسية (من `main_api.py`):

| الطريقة | المسار                                  | الوظيفة                                      |
| :------- | :-------------------------------------- | :------------------------------------------- |
| GET      | `/`                                     | الصفحة الرئيسية (للاختبار)                     |
| GET      | `/api/health`                           | التحقق من صحة الواجهة الخلفية                |
| POST     | `/api/auth/register`                    | تسجيل مستخدم جديد                            |
| POST     | `/api/auth/login`                       | تسجيل دخول المستخدم                          |
| GET      | `/api/auth/profile`                     | الحصول على ملف تعريف المستخدم الحالي         |
| GET      | `/api/farms`                            | الحصول على قائمة المزارع                      |
| POST     | `/api/farms`                            | إنشاء مزرعة جديدة                            |
| GET      | `/api/farms/<int:farm_id>`              | الحصول على تفاصيل مزرعة معينة                |
| GET      | `/api/plants`                           | الحصول على قائمة النباتات                      |
| POST     | `/api/plants`                           | إنشاء نبات جديد                              |
| GET      | `/api/diseases`                         | الحصول على قائمة الأمراض                      |
| POST     | `/api/diagnosis`                        | إنشاء تشخيص جديد (رفع صورة)                 |
| GET      | `/api/diagnosis/<int:diagnosis_id>`     | الحصول على تفاصيل تشخيص معين                |
| GET      | `/api/diagnosis`                        | الحصول على قائمة التشخيصات                   |
| POST     | `/api/sensors`                          | إنشاء حساس جديد                              |
| POST     | `/api/sensors/<int:sensor_id>/readings` | إضافة قراءة جديدة لحساس معين                |
| GET      | `/api/stats/dashboard`                  | الحصول على إحصائيات لوحة التحكم              |
| GET      | `/uploads/<filename>`                   | عرض الملفات المرفوعة                         |

### نقاط النهاية الأمنية (من `main_api_security_fixes.py`):

| الطريقة | المسار                   | الوظيفة                       |
| :------- | :----------------------- | :--------------------------- |
| GET      | `/api/security/health`   | التحقق من صحة الخدمات الأمنية |

### نقاط النهاية الإضافية (من `interface_integration_fixer.py`):

| الطريقة      | المسار                    | الوظيفة                                      |
| :------------ | :------------------------ | :------------------------------------------ |
| GET           | `/api/health`             | التحقق من صحة الواجهة الخلفية                |
| POST          | `/api/import`             | استيراد البيانات                             |
| POST          | `/api/export`             | تصدير البيانات                              |
| POST          | `/api/backup`             | إنشاء نسخة احتياطية                         |
| POST          | `/api/restore`            | استعادة نسخة احتياطية                       |
| GET           | `/api/data`               | الحصول على بيانات عامة                       |
| POST          | `/api/print`              | طباعة التقارير                              |
| GET, POST   | `/api/settings`           | الحصول على/تحديث الإعدادات                  |
| GET           | `/api/download/<filename>` | تنزيل الملفات                               |

---

## 3. نماذج قاعدة البيانات (Database Models)

تم تحديد **10 نماذج رئيسية** و **2 جدول ربط** في ملف `models.py`. هذه النماذج تمثل الكيانات الأساسية في النظام.

### الجداول الرئيسية:

1.  **User:** نموذج المستخدم مع نظام صلاحيات متقدم، معلومات شخصية، وإعدادات.
2.  **Company:** نموذج الشركة التي ينتمي إليها المستخدم.
3.  **Permission:** نموذج الصلاحيات لتحديد ما يمكن للمستخدم فعله.
4.  **ApiKey:** نموذج مفاتيح API للوصول البرمجي.
5.  **Farm:** نموذج المزرعة مع تفاصيل الموقع، المساحة، والمالك.
6.  **Plant:** نموذج النبات مع معلومات تفصيلية عن الزراعة، العناية، والقيمة الاقتصادية.
7.  **Disease:** نموذج المرض مع معلومات شاملة عن الأعراض، الأسباب، والعلاج.
8.  **Crop:** نموذج المحصول لتتبع المحاصيل المزروعة في المزارع.
9.  **Sensor:** نموذج أجهزة الاستشعار IoT.
10. **SensorReading:** نموذج قراءات أجهزة الاستشعار.
11. **Diagnosis:** نموذج التشخيص لتسجيل نتائج تشخيص الأمراض.

### جداول الربط:

1.  **plant_diseases:** يربط بين النباتات والأمراض التي يمكن أن تصيبها.
2.  **user_permissions:** يربط بين المستخدمين والصلاحيات الممنوحة لهم.

---

## 4. ملخص الإجراءات الأمنية

تم تطبيق مجموعة من أفضل الممارسات الأمنية لحماية النظام:

*   **التحقق من صحة المدخلات (Input Validation):** دالة `validate_input` للتحقق من جميع البيانات القادمة من المستخدم.
*   **استعلامات آمنة (Parameterized Queries):** استخدام `SQLAlchemy` و `text()` لمنع هجمات حقن SQL.
*   **تشفير كلمات المرور:** استخدام `generate_password_hash` و `check_password_hash`.
*   **صلاحيات JWT:** استخدام `@jwt_required` و `@admin_required` لحماية نقاط النهاية.
*   **تحديد عدد الطلبات (Rate Limiting):** لحماية النظام من هجمات القوة الغاشمة (Brute-force) و DDoS.
*   **رؤوس الأمان (Security Headers):** استخدام `Flask-Talisman` لإعداد CSP, HSTS, و X-Frame-Options.
*   **CORS آمن:** تقييد الوصول إلى الواجهة الخلفية من نطاقات محددة فقط.
*   **تسجيل آمن (Secure Logging):** تسجيل جميع الأنشطة والتحذيرات الأمنية في ملفات logs مع تدويرها.
*   **رفع آمن للملفات:** التحقق من امتدادات الملفات وتنظيف أسمائها.

---

## 5. الخلاصة

الواجهة الخلفية لنظام Gaara AI مبنية بشكل جيد مع التركيز على الأمان والأداء. تم توثيق معظم الوظائف الأساسية، ولكن لا يزال هناك مجال لتحسين التوثيق التفصيلي لكل دالة وخدمة. هذا التحليل يوفر أساساً قوياً لفهم بنية الواجهة الخلفية والبدء في أي عمليات تطوير أو صيانة مستقبلية.
