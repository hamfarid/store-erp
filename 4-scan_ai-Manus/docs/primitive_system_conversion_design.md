# تصميم تحسين تحليل الصور باستخدام تحويل النظام الأولي

## 1. الهدف

يهدف هذا التحسين إلى تعزيز قدرات تحليل الصور في النظام الزراعي من خلال تحويل أجزاء الصورة المقسمة (القطع) إلى تمثيل "أولي" أو مبسط. هذا التمثيل يسهل التحليل المقارن، والتعلم الآلي، واستخلاص النتائج بشكل أكثر فعالية من مجرد التعامل مع بيانات البكسل الخام.

## 2. مفهوم "النظام الأولي"

في هذا السياق، يشير "النظام الأولي" إلى مجموعة من الميزات أو الواصفات الأساسية التي تلخص الخصائص المرئية الهامة لكل قطعة من الصورة المقسمة. بدلاً من التعامل مع مصفوفة البكسلات الكاملة للقطعة، سيتم تمثيلها بمجموعة من القيم العددية أو الفئوية.

## 3. الميزات الأولية المقترحة

لكل قطعة (segment) تم الحصول عليها من `ImageSegmentationAnalyzer`، سيتم استخراج الميزات الأولية التالية:

1.  **اللون السائد (Dominant Color)**: اللون الأكثر شيوعًا داخل القطعة (مثل قيمة RGB أو HSV المتوسطة أو الأكثر تكرارًا).
2.  **توزيع الألوان (Color Histogram)**: تمثيل لتوزيع الألوان داخل القطعة (يمكن تبسيطه إلى نسب مئوية للألوان الرئيسية: أخضر، أصفر، بني، إلخ).
3.  **مقاييس النسيج (Texture Metrics)**: مقاييس لوصف نسيج السطح داخل القطعة (مثل التباين، التجانس، الطاقة باستخدام مصفوفة التدرج الرمادي المشترك GLCM).
4.  **واصفات الشكل (Shape Descriptors)**: مقاييس لوصف شكل القطعة (مثل الاستدارة، الاستطالة، الصلابة، لحظات هو).
5.  **كشف الشذوذ (Anomaly Detection)**: مؤشرات لوجود أنماط غير طبيعية داخل القطعة (مثل اكتشاف البقع، الخطوط، التغيرات اللونية المفاجئة).
6.  **الحجم والموقع (Size and Location)**: المساحة النسبية للقطعة وموقع مركزها (موجودة بالفعل في `ImageSegmentationAnalyzer`).

## 4. التنفيذ المقترح

1.  **إنشاء وحدة جديدة**: سيتم إنشاء وحدة بايثون جديدة باسم `src/utils/feature_extractor.py` لاحتواء وظائف استخراج الميزات.
2.  **فئة `SegmentFeatureExtractor`**: ستحتوي هذه الفئة على طرق لحساب كل ميزة أولية مقترحة. ستأخذ كل طريقة صورة القطعة (ROI) وقناعها كمدخلات.
    *   `extract_dominant_color(roi, mask)`
    *   `extract_color_histogram(roi, mask)`
    *   `extract_texture_metrics(roi, mask)`
    *   `extract_shape_descriptors(mask)`
    *   `detect_anomalies(roi, mask)`
3.  **تعديل `ImageSegmentationAnalyzer`**: 
    *   سيتم استيراد واستخدام `SegmentFeatureExtractor` داخل `ImageSegmentationAnalyzer`.
    *   سيتم تعديل طريقة `_analyze_segment` لاستدعاء طرق استخراج الميزات من `SegmentFeatureExtractor`.
    *   سيتم إضافة قاموس جديد باسم `primitive_features` إلى القاموس الذي يتم إرجاعه لكل قطعة، وسيحتوي هذا القاموس على الميزات الأولية المستخرجة.

## 5. مثال على هيكل البيانات المحدث للقطعة

```python
{
    "segment_id": 0,
    "bbox": (10, 10, 50, 50),
    "area": 2350,
    "area_percentage": 5.2,
    "centroid": (35.1, 34.8),
    "disease_detected": True,
    "disease_confidence": 0.90,
    "disease_name": "البقع البنية",
    "disease_ratio": 0.35,
    "primitive_features": {
        "dominant_color_rgb": (130, 60, 15),
        "color_histogram": {"green": 0.55, "brown": 0.35, "yellow": 0.10},
        "texture_contrast": 15.2,
        "texture_homogeneity": 0.85,
        "shape_circularity": 0.78,
        "anomaly_spots_detected": True,
        "anomaly_spots_count": 3
    }
}
```

## 6. الفوائد

-   **تقليل الأبعاد**: تحويل بيانات البكسل عالية الأبعاد إلى تمثيل منخفض الأبعاد يسهل التعامل معه.
-   **تسهيل المقارنة**: يمكن مقارنة القطع بسهولة أكبر بناءً على ميزاتها الأولية.
-   **تحسين التعلم الآلي**: يمكن استخدام الميزات الأولية كمدخلات لنماذج تعلم آلي أخرى (مثل نماذج التجميع أو التصنيف).
-   **تفسير أفضل**: يوفر تمثيلًا أكثر قابلية للتفسير لخصائص القطعة مقارنة بالبكسلات الخام.

## 7. التحديات

-   **اختيار الميزات المناسبة**: تحديد أفضل مجموعة من الميزات الأولية التي تلتقط المعلومات الأكثر صلة.
-   **تعقيد الحساب**: قد يكون حساب بعض الميزات (مثل النسيج أو الشكل) مكلفًا حسابيًا.
-   **الحساسية للظروف**: قد تتأثر بعض الميزات بظروف الإضاءة أو جودة الصورة.

## 8. الخطوات التالية

-   تنفيذ الوحدة `src/utils/feature_extractor.py` مع وظائف استخراج الميزات الأولية.
-   تعديل `src/disease_detection/image_segmentation.py` لدمج استخراج الميزات الأولية في تحليل القطع.
-   تحديث الاختبارات لتشمل التحقق من الميزات الأولية.
-   تحديث الوثائق.
