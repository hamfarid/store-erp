#!/usr/bin/env python3
"""
from flask_cors import CORS
from flask import g
Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ Ø§Ù„Ø°ÙƒÙŠ
ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØªØ·Ø¨ÙŠÙ‚ FastAPI Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙˆØ¬Ù…ÙŠØ¹ Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
"""

import uvicorn
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse, RedirectResponse
import sys
import logging
from datetime import datetime
from pathlib import Path
from fastapi import FastAPI

# Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¥Ù„Ù‰ sys.path
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler("system.log"),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

# Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
SYSTEM_NAME = "Ù†Ø¸Ø§Ù… Ø¬Ø¹Ø§Ø±Ù‡ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ Ø§Ù„Ø°ÙƒÙŠ"
SYSTEM_VERSION = "1.0.0"
SYSTEM_DESCRIPTION = "Ù†Ø¸Ø§Ù… Ø°ÙƒÙŠ Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"

# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯ÙŠÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
AVAILABLE_MODULES = [
    {"name": "ai_management", "title": "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ", "status": "loaded"},
    {"name": "image_processing", "title": "Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±", "status": "loaded"},
    {"name": "disease_diagnosis", "title": "ØªØ´Ø®ÙŠØµ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶", "status": "loaded"},
    {"name": "backup_restore", "title": "Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ", "status": "loaded"},
    {"name": "settings", "title": "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", "status": "loaded"},
    {"name": "auth", "title": "Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©", "status": "loaded"},
    {"name": "plant_hybridization", "title": "ØªÙ‡Ø¬ÙŠÙ† Ø§Ù„Ù†Ø¨Ø§ØªØ§Øª", "status": "loaded"},
    {"name": "resource_monitoring", "title": "Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯", "status": "loaded"}
]

# Ø¥Ù†Ø´Ø§Ø¡ ØªØ·Ø¨ÙŠÙ‚ FastAPI
app = FastAPI(
    title=SYSTEM_NAME,
    description=SYSTEM_DESCRIPTION,
    version=SYSTEM_VERSION,
    docs_url="/docs",
    redoc_url="/redoc"
)

# Ø¥Ø¹Ø¯Ø§Ø¯ CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ„Ø§Øª


def load_modules():
    """ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ„Ø§Øª"""
    try:
        # ØªØ­Ù…ÙŠÙ„ Ù…Ø¯ÙŠÙˆÙ„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        from modules.auth import api as auth_api
        from modules.settings import api as settings_api
        from modules.backup_restore import api as backup_api
        from modules.ai_management import api as ai_api
        from modules.image_processing import api as image_api
        from modules.disease_diagnosis import api as disease_api

        # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ„Ø§Øª
        app.include_router(auth_api.router, prefix="/api/auth", tags=["Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©"])
        app.include_router(settings_api.router, prefix="/api/settings", tags=["Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª"])
        app.include_router(backup_api.router, prefix="/api/backup", tags=["Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ"])
        app.include_router(ai_api.router, prefix="/api/ai", tags=["Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"])
        app.include_router(image_api.router, prefix="/api/image", tags=["Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±"])
        app.include_router(disease_api.router, prefix="/api/disease", tags=["ØªØ´Ø®ÙŠØµ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶"])

        logger.info("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­")
        return True

    except Exception as e:
        logger.error(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ„Ø§Øª: {e}")
        return False


# Ù†Ù‚Ø§Ø· Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©


@app.get("/")
async def root():
    """Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    return RedirectResponse(url="/login")


@app.get("/health")
async def health_check():
    """ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ù†Ø¸Ø§Ù…"""
    return {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "modules": {
            "total": len(AVAILABLE_MODULES),
            "loaded": len([m for m in AVAILABLE_MODULES if m["status"] == "loaded"]),
            "failed": len([m for m in AVAILABLE_MODULES if m["status"] == "failed"])
        },
        "version": SYSTEM_VERSION
    }


@app.get("/api/modules/status")
async def get_modules_status():
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ„Ø§Øª"""
    return {
        "modules": AVAILABLE_MODULES,
        "summary": {
            "total": len(AVAILABLE_MODULES),
            "loaded": len([m for m in AVAILABLE_MODULES if m["status"] == "loaded"]),
            "failed": len([m for m in AVAILABLE_MODULES if m["status"] == "failed"]),
            "success_rate": (len([m for m in AVAILABLE_MODULES if m["status"] == "loaded"]) / len(AVAILABLE_MODULES) * 100) if AVAILABLE_MODULES else 0
        },
        "timestamp": datetime.now().isoformat()
    }


@app.get("/api/info")
async def get_system_info():
    """Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…"""
    return {
        "name": SYSTEM_NAME,
        "version": SYSTEM_VERSION,
        "description": SYSTEM_DESCRIPTION,
        "modules": len(AVAILABLE_MODULES),
        "status": "running",
        "timestamp": datetime.now().isoformat()
    }


@app.get("/login", response_class=HTMLResponse)
async def login_page(username: str = "", password: str = ""):
    """Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù†Ø¸Ø§Ù…"""
    username_value = username or 'admin'
    password_value = password or 'admin123'

    html = f"""
    <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - {SYSTEM_NAME}</title>
        <style>
            * {{ margin: 0; padding: 0; box-sizing: border-box; }}
            body {{
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
            }}
            .login-container {{
                background: rgba(255, 255, 255, 0.1);
                padding: 3rem;
                border-radius: 20px;
                backdrop-filter: blur(10px);
                box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
                border: 1px solid rgba(255, 255, 255, 0.18);
                max-width: 400px;
                width: 90%;
                text-align: center;
            }}
            h1 {{
                font-size: 2rem;
                margin-bottom: 1rem;
                color: #fff;
            }}
            .form-group {{
                margin: 1.5rem 0;
                text-align: right;
            }}
            label {{
                display: block;
                margin-bottom: 0.5rem;
                font-weight: 500;
            }}
            input {{
                width: 100%;
                padding: 0.8rem;
                border: none;
                border-radius: 10px;
                background: rgba(255, 255, 255, 0.2);
                color: white;
                font-size: 1rem;
            }}
            input::placeholder {{
                color: rgba(255, 255, 255, 0.7);
            }}
            .btn {{
                background: #4CAF50;
                color: white;
                border: none;
                padding: 1rem 2rem;
                border-radius: 25px;
                cursor: pointer;
                font-size: 1rem;
                width: 100%;
                transition: all 0.3s;
                margin: 1rem 0;
            }}
            .btn:hover {{
                background: #45a049;
                transform: translateY(-2px);
            }}
            .admin-info {{
                background: rgba(255, 255, 255, 0.1);
                padding: 1.5rem;
                border-radius: 10px;
                margin: 1.5rem 0;
                border: 1px solid rgba(255, 255, 255, 0.2);
                text-align: center;
            }}
            .admin-info h4 {{
                color: #4CAF50;
                margin-bottom: 1rem;
                font-size: 1.1rem;
            }}
            .admin-info p {{
                margin: 0.5rem 0;
                font-size: 1rem;
            }}
            .footer {{
                margin-top: 2rem;
                opacity: 0.8;
                font-size: 0.9rem;
            }}
        </style>
    </head>
    <body>
        <div class="login-container">
            <h1>ğŸŒ± {SYSTEM_NAME}</h1>
            <p>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…</p>

            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label>
                    <input type="text" id="username" name="username" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" value="{username_value}" required>
                </div>
                <div class="form-group">
                    <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
                    <input type="password" id="password" name="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" value="{password_value}" required>
                </div>
                <button type="submit" class="btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </form>

            <div class="admin-info">
                <h4>ğŸ”‘ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ù…Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©:</h4>
                <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> admin</p>
                <p><strong>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</strong> admin123</p>
                <small>ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</small>
            </div>

            <div class="footer">
                <p>Ø§Ù„Ø¥ØµØ¯Ø§Ø± {SYSTEM_VERSION} | {SYSTEM_NAME}</p>
            </div>
        </div>

        <script>
            function handleLogin(event) {{
                event.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                if (username === 'admin' && password === 'admin123') {{
                    localStorage.setItem('user', JSON.stringify({{
                        username: username,
                        role: 'admin',
                        loginTime: new Date().toISOString()
                    }}));
                    window.location.href = '/admin';
                }} else {{
                    alert('âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!\\n\\nØ§Ø³ØªØ®Ø¯Ù…:\\nØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: admin\\nÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: admin123');
                }}
            }}
        </script>
    </body>
    </html>
    """
    return html


@app.post("/api/login")
async def api_login(username: str, password: str):
    """API Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"""
    if username == "admin" and password == "admin123":
        return {
            "success": True,
            "message": "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­",
            "user": {
                "username": username,
                "role": "admin",
                "loginTime": datetime.now().isoformat()
            },
            "redirect": "/admin"
        }
    else:
        return {
            "success": False,
            "message": "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©"
        }


@app.get("/admin")
async def admin_redirect():
    """Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©"""
    return RedirectResponse(url="/admin/", status_code=302)


# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ„Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚


@app.on_event("startup")
async def startup_event():
    """Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"""
    logger.info(f"Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ {SYSTEM_NAME} Ø§Ù„Ø¥ØµØ¯Ø§Ø± {SYSTEM_VERSION}")

    # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ„Ø§Øª
    if load_modules():
        logger.info("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­")
    else:
        logger.warning("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ„Ø§Øª")


if __name__ == "__main__":
    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
    uvicorn.run(
        "main_clean:app",
        host="0.0.0.0",
        port=8000,
        reload=True,
        log_level="info"
    )
