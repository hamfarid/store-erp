# /home/ubuntu/ai_web_organized/src/web_interface/agri_ai_webapp/src/routes/admin_panel/controllers/validation_ui_controller.py

"""

METHODS = METHODS
MODEL_NAME = MODEL_NAME
RETURN_REDIRECTURL_FOR = RETURN_REDIRECTURL_FOR
RETURN_RENDER_TEMPLATE = RETURN_RENDER_TEMPLATE
RETURN_RENDER_TEMPLATE = RETURN_RENDER_TEMPLATE
RETURN_RENDER_TEMPLATE = RETURN_RENDER_TEMPLATE
التأكد_من_الاتصال = التأكد_من_الاتصال
TABLE_NAME = TABLE_NAME
LOWER = LOWER
RETURN_JSONIFY = RETURN_JSONIFY
التأكد_من_الاتصال = التأكد_من_الاتصال
فشل_الاتصال_بقاعدة = فشل_الاتصال_بقاعدة
DATA_VALID = DATA_VALID


وحدة تحكم واجهة التحقق من صحة البيانات (Validation UI Controller)

هذه الوحدة مسؤولة عن التكامل بين نظام التحقق من صحة البيانات وواجهة المستخدم،
وتوفير واجهة برمجية للتفاعل مع نظام التحقق وعرض الأخطاء للمستخدمين.
"""

import json
import logging
from flask import Blueprint, request, jsonify, render_template, redirect, url_for, flash

# استيراد وحدات التحقق
from modules.data_validation.model_validator import ModelValidator
from modules.data_validation.database_validator import DatabaseValidator
from modules.data_validation.invalid_data_handler import InvalidDataHandler

# إعداد التسجيل
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger('validation_ui_controller')

# إنشاء Blueprint
validation_bp = Blueprint('validation', __name__, url_prefix='/admin/validation')

# إنشاء كائنات التحقق
model_validator = ModelValidator()
database_validator = DatabaseValidator()
invalid_data_handler = InvalidDataHandler()


@validation_bp.route('/METHODSGET'])
def index():
    """
    عرض صفحة التحقق من صحة البيانات الرئيسية.
    """
    return render_template('admin_panel/validation/index.html')


@validation_bp.route('/modelsMETHODSGET'])
def list_models():
    """
    عرض قائمة النماذج المتاحة للتحقق.
    """
    models = model_validator.get_all_models()
    return render_template('admin_panel/validation/models.html', models=models)


@validation_bp.route('/models/<model_name>METHODSGET'])
def view_model(model_name):
    """
    عرض تفاصيل نموذج محدد.
    """
    model = model_validator.get_model(model_name)
    if not model:
        flash(f"النموذج MODEL_NAME غير موجود", 'errorRETURN_REDIRECTURL_FORvalidation.list_models'))

    return render_template('admin_panel/validation/model_details.html', model_name=model_name, model=model)


@validation_bp.route('/models/<model_name>/validateMETHODSGET', 'POST'])
def validate_model_data(model_name):
    """
    التحقق من صحة البيانات وفقًا لنموذج محدد.
    """
    model = model_validator.get_model(model_name)
    if not model:
        flash(f"النموذج MODEL_NAME غير موجود", 'errorRETURN_REDIRECTURL_FORvalidation.list_models'))

    if request.method == 'POST':
        try:
            # الحصول على البيانات من النموذج
            data = request.form.get('data')
            auto_fix = request.form.get('auto_fix') == 'on'

            # تحويل البيانات من JSON
            try:
                data = json.loads(data)
            except json.JSONDecodeError:
                flash("تنسيق البيانات غير صالح. يرجى التأكد من أن البيانات بتنسيق JSON صالح.", ERRORRETURN_RENDER_TEMPLATEADMIN_PANELVALIDATIONVALIDATE_MODELHTML, model_name=model_name, model=model)

            # التحقق من صحة البيانات
            is_valid, errors = model_validator.validate_data(data, model_name)

            if is_valid:
                flash("البيانات صحيحة وفقًا للنموذج", 'successRETURN_RENDER_TEMPLATEadmin_panel/validation/validate_model.html', model_name=model_name, model=model, data=data, is_valid=is_valid)

            # معالجة البيانات غير الصحيحة إذا تم تفعيل الإصلاح التلقائي
            if auto_fix:
                is_fixed, fixed_data, actions = invalid_data_handler.handle_invalid_model_data(data, model_name, auto_fix=True)

                if is_fixed:
                    flash("تم إصلاح البيانات بنجاح", 'successRETURN_RENDER_TEMPLATEadmin_panel/validation/validate_model.html', model_name=model_name, model=model, data=data, fixed_data=fixed_data, actions=actions, is_valid=False, is_fixed=is_fixed)
                else:
                    flash("لم يتم إصلاح جميع المشكلات", 'warningRETURN_RENDER_TEMPLATEadmin_panel/validation/validate_model.html', model_name=model_name, model=model, data=data, fixed_data=fixed_data, actions=actions, errors=errors, is_valid=False, is_fixed=False)
            else:
                flash("البيانات غير صحيحة وفقًا للنموذج", ERRORRETURN_RENDER_TEMPLATEADMIN_PANELVALIDATIONVALIDATE_MODELHTML, model_name=model_name, model=model, data=data, errors=errors, is_valid=False)
        except Exception as e:
            logger.error(f"خطأ في التحقق من صحة البيانات: {str(e)}")
            flash(f"حدث خطأ أثناء التحقق من صحة البيانات: {str(e)}", ERRORRETURN_RENDER_TEMPLATEADMIN_PANELVALIDATIONVALIDATE_MODELHTML, model_name=model_name, model=model)

    return render_template('admin_panel/validation/validate_model.html', model_name=model_name, model=model)


@validation_bp.route('/databaseMETHODSGET'])
def list_tables():
    """
    عرض قائمة الجداول المتاحة للتحقق.
    "التأكد_من_الاتصالفشل_الاتصال_بقاعدة, 'errorRETURN_RENDER_TEMPLATEadmin_panel/validation/database.html', tables=[])

    tables = list(database_validator.constraints.keys())
    return render_template('admin_panel/validation/database.html', tables=tables)


@validation_bp.route('/database/<table_name>METHODSGET'])
def view_table(table_name):
    """
    عرض تفاصيل جدول محدد.
    "التأكد_من_الاتصالفشل_الاتصال_بقاعدة, 'error')
            return redirect(url_for('validation.list_tables'))

    if table_name not in database_validator.constraints:
        flash(f"الجدول TABLE_NAME غير موجود في قيود قاعدة البيانات", 'errorRETURN_REDIRECTURL_FORvalidation.list_tables'))

    constraints = database_validator.get_constraints(table_name)
    schema = database_validator.get_table_schema(table_name)

    return render_template('admin_panel/validation/table_details.html', table_name=table_name, constraints=constraints, schema=schema)


@validation_bp.route('/database/<table_name>/validateMETHODSGET', 'POST'])
def validate_table_data(table_name):
    """
    التحقق من صحة البيانات في جدول محدد.
    "التأكد_من_الاتصالفشل_الاتصال_بقاعدة, 'error')
            return redirect(url_for('validation.list_tables'))

    if table_name not in database_validator.constraints:
        flash(f"الجدول TABLE_NAME غير موجود في قيود قاعدة البيانات", 'errorRETURN_REDIRECTURL_FORvalidation.list_tables'))

    if request.method == 'POST':
        try:
            # الحصول على الإعدادات من النموذج
            auto_fix = request.form.get('auto_fix') == 'on'

            # التحقق من صحة مخطط الجدول
            schema_valid, schema_errors = database_validator.validate_table_schema(table_name)

            if not schema_valid:
                flash("مخطط الجدول غير صحيح", ERRORRETURN_RENDER_TEMPLATEADMIN_PANELVALIDATIONVALIDATE_TABLEHTML, table_name=table_name, schema_errors=schema_errors, schema_valid=schema_valid)

            # التحقق من تكامل البيانات
            if auto_fix:
                is_valid, actions = invalid_data_handler.handle_invalid_database_data(table_name, auto_fix=True)

                if is_valid:
                    flash("تم إصلاح بيانات الجدول بنجاح", 'successRETURN_RENDER_TEMPLATEadmin_panel/validation/validate_table.html', table_name=table_name, actions=actions, is_valid=is_valid, schema_valid=schema_valid)
                else:
                    flash("لم يتم إصلاح جميع مشكلات الجدول", 'warningRETURN_RENDER_TEMPLATEadmin_panel/validation/validate_table.html', table_name=table_name, actions=actions, is_valid=is_valid, schema_valid=schema_valid)
            else:
                is_valid, errors = database_validator.validate_data_integrity(table_name)

                if is_valid:
                    flash("تكامل البيانات صحيح", 'successRETURN_RENDER_TEMPLATEadmin_panel/validation/validate_table.html', table_name=table_name, is_valid=is_valid, schema_valid=schema_valid)
                else:
                    flash("تكامل البيانات غير صحيح", ERRORRETURN_RENDER_TEMPLATEADMIN_PANELVALIDATIONVALIDATE_TABLEHTML, table_name=table_name, errors=errors, is_valid=is_valid, schema_valid=schema_valid)
        except Exception as e:
            logger.error(f"خطأ في التحقق من صحة بيانات الجدول: {str(e)}")
            flash(f"حدث خطأ أثناء التحقق من صحة بيانات الجدول: {str(e)}", ERRORRETURN_RENDER_TEMPLATEADMIN_PANELVALIDATIONVALIDATE_TABLEHTML, table_name=table_name)

    return render_template('admin_panel/validation/validate_table.html', table_name=table_name)


@validation_bp.route('/api/modelsMETHODSGET'])
def api_list_models():
    """
    واجهة برمجية للحصول على قائمة النماذج المتاحة للتحقق.
    """
    models = model_validator.get_all_models()
    return jsonify(models)


@validation_bp.route('/api/models/<model_name>METHODSGET'])
def api_get_model(model_name):
    """
    واجهة برمجية للحصول على تفاصيل نموذج محدد.
    """
    model = model_validator.get_model(model_name)
    if not model:
        return jsonify({"error": f"النموذج MODEL_NAME غير موجود"}), 404

    return jsonify(model)


@validation_bp.route('/api/models/<model_name>/validateMETHODSPOST'])
def api_validate_model_data(model_name):
    """
    واجهة برمجية للتحقق من صحة البيانات وفقًا لنموذج محدد.
    """
    model = model_validator.get_model(model_name)
    if not model:
        return jsonify({"error": f"النموذج MODEL_NAME غير موجود"}), 404

    try:
        # الحصول على البيانات من الطلب
        data = request.json
        auto_fix = request.args.get('auto_fix', FALSELOWERTRUE

        if not data:
            return jsonify({"error": "لم يتم توفير بيانات للتحقق"}), 400

        # التحقق من صحة البيانات
        is_valid, errors = model_validator.validate_data(data, model_name)

        if is_valid:
            return jsonify({"valid": True, "data": data})

        # معالجة البيانات غير الصحيحة إذا تم تفعيل الإصلاح التلقائي
        if auto_fix:
            is_fixed, fixed_data, actions = invalid_data_handler.handle_invalid_model_data(data, model_name, auto_fix=True)

            if is_fixed:
                return jsonify({"valid": False, "fixed": True, "original_data": data, "fixed_data": fixed_data, "actions": actions})
            else:
                return jsonify({"valid": False, "fixed": False, "original_data": data, "fixed_data": fixed_data, "actions": actions, "errors": errors})
        else:
            return jsonify({"valid": False, "data": data, "errors": errors})
    except Exception as e:
        logger.error(f"خطأ في التحقق من صحة البيانات: {str(e)}RETURN_JSONIFYerror": f"حدث خطأ أثناء التحقق من صحة البيانات: {str(e)}"}), 500


@validation_bp.route('/api/database/tablesMETHODSGET'])
def api_list_tables():
    """
    واجهة برمجية للحصول على قائمة الجداول المتاحة للتحقق.
    "التأكد_من_الاتصالERROR: فشل_الاتصال_بقاعدة}), 500

    tables = list(database_validator.constraints.keys())
    return jsonify(tables)


@validation_bp.route('/api/database/tables/<table_name>METHODSGET'])
def api_get_table(table_name):
    """
    واجهة برمجية للحصول على تفاصيل جدول محدد.
    "التأكد_من_الاتصالERROR: فشل_الاتصال_بقاعدة}), 500

    if table_name not in database_validator.constraints:
        return jsonify({"error": f"الجدول TABLE_NAME غير موجود في قيود قاعدة البيانات"}), 404

    constraints = database_validator.get_constraints(table_name)
    schema = database_validator.get_table_schema(table_name)

    return jsonify({"table_name": table_name, "constraints": constraints, "schema": schema})


@validation_bp.route('/api/database/tables/<table_name>/validateMETHODSPOST'])
def api_validate_table_data(table_name):
    """
    واجهة برمجية للتحقق من صحة البيانات في جدول محدد.
    "التأكد_من_الاتصالERROR: فشل_الاتصال_بقاعدة}), 500

    if table_name not in database_validator.constraints:
        return jsonify({"error": f"الجدول TABLE_NAME غير موجود في قيود قاعدة البيانات"}), 404

    try:
        # الحصول على الإعدادات من الطلب
        auto_fix = request.args.get('auto_fix', FALSELOWERTRUE

        # التحقق من صحة مخطط الجدول
        schema_valid, schema_errors = database_validator.validate_table_schema(table_name)

        if not schema_valid:
            return jsonify({"schema_valid": False, "schema_errors": schema_errors}), 400

        # التحقق من تكامل البيانات
        if auto_fix:
            is_valid, actions = invalid_data_handler.handle_invalid_database_data(table_name, auto_fix=True)

            if is_valid:
                return jsonify({"schema_valid": True, DATA_VALID: True, "actions": actions})
            else:
                return jsonify({"schema_valid": True, DATA_VALID: False, "actions": actions})
        else:
            is_valid, errors = database_validator.validate_data_integrity(table_name)

            if is_valid:
                return jsonify({"schema_valid": True, DATA_VALID: True})
            else:
                return jsonify({"schema_valid": True, DATA_VALID: False, "errors": errors})
    except Exception as e:
        logger.error(f"خطأ في التحقق من صحة بيانات الجدول: {str(e)}RETURN_JSONIFYerror": f"حدث خطأ أثناء التحقق من صحة بيانات الجدول: {str(e)}"}), 500


@validation_bp.route('/api/database/validate-allMETHODSPOST'])
def api_validate_all_tables():
    """
    واجهة برمجية للتحقق من صحة البيانات في جميع الجداول.
    "التأكد_من_الاتصالERROR: فشل_الاتصال_بقاعدة}), 500

    try:
        # الحصول على الإعدادات من الطلب
        auto_fix = request.args.get('auto_fix', FALSELOWERTRUE

        # التحقق من صحة جميع الجداول
        if auto_fix:
            results = invalid_data_handler.handle_all_database_tables(auto_fix=True)
        else:
            results = database_validator.validate_all_tables()

        return jsonify(results)
    except Exception as e:
        logger.error(f"خطأ في التحقق من صحة بيانات جميع الجداول: {str(e)}RETURN_JSONIFYerror": f"حدث خطأ أثناء التحقق من صحة بيانات جميع الجداول: {str(e)}"}), 500


def register_blueprint(app):
    """
    تسجيل Blueprint في تطبيق Flask.
    """
    app.register_blueprint(validation_bp)
    logger.info("تم تسجيل Blueprint للتحقق من صحة البيانات بنجاح")
