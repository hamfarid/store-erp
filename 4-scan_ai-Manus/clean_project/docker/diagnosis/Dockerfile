# File: /home/ubuntu/clean_project/docker/diagnosis/Dockerfile
# Dockerfile Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙØ­Øµ ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ù†ÙØµÙ„Ø©
# Ù…ØªØ®ØµØµØ© ÙÙŠ ØªØ´Ø®ÙŠØµ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù†Ø¨Ø§ØªÙŠØ© ÙˆØ§Ù„ÙØ­Øµ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…

FROM python:3.11-slim as diagnosis-base

# ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ
RUN apt-get update && apt-get install -y \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    libgcc-s1 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root
RUN groupadd -r diagnosis && useradd -r -g diagnosis -d /app -s /bin/bash diagnosis

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯Ù„Ø§Ø¦Ù„
RUN mkdir -p /app /app/models /app/data /app/logs && \
    chown -R diagnosis:diagnosis /app

WORKDIR /app

# Ù†Ø³Ø® Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ
COPY docker/diagnosis/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„ØªØ´Ø®ÙŠØµ
COPY --chown=diagnosis:diagnosis src/modules/disease_diagnosis/ ./diagnosis/
COPY --chown=diagnosis:diagnosis src/modules/plant_disease/ ./plant_disease/
COPY --chown=diagnosis:diagnosis src/advanced_ai_system.py ./
COPY --chown=diagnosis:diagnosis src/adaptive_learning_system.py ./

# Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„ØªØ´ØºÙŠÙ„
RUN cat > /app/start_diagnosis.sh << 'EOF'
#!/bin/bash
set -e

echo "ðŸ”¬ Ø¨Ø¯Ø¡ Ø®Ø¯Ù…Ø© Ø§Ù„ÙØ­Øµ ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ..."

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
python -c "
import torch
import torchvision.models as models
print('ØªØ­Ù…ÙŠÙ„ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...')
model = models.resnet50(pretrained=True)
torch.save(model.state_dict(), '/app/models/resnet50.pth')
print('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø¨Ù†Ø¬Ø§Ø­')
"

# Ø¨Ø¯Ø¡ Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ
exec uvicorn diagnosis.api:app --host 0.0.0.0 --port 8001
EOF

RUN chmod +x /app/start_diagnosis.sh && chown diagnosis:diagnosis /app/start_diagnosis.sh

# Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root
USER diagnosis

# ØªØ¹Ø±ÙŠØ¶ Ø§Ù„Ù…Ù†ÙØ°
EXPOSE 8001

# Ø¥Ø¹Ø¯Ø§Ø¯ health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8001/health || exit 1

ENTRYPOINT ["/app/start_diagnosis.sh"]

