# =============================================================================
# Deployment Pipeline
# =============================================================================
# 
# PURPOSE: Build, push, and deploy Docker images to staging/production
# TRIGGERS: Push to main, version tags, manual workflow dispatch
# 
# Jobs:
# - build-and-push: Build and push Docker images to GitHub Container Registry
# - deploy-staging: Deploy to staging environment
# - deploy-production: Deploy to production environment (requires approval)
# - health-check: Verify deployment health
# - notify: Send deployment notifications
#
# Author: Global System v35.0
# Date: 2026-01-19
# =============================================================================

name: Deploy Pipeline

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip tests before deployment'
        required: false
        default: false
        type: boolean

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ============================================
  # Pre-deployment Checks
  # ============================================
  pre-checks:
    name: ðŸ” Pre-deployment Checks
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev-${{ github.sha }}")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          
      - name: Verify CI passed
        uses: actions/github-script@v7
        with:
          script: |
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
            });
            
            const ciRun = checks.check_runs.find(r => r.name === 'CI Pipeline');
            if (ciRun && ciRun.conclusion !== 'success') {
              core.setFailed('CI Pipeline must pass before deployment');
            }

  # ============================================
  # Build and Push Docker Images
  # ============================================
  build-and-push:
    name: ðŸ³ Build and Push Images
    runs-on: ubuntu-latest
    needs: [pre-checks]
    if: always() && (needs.pre-checks.result == 'success' || inputs.skip_tests)
    
    permissions:
      contents: read
      packages: write
      
    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      backend-digest: ${{ steps.build-backend.outputs.digest }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}
      frontend-digest: ${{ steps.build-frontend.outputs.digest }}
      ml-service-image: ${{ steps.meta-ml.outputs.tags }}
      ml-digest: ${{ steps.build-ml.outputs.digest }}
      ai-service-image: ${{ steps.meta-ai.outputs.tags }}
      ai-digest: ${{ steps.build-ai.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ---- Backend ----
      - name: Extract metadata (Backend)
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-

      - name: Build and push Backend
        id: build-backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ needs.pre-checks.outputs.version || 'dev' }}

      # ---- Frontend ----
      - name: Extract metadata (Frontend)
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix=sha-

      - name: Build and push Frontend
        id: build-frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VITE_API_URL=${{ vars.API_URL || 'http://localhost:4001/api/v1' }}

      # ---- ML Service ----
      - name: Extract metadata (ML Service)
        id: meta-ml
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/ml-service
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix=sha-

      - name: Build and push ML Service
        id: build-ml
        uses: docker/build-push-action@v5
        with:
          context: ./ml_service
          file: ./ml_service/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta-ml.outputs.tags }}
          labels: ${{ steps.meta-ml.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ---- AI Service (Image Crawler) ----
      - name: Extract metadata (AI Service)
        id: meta-ai
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/ai-service
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=sha,prefix=sha-

      - name: Build and push AI Service
        id: build-ai
        uses: docker/build-push-action@v5
        with:
          context: ./image_crawler
          file: ./image_crawler/Dockerfile
          platforms: linux/amd64
          push: true
          tags: ${{ steps.meta-ai.outputs.tags }}
          labels: ${{ steps.meta-ai.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Deploy to Staging
  # ============================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    
    environment:
      name: staging
      url: https://staging.gaara-scan-ai.com
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}
          
      - name: Deploy to Staging Server
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          BACKEND_IMAGE: ${{ needs.build-and-push.outputs.backend-image }}
          FRONTEND_IMAGE: ${{ needs.build-and-push.outputs.frontend-image }}
          ML_IMAGE: ${{ needs.build-and-push.outputs.ml-service-image }}
          AI_IMAGE: ${{ needs.build-and-push.outputs.ai-service-image }}
        run: |
          # Create deployment script
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          cd /opt/gaara-scan-ai
          
          # Pull latest images
          docker compose pull
          
          # Update with zero downtime
          docker compose up -d --remove-orphans
          
          # Wait for services to be healthy
          sleep 30
          
          # Run database migrations
          docker compose exec -T backend alembic upgrade head || true
          
          # Cleanup old images
          docker image prune -af --filter "until=24h"
          
          echo "Deployment completed successfully!"
          EOF
          
          # Copy and execute on staging server
          scp -o StrictHostKeyChecking=no deploy.sh ${STAGING_USER}@${STAGING_HOST}:/tmp/
          ssh -o StrictHostKeyChecking=no ${STAGING_USER}@${STAGING_HOST} "chmod +x /tmp/deploy.sh && /tmp/deploy.sh"

      - name: Verify Staging Deployment
        run: |
          sleep 10
          curl -sf https://staging.gaara-scan-ai.com/api/v1/health || echo "Health check will be verified in next job"

  # ============================================
  # Deploy to Production
  # ============================================
  deploy-production:
    name: ðŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-staging]
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production'
    
    environment:
      name: production
      url: https://gaara-scan-ai.com
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}

      - name: Create Database Backup
        env:
          PROD_HOST: ${{ secrets.PRODUCTION_HOST }}
          PROD_USER: ${{ secrets.PRODUCTION_USER }}
        run: |
          ssh -o StrictHostKeyChecking=no ${PROD_USER}@${PROD_HOST} << 'EOF'
          cd /opt/gaara-scan-ai
          
          # Create backup
          BACKUP_NAME="backup_$(date +%Y%m%d_%H%M%S)"
          docker compose exec -T database pg_dump -U gaara_user gaara_scan_ai > /backups/${BACKUP_NAME}.sql
          
          # Keep only last 7 backups
          ls -t /backups/*.sql | tail -n +8 | xargs -r rm
          
          echo "Backup created: ${BACKUP_NAME}"
          EOF

      - name: Deploy to Production Server
        env:
          PROD_HOST: ${{ secrets.PRODUCTION_HOST }}
          PROD_USER: ${{ secrets.PRODUCTION_USER }}
          BACKEND_IMAGE: ${{ needs.build-and-push.outputs.backend-image }}
          FRONTEND_IMAGE: ${{ needs.build-and-push.outputs.frontend-image }}
          ML_IMAGE: ${{ needs.build-and-push.outputs.ml-service-image }}
          AI_IMAGE: ${{ needs.build-and-push.outputs.ai-service-image }}
        run: |
          cat > deploy-prod.sh << 'EOF'
          #!/bin/bash
          set -e
          
          cd /opt/gaara-scan-ai
          
          # Enable maintenance mode
          touch /var/www/maintenance.flag
          
          # Pull latest images
          docker compose pull
          
          # Rolling update (one service at a time)
          docker compose up -d --no-deps backend
          sleep 20
          
          docker compose up -d --no-deps ml_service
          sleep 20
          
          docker compose up -d --no-deps ai_service
          sleep 10
          
          docker compose up -d --no-deps frontend
          sleep 10
          
          # Run migrations
          docker compose exec -T backend alembic upgrade head
          
          # Disable maintenance mode
          rm -f /var/www/maintenance.flag
          
          # Cleanup
          docker image prune -af --filter "until=48h"
          
          echo "Production deployment completed!"
          EOF
          
          scp -o StrictHostKeyChecking=no deploy-prod.sh ${PROD_USER}@${PROD_HOST}:/tmp/
          ssh -o StrictHostKeyChecking=no ${PROD_USER}@${PROD_HOST} "chmod +x /tmp/deploy-prod.sh && /tmp/deploy-prod.sh"

  # ============================================
  # Health Check
  # ============================================
  health-check:
    name: ðŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    
    steps:
      - name: Check Staging Health
        if: needs.deploy-staging.result == 'success'
        run: |
          for i in {1..5}; do
            if curl -sf https://staging.gaara-scan-ai.com/api/v1/health; then
              echo "Staging is healthy!"
              exit 0
            fi
            sleep 10
          done
          echo "Staging health check failed"
          exit 1
          
      - name: Check Production Health
        if: needs.deploy-production.result == 'success'
        run: |
          for i in {1..5}; do
            if curl -sf https://gaara-scan-ai.com/api/v1/health; then
              echo "Production is healthy!"
              exit 0
            fi
            sleep 10
          done
          echo "Production health check failed"
          exit 1

  # ============================================
  # Notify
  # ============================================
  notify:
    name: ðŸ“¢ Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production, health-check]
    if: always()
    
    steps:
      - name: Send Slack Notification
        if: vars.SLACK_WEBHOOK_URL
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "Deployment Status",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš€ Gaara Scan AI Deployment"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Staging:* ${{ needs.deploy-staging.result || 'skipped' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Production:* ${{ needs.deploy-production.result || 'skipped' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Health Check:* ${{ needs.health-check.result }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:* `${{ github.sha }}`"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Create GitHub Deployment Status
        uses: actions/github-script@v7
        with:
          script: |
            const environment = '${{ github.event.inputs.environment }}' || 
                               (context.ref.startsWith('refs/tags/') ? 'production' : 'staging');
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.runId,
              state: '${{ needs.health-check.result }}' === 'success' ? 'success' : 'failure',
              environment_url: environment === 'production' 
                ? 'https://gaara-scan-ai.com' 
                : 'https://staging.gaara-scan-ai.com',
              description: 'Deployment completed'
            }).catch(() => {});
