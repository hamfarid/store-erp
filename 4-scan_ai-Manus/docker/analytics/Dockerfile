# File: /home/ubuntu/clean_project/docker/analytics/Dockerfile
# Dockerfile Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶Ø®Ù…Ø©
# Ù…ØªØ®ØµØµØ© ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠØ© ÙˆØ§Ù„ØªÙ†Ø¨Ø¤Ø§Øª

FROM python:3.11-slim as analytics-base

# ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PYTHONPATH=/app

# ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    libgomp1 \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root
RUN groupadd -r analytics && useradd -r -g analytics -d /app -s /bin/bash analytics

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯Ù„Ø§Ø¦Ù„
RUN mkdir -p /app /app/data /app/reports /app/logs && \
    chown -R analytics:analytics /app

WORKDIR /app

# Ù†Ø³Ø® Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
COPY docker/analytics/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Ù†Ø³Ø® ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
COPY --chown=analytics:analytics src/advanced_analytics_system.py ./
COPY --chown=analytics:analytics src/big_data_analytics_system.py ./
COPY --chown=analytics:analytics src/modules/analytics/ ./analytics/

# Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„ØªØ´ØºÙŠÙ„
RUN cat > /app/start_analytics.sh << 'EOF'
#!/bin/bash
set -e

echo "ðŸ“Š Ø¨Ø¯Ø¡ Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶Ø®Ù…Ø©..."

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
python -c "
import pandas as pd
import numpy as np
print('Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©...')
# Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„ØªØ­Ù„ÙŠÙ„
data = pd.DataFrame({
    'date': pd.date_range('2023-01-01', periods=365),
    'temperature': np.random.normal(25, 5, 365),
    'humidity': np.random.normal(60, 10, 365),
    'crop_yield': np.random.normal(100, 20, 365)
})
data.to_csv('/app/data/sample_data.csv', index=False)
print('ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­')
"

# Ø¨Ø¯Ø¡ Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
exec uvicorn analytics.api:app --host 0.0.0.0 --port 8002
EOF

RUN chmod +x /app/start_analytics.sh && chown analytics:analytics /app/start_analytics.sh

# Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± root
USER analytics

# ØªØ¹Ø±ÙŠØ¶ Ø§Ù„Ù…Ù†ÙØ°
EXPOSE 8002

# Ø¥Ø¹Ø¯Ø§Ø¯ health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:8002/health || exit 1

ENTRYPOINT ["/app/start_analytics.sh"]

